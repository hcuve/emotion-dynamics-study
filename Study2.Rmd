---
title: "Study2"
author: '@H Cuve'
date: "16/07/2020"
output: html_document
---


load("D:/OneDrive - Nexus365/Face Morph Paper/Data/Study2_plots.RData"

# there is chaos and there there is my organisation method

```{r}
colnames(db_ASC_NT)
db_ASC_NT$Participant<- db_ASC_NT$ParticipantPrivateID

study2<- db_ASC_NT%>%
  subset(Group == "NT")%>%
  select(c(90,24,3:10,15,33,37, stim_id, Actor_ID))
saveRDS(study2, "study2.rds")
write_csv(study2, "study2.csv")
```

"remove some unnecessary duplicates


```{r eval=FALSE, include=FALSE}
rm(a_valence, a_valence1, acc_from_stimdiff, w,x,z,timebin_ADFES_avg_Anger, timebin_avg_Anger, timebin_avg_Disgust, timebin_avg_Fear, timebin_avg_Joy, timebin_avg_Sadness, timebin_avg_Surprise, timebin_JEFFE_avg_Anger, timebinout_avg_JEFFE, timebinout_avg_ADFES, timebin_shuff_Surprise, timebin_shuff_Sadness, timebin_shuff_JEFFE_Surprise, timebin_shuff_JEFFE_Joy, timebin_JEFFE_avg_Fear)

rm(timebin_random, timebin_random_ADFES, timebin_JEFFE_avg_Disgust, timebin_JEFFE_avg_Joy, timebin_JEFFE_avg_Surprise)
rm(timebin_JEFFE_avg_Sadness, timebin_random_JEFFE, timebin_shuff,timebin_shuff_Anger)

rm(timebin_shuff_ADFES, timebin_shuff_ADFES_Anger, timebin_shuff_Disgust, timebin_shuff_Fear, timebin_shuff_JEFFE, timebin_shuff_JEFFE_Anger, timebin_shuff_JEFFE_Anger)

rm(timebin_shuff_JEFFE_Disgust, timebin_shuff_JEFFE_Fear, timebin_shuff_JEFFE_Sadness, timebin_shuff_Joy)

rm(timestamp_ADFES, timestamp_ADFES_Anger, timestamp_ADFES_avg_Disgust, timestamp_ADFES_avg_Fear)

rm(whatsthisna, y, v1.1, v1, v1.2, testtemp, testpoly, test.data, test.data_avgface, test.data_avgface_96, test.data_avgface_ADFES, test.data_by_ADFES_avg_Anger)
rm(test.data1, test.data_by_ADFES_avg_Disgust, test.data_by_ADFES_avg_Fear, test.data_by_ADFES_avg_Surprise, testresults_ADFES_Fear, test.data_bySadness, test.data_byJEFFESurprise, test.data_byJEFFEJoy)
rm(test.data_avgface_jeffe)
rm(test_dcast, sum_cluster_sim, sum_cluster_sim_ADFES, sum_cluster_sim_final, sum_cluster_sim_JEFFE, sum_cluster_sim1)

rm(simularions, simulattion_vs_data, simulated_clusters_ADFES)
rm(simulattion_vs_data_ADFES, simulattion_vs_data_ADFES, simulattion_vs_data_JEFFE_test)
rm(simulattion_vs_data_JEFFE)

rm(simulated_clusters_current, simulated_clusters, simulated_clusters_ADFES_Anger, simulated_clusters_current, simulated_clusterstest_2, simulations)


rm(simulated_clusters_Anger, simulated_clusters_Disgust, simulated_clusters_Fear, simulated_clusters_JEFFE, simulated_clusterstest, simulated_clusters_JEFFE_Sadness)
rm(lmer_bin_random, lmer_bin_random_ADFES, lmer_bin_random_ADFES_Anger, lmer_bin_random_Disgust, lmer_bin_random_Disgust, lmer_bin_random_JEFFE_Anger, lmer_bin_random_summary)


rm(db_aus, db_of, db_of1, db_of4, db_of5, db_of5_new)

rm(db_of2, db_of5_coorrelations, db_of6, db_of6_new)

rm(db_of7_new_paper)
rm(db_of7_new_tomerge,db_of7_new_tomerge1, fuckup)

rm(timestamp_ADFES_avg_Anger, timestamp_ADFES_avg_Joy, timestamp_ADFES_avg_Sadness, timestamp_ADFES_avg_Surprise, timestamp_ADFES_Disgust, timestamp_ADFES_Fear, timestamp_ADFES_avg_Surprise, timestamp_ADFES_Surprise, timestamp_JEFFE_Surprise)

rm(timebinout, timebinout_avg, timestamp_ADFES_Joy, timestamp_JEFFE_Sadness, timestamp_avg_Disgust, timestamp_avg_Joy, timestamp_avg_Sadness, timestamp_JEFFE_Anger, timestamp_JEFFE_avg_Surprise)
rm(simulated_clusters_JEFFE_Anger, simulated_clusters_JEFFE_Disgust, simulated_clusters_JEFFE_Joy, simulated_clusters_JEFFE_Surprise, summarytest, summarytest_avg, summarytest_avg_ADFES, summarytest_avg_JEFFE)
rm(simulated_clusters_JEFFE_Fear, simulated_clusters_Joy, simulated_clusters_Sadness, simulated_clusters_Surprise)
rm(test.data_by_ADFES_avg_Joy, test.data_by_ADFES_avg_Sadness, test.data_by_avg_Anger, test.data_by_avg_Disgust, test.data_by_avg_Fear, test.data_by_avg_Fear, test.data_by_avg_Joy, test.data_by_avg_Sadness, test.data_by_avg_Surprise, testresults_avg_cluster_random, test.data_byADFESFear)
rm(testresults, testresults_ADFES, testresults_ADFES_Anger, testresults_ADFES_avg_Disgust, testresults_ADFES_avg_Joy)
```

Run proposed analyses

GLMMS

necessary packages
```{r}
library(afex)
library(lmerTest)
library(broom.mixed)
library(tidyverse)
library(emmeans)
library(sjmisc)
library(sjPlot) 
library(sjstats)
library(psycho)

```

# Predicting emotion ratings

lmer model on valence
```{r}
unique(db_ASC_NT$Video)
unique(substr(db_ASC_NT$Video, 1,3))

db_ASC_NT$Actor_ID<- as.factor(substr(db_ASC_NT$Video, 1,3))
unique(db_ASC_NT$Actor_ID)
str(db_ASC_NT)


db_ASC_NT$ParticipantPrivateID<- as.factor(db_ASC_NT$ParticipantPrivateID)
db_ASC_NT$Emotion<- as.factor(db_ASC_NT$Emotion)
db_ASC_NT$DATASET<- as.factor(db_ASC_NT$DATASET)
db_ASC_NT$VideoType<- as.factor(db_ASC_NT$VideoType)

# paper_analyses<- list()

paper_analyses$lmer_NT_val<- lmer(AnswerRating_Valence ~ 1 + VideoType + DATASET + Emotion+
                                    VideoType*Emotion*DATASET+(1| ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = subset(db_ASC_NT, db_ASC_NT$Group == "NT"))

paper_analyses$lmer_NT_val_analyze <- analyze (paper_analyses$lmer_NT_val, CI = 95, effsize_rules = "cohen1988")

# plot(paper_analyses$lmer_NT_val)
# qqnorm(resid(paper_analyses$lmer_NT_val))
# qqline(resid(paper_analyses$lmer_NT_val))

tab_model(paper_analyses$lmer_NT_val)

paper_analyses$lmer_NT_val_novt<- lmer(AnswerRating_Valence ~ 1 + DATASET + Emotion+
                                    Emotion*DATASET+(1| ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = subset(db_ASC_NT, db_ASC_NT$Group == "NT"))

paper_analyses$lmer_NT_val1 <- lmer(AnswerRating_Valence ~ 1 + DATASET + Emotion+
                                    VideoType*Emotion+
                                    DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+ dropped insigifiant terms
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = subset(db_ASC_NT, db_ASC_NT$Group == "NT"))



```

# control for Actor ID instead
```{r}

paper_analyses$lmer_NT_val1_actID<- lmer(AnswerRating_Valence ~ 1 + DATASET + Emotion+
                                    VideoType*DATASET*Emotion+
                                    # DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+ dropped insigifiant terms
                                    (1 | ParticipantPrivateID) + (1 | Actor_ID),
                                  REML = FALSE,
                                    data = subset(db_ASC_NT, db_ASC_NT$Group == "NT"))

anova(paper_analyses$lmer_NT_val1_actID, paper_analyses$lmer_NT_val1)
summary(paper_analyses$lmer_NT_val)
anova(paper_analyses$lmer_NT_val)
step(paper_analyses$lmer_NT_val)

std_beta(paper_analyses$lmer_NT_val)

# check if logarithmic tranformation improves residuals
paper_analyses$lmer_NT_val1_log<- lmer(log1p(AnswerRating_Valence+.1) ~ 1 + DATASET + Emotion+
                                    VideoType*Emotion+
                                    DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+ dropped insigifiant terms
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = subset(db_ASC_NT, db_ASC_NT$Group == "NT")) 

# the variance explained by actor ID is way less
# it doesn't
library(sjPlot)
library(sjmisc)
# sjmisc::
?plot_model
sjPlot::plot_model(paper_analyses$lmer_NT_val1, type = 'std')

summary(paper_analyses$lmer_NT_val)
anova(paper_analyses$lmer_NT_val)

plot(paper_analyses$lmer_NT_val1_log)
qqnorm(resid(paper_analyses$lmer_NT_val1_log))
qqline(resid(paper_analyses$lmer_NT_val1_log))

# 
plot(paper_analyses$lmer_NT_val1)
qqnorm(resid(paper_analyses$lmer_NT_val1))
qqline(resid(paper_analyses$lmer_NT_val1))


summary(paper_analyses$lmer_NT_val1)
anova(paper_analyses$lmer_NT_val1)

emmeans(paper_analyses$lmer_NT_val1, pairwise ~ VideoType*Emotion, adjust = "none")

# Only happiness turns out significant, so the anova seems a bit anti conservative?
# EMotion main contrasts
emmeans(paper_analyses$lmer_NT_val1, pairwise ~ Emotion, adjust = "bonf")
# all pairs differ except anger disgust, fear sadness, and nger sadness

# DATASET
library(emmeans)
paper_analyses$lmer_NT_val_DS<- emmeans(paper_analyses$lmer_NT_val, pairwise~ DATASET, adjust = "none")
# <- eff_size(emmeans(paper_analyses$lmer_NT_val, pairwise ~ DATASET, adjust = "none"))
paper_analyses$lmer_NT_val_DS


paper_analyses$lmer_NT_val_em<- emmeans(paper_analyses$lmer_NT_val, pairwise ~ Emotion, adjust = "none")


paper_analyses$lmer_NT_val_em<- emmeans(paper_analyses$lmer_NT_val, pairwise~ VideoType*Emotion, adjust = "none")


summary(paper_analyses$lmer_NT_val_em)
eff_size(paper_analyses$lmer_NT_val_DS, edf = paper_analyses$lmer_NT_val@vcov_varpar)
# consistent with anova


paper_analyses$lmer_NT_val$analyze_report<- analyze(paper_analyses$lmer_NT_val)
library(sjstats)
std_beta(paper_analyses$lmer_NT_val, ci.lvl = 0.95)

library(MuMIn)
r.squaredGLMM(paper_analyses$lmer_NT_val)
r.squaredGLMM(paper_analyses$lmer_NT_val_novt) #videotype makes a very small contribution
```


```{r}
dplyr::write_rds(db_ASC_NT, "db_ASC_NT.rds")
```


LMER intensity on full data


```{r}
db_ASC_NT$VideoType<- as.factor(db_ASC_NT$VideoType)
paper_analyses$lmer_NT_int2<- lmer(AnswerRating_Intensity ~ 
                                    VideoType + DATASET + Emotion+
                                    # VideoType+Emotion+
                                    # VideoType*Emotion*DATASET+ 
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = subset(db_ASC_NT, db_ASC_NT$Group == "NT" & db_ASC_NT$outlier_intensity == FALSE))

anova(paper_analyses$lmer_NT_int2)
summary(paper_analyses$lmer_NT_int2)
step(paper_analyses$lmer_NT_int2)

paper_analyses$lmer_NT_int1<- lmer(AnswerRating_Intensity ~ 
                                     DATASET + Emotion+
                                    # VideoType+Emotion+
                                    # VideoType*Emotion*DATASET+ 
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = subset(db_ASC_NT, db_ASC_NT$Group == "NT"))


emmeans(paper_analyses$lmer_NT_int, ~VideoType)
emm_options(lmerTest.limit = 10176)
emmeans(paper_analyses$lmer_NT_int, ~DATASET )

summary(paper_analyses$lmer_NT_int)
drop1(paper_analyses$lmer_NT_int)
anova(paper_analyses$lmer_NT_int)
step(paper_analyses$lmer_NT_int)

# we find only models of main effecs no intractions on intenity
# Model found:
# AnswerRating_Intensity ~ VideoType + DATASET + Emotion + (1 | 
#     ParticipantPrivateID) + (1 | Video) + DATASET:Emotion


plot(paper_analyses$lmer_NT_int)
qqnorm(resid(paper_analyses$lmer_NT_int))
qqline(resid(paper_analyses$lmer_NT_int)) # broadly fine
r.squaredGLMM(paper_analyses$lmer_NT_int)
r.squaredGLMM(paper_analyses$lmer_NT_int1) #  smalll



paper_analyses$lmer_NT_int_analyze<- analyze(paper_analyses$lmer_NT_int,CI = 95, effsize_rules = "cohen1988")
paper_analyses$lmer_NT_int_analyze



```



lmer - valence - IQ and age matched participants
```{r}
library(readr)
library(dplyr)
MatchedIDlist <- read_csv("MatchedIDlist.csv")
View(MatchedIDlist)

private_publicid_mapping <- read_csv("private_publicid_mapping.csv")
View(private_publicid_mapping)

db_asc_nt_pp_matching<- left_join(MatchedIDlist, private_publicid_mapping)

db_asc_nt_pp_matching$ParticipantPrivateID<- as.character(db_asc_nt_pp_matching$ParticipantPrivateID)
unique(db_asc_nt_pp_matching$ParticipantPrivateID)
db_asc_nt_pp_matching<- subset(db_asc_nt_pp_matching, !is.na(db_asc_nt_pp_matching$ParticipantPublicID))

db_ASC_NT$ParticipantPrivateID<- as.character(db_ASC_NT$ParticipantPrivateID)
db_asc_nt_pp_matching$matched_iq_age_gend<- "YES"

db_ASC_NT_mergeidmacth<- left_join(db_asc_nt_pp_matching, db_ASC_NT, by = "ParticipantPrivateID")

db_ASC_NT_mergeidmacth1<- left_join(db_ASC_NT,db_asc_nt_pp_matching, by = "ParticipantPrivateID")

View(db_ASC_NT_mergeidmacth)
# db_ASC_NT$VideoType<- as.factor(db_ASC_NT$VideoType)

db_ASC_NT_mergeidmacth$MR_Tscore_c<- scale(db_ASC_NT_mergeidmacth$MR_Tscore, center = TRUE, scale = TRUE)
table(db_ASC_NT_mergeidmacth$matched_iq_age_gend)
table(is.na(db_ASC_NT_mergeidmacth1$matched_iq_age_gend))

paper_analyses$lmer_groupmath_valence<- lmer(AnswerRating_Valence ~ 
                                    VideoType + DATASET + Emotion+ Group.x +
                                      # MR_Tscore_c +
                                    # VideoType*Emotion*DATASET*Group.x+
                                    VideoType*Emotion+
                                      DATASET*Emotion+
                                      Emotion*Group.x+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = db_ASC_NT_mergeidmacth)

anova(paper_analyses$lmer_groupmath_valence)

paper_analyses$lmer_groupmath_valence_step<- step(paper_analyses$lmer_groupmath_valence)
paper_analyses$lmer_groupmath_valence_step
# consistent model, only difference is group by dataset intercation which is dropped
# iq was dropped

# model residuals seem dine
plot(paper_analyses$lmer_groupmath_valence)
qqnorm(residuals(paper_analyses$lmer_groupmath_valence))
qqline(residuals(paper_analyses$lmer_groupmath_valence))
# looking okay
library(MuMIn)

r.squaredGLMM(paper_analyses$lmer_groupmath_valence) # still simar to umatched analisys

summary(paper_analyses$lmer_groupmath_valence)



# intensity



paper_analyses$lmer_groupmath_intensity<- lmer(AnswerRating_Intensity ~ 
                                    VideoType + DATASET + Emotion+ Group.x +
                                      # MR_Tscore_c +
                                    VideoType*Emotion*DATASET*Group.x+
                                    # VideoType*Emotion+
                                    #   DATASET*Emotion+
                                    #   Emotion*Group.x+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = db_ASC_NT_mergeidmacth)

plot(paper_analyses$lmer_groupmath_intensity)
qqnorm(residuals(paper_analyses$lmer_groupmath_intensity))
qqline(residuals(paper_analyses$lmer_groupmath_intensity))

# it's okay

paper_analyses$lmer_groupmath_intensity_step<- step(paper_analyses$lmer_groupmath_intensity)
paper_analyses$lmer_groupmath_intensity_step

# IQ scores are also dropped

# Model found: consistent with unmatched data
# AnswerRating_Intensity ~ VideoType + DATASET + Emotion + Group.x + 
    # (1 | ParticipantPrivateID) + (1 | Video) + DATASET:Emotion

r.squaredGLMM(paper_analyses$lmer_groupmath_intensity) #similar to main results



# naturality


paper_analyses$lmer_groupmath_naturality<- lmer(AnswerRating_Naturality ~ 
                                    VideoType + DATASET + Emotion+ Group.x +
                                      MR_Tscore_c +
                                    VideoType*Emotion*DATASET*Group.x+
                                    # VideoType*Emotion+
                                    #   DATASET*Emotion+
                                    #   Emotion*Group.x+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = db_ASC_NT_mergeidmacth)


plot(paper_analyses$lmer_groupmath_naturality) # not great
qqnorm(residuals(paper_analyses$lmer_groupmath_naturality))
qqline(residuals(paper_analyses$lmer_groupmath_naturality)) #fine


paper_analyses$lmer_groupmath_naturality_step<- step(paper_analyses$lmer_groupmath_naturality)
paper_analyses$lmer_groupmath_naturality_step #main difference is that now videotyoe group is significant
r.squaredGLMM(paper_analyses$lmer_groupmath_naturality) #similar to full sample


# recognition

paper_analyses$lmer_groupmath_acc<- glmer(Recognacc ~ 
                                    VideoType + DATASET + Emotion+ Group.x +
                                      MR_Tscore_c +
                                    VideoType*Emotion*DATASET*Group.x+
                                    # VideoType*Emotion+
                                    #   DATASET*Emotion+
                                    #   Emotion*Group.x+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  family = 'binomial',
                                    data = db_ASC_NT_mergeidmacth)

anova(paper_analyses$lmer_groupmath_acc)

paper_analyses$lmer_groupmath_acc1<- glmer(Recognacc ~ 
                                    VideoType + DATASET + Emotion+ Group.x +
                                      # MR_Tscore_c +
                                    # VideoType*Emotion*
                                      DATASET*Emotion+
                                      # Emotion*Group.x+
                                      DATASET*Group.x+
                                      # VideoType*Group.x+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  family = 'binomial',
                                    data = db_ASC_NT_mergeidmacth)



summary(paper_analyses$lmer_groupmath_acc1)
anova(paper_analyses$lmer_groupmath_acc1)

r.squaredGLMM(paper_analyses$lmer_groupmath_acc1) #consistent

db_ASC_NT_mergeidmacth%>%
  group_by(VideoType,Emotion, Emotion2, DATASET)%>%
  mutate(mean_in = mean(Recognacc, na.rm = TRUE))%>%
  group_by(ParticipantPrivateID,Group.x, VideoType,Emotion,Emotion2,DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion2, Recognacc, colour = VideoType))+
  # geom_point(pch = 21, position = position_jitterdodge(), alpha = .6)+
  geom_boxplot(aes(y =mean_in), size = .7, width=0.7, fill="white", position=position_dodge(1))+
  theme_classic()+
  facet_grid(DATASET~Group.x)
  xlab("Emotion")+
  ylab("Intensity")+
  ggtitle("ADFES")
```





Now do the same on Naturality

Anova on naturality
```{r}
paper_analyses$aov_NT_nat<- aov_ez(data = db_NT_anova, 
       id = "ParticipantPrivateID",
       dv = "AnswerRating_Naturality",
       within = c("VideoType", "DATASET", "Emotion"),
       between = NULL,
       covariate = NULL)
paper_analyses$aov_NT_nat
# No ME of VideoType, SIgn ME of DATASET and Emotion and significant two and three way intercations
# check contrasts for emotion and DATASET

# paper_analyses$aov_NT_int$VideoType_ttest<-emmeans::emmeans(paper_analyses$aov_NT_int, pairwise~ VideoType)
# paper_analyses$aov_NT_int$VideoType_ttest

paper_analyses$aov_NT_nat$DATASET_ttest<-emmeans::emmeans(paper_analyses$aov_NT_nat, pairwise~ DATASET)
paper_analyses$aov_NT_nat$DATASET_ttest # JEFFE > ADFES

paper_analyses$aov_NT_nat$EMotion_ttest<-emmeans::emmeans(paper_analyses$aov_NT_nat, pairwise~ Emotion, adjust = "bonf")
paper_analyses$aov_NT_nat$EMotion_ttest # all but 4 contrasts are significant

# two-way int
paper_analyses$aov_NT_nat$VideoType_DS <-emmeans::emmeans(paper_analyses$aov_NT_nat, pairwise~ VideoType*DATASET, adjust = "none")
paper_analyses$aov_NT_nat$VideoType_DS
# morphing is more natural than original for ADFES and less JEFFE morph is less natural

# emotion videoType interaction
paper_analyses$aov_NT_nat$VideoType_EMotion <-emmeans::emmeans(paper_analyses$aov_NT_nat, pairwise~ VideoType*Emotion, adjust = "none")
paper_analyses$aov_NT_nat$VideoType_EMotion # only important morh and original happiness significance

# Study 2

study2$aov_ASCNT_nat<- aov_ez(data = db_ASCNT_anova, 
       id = "ParticipantPrivateID",
       dv = "AnswerRating_Naturality",
       within = c("VideoType", "DATASET", "Emotion"),
       between = 'Group',
       covariate = NULL)

study2$aov_ASCNT_nat
paper_analyses$aov_NT_nat
# significant two-way intecation with VideoType_DS

emmeans(study2$aov_ASCNT_nat, pairwise~ VideoType*DATASET, adjust = "none") # fr adfes miroh are more natural

emmeans(study2$aov_ASCNT_nat, pairwise~ VideoType*Emotion, adjust = "none") # fr adfes miroh are more natural
# effect only on happiness

# emmeans(study2$aov_ASCNT_nat, pairwise~ VideoType*Emotion, adjust = "none")


```


anova on matched

```{r}
paper_analyses$aov_NT_nat_matched<- aov_ez(data = db_NT_anova_matched, 
       id = "ParticipantPrivateID",
       dv = "AnswerRating_Naturality",
       within = c("VideoType", "DATASET", "Emotion"),
       between = NULL,
       covariate = NULL)
paper_analyses$aov_NT_nat_matched
# No ME of Video, but all intercation signiicant - all small effects


# study 2

study2$aov_ASCNT_nat_matched<- aov_ez(data = db_ASCNT_anova_matched, 
       id = "ParticipantPrivateID",
       dv = "AnswerRating_Naturality",
       within = c("VideoType", "DATASET", "Emotion"),
       between = 'Group',
       covariate = NULL)
study2$aov_ASCNT_nat_matched # consistent with unatched

```

lmer NATURALITY FUll
```
```{r}

db_ASC_NT$VideoType<- as.factor(db_ASC_NT$VideoType)
paper_analyses$lmer_NT_nat<- lmer(AnswerRating_Naturality ~ 
                                    VideoType + DATASET + Emotion+
                                    VideoType*Emotion+
                                    VideoType*DATASET+
                                    DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = subset(db_ASC_NT, db_ASC_NT$Group == "NT"))

anova(paper_analyses$lmer_NT_nat)
summary(paper_analyses$lmer_NT_nat)


paper_analyses$lmer_NT_nat1<- lmer(AnswerRating_Naturality ~ 
                                     DATASET + Emotion+
                                  
                                    DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = subset(db_ASC_NT, db_ASC_NT$Group == "NT"))


# study 2

study2$lmer_ASNT_nat<- lmer(AnswerRating_Naturality ~ 
                                    VideoType + DATASET + Emotion+Group+
                                    VideoType*Emotion+
                              VideoType*DATASET+
                              VideoType*Group+
                               # VideoType*Group*Emotion+
                              Emotion*Group+
                              DATASET*Group+
                                    # VideoType*Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = db_ASC_NT)


unique(db_%>%
         subset(Group == "ASC")$ParticipantPrivateID)

r.squaredGLMM(study2$lmer_ASNT_nat) #9%
anova(study2$lmer_ASNT_nat)

step(study2$lmer_ASNT_nat)

emmeans(study2$lmer_ASNT_nat, pairwise~DATASET, adjust = 'none')
# 
emmeans(study2$lmer_ASNT_nat, pairwise~Emotion, adjust = 'Bonferroni')
# 
emmeans(study2$lmer_ASNT_nat, pairwise~VideoType|Emotion, adjust = 'none')
# happiness

emmeans(study2$lmer_ASNT_nat, pairwise~VideoType|DATASET, adjust = 'none')
# happiness, conistent with anova, ADFES, morph is more natural
emmeans(study2$lmer_ASNT_nat, pairwise~VideoType|Emotion, adjust = 'none')
# happiness
# videotype don't intercat with group
emmeans(study2$lmer_ASNT_nat, pairwise~Group|Emotion, adjust = 'none')
# ASC differe exactly on Happiness,ASC - Happiness,NT  -5.3366 2.10 Inf  -2.536 0.0112 
# ASC are poorer on Happines
emmeans(study2$lmer_ASNT_nat, pairwise~Group*DATASET, adjust = 'none')
# ASC they don't differ on the things that matter

# happiness



# only two way intecation
# model found
# nswerRating_Naturality ~ VideoType + DATASET + Emotion + Group + 
#     (1 | ParticipantPrivateID) + (1 | Video) + VideoType:Emotion + 
#     VideoType:DATASET + DATASET:Emotion + Emotion:Group + DATASET:Group

emmeans(study2$lmer_ASNT_nat, pairwise~)


# RT

paper_analyses$lmer_NT_nat_RT<- lmer(log1p(ReactionTime_Naturality+.5) ~ 
                                    VideoType + DATASET + Emotion+
                                    VideoType*Emotion+
                                    VideoType*DATASET+
                                    DATASET*Emotion+
                                    VideoType*Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = subset(db_NT_lmer, db_NT_lmer$ReactionTime_Naturality_outlier == "YES"))

paper_analyses$lmer_NT_nat_RT1<- lmer(log1p(ReactionTime_Naturality+.5) ~ 
                                    DATASET + Emotion+
                                    Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = subset(db_NT_lmer, db_NT_lmer$ReactionTime_Naturality_outlier == "YES"))

summary(paper_analyses$lmer_NT_nat_RT)
anova(paper_analyses$lmer_NT_nat_RT)
step(paper_analyses$lmer_NT_nat_RT)

emmeans(paper_analyses$lmer_NT_nat_RT, pairwise~VideoType*DATASET)

db_NT_lmer%>%
  ggplot(aes(VideoType, ReactionTime_Naturality))+
  geom_boxplot()+
  facet_grid(DATASET~ReactionTime_Naturality_outlier)
# 
r.squaredGLMM(paper_analyses$lmer_NT_nat_RT)
r.squaredGLMM(paper_analyses$lmer_NT_nat_RT1) # nop

Q <- quantile(db_NT_lmer$ReactionTime_Naturality, probs=c(.25, .75), na.rm = FALSE)

iqr <- IQR(db_NT_lmer$ReactionTime_Naturality)

# cutoff
up <-  Q[2]+1.5*iqr # Upper Range  
low<- Q[1]-1.5*iqr # Lower Range�

db_NT_lmer$ReactionTime_Naturality_outlier<- ifelse(db_NT_lmer$ReactionTime_Naturality > (Q[1] - 1.5*iqr) & db_NT_lmer$ReactionTime_Naturality < (Q[2]+1.5*iqr), "YES","NO")
unique(db_NT_lmer$ReactionTime_Recognition_outlier)

nrow(db_NT_lmer)
nrow(eliminates)

summary(paper_analyses$lmer_NT_nat)
emmeans(paper_analyses$lmer_NT_nat, pairwise~VideoType, adjust = "none")
drop1(paper_analyses$lmer_NT_nat)
anova(paper_analyses$lmer_NT_nat)
step(paper_analyses$lmer_NT_nat) 


paper_analyses$lmer_NT_nat_analyze<- analyze(paper_analyses$lmer_NT_nat, CI = 95)

# consistent with anova, all main effects significant appart from Video Type and all intercation sigificant appart from three-way
paper_analyses$lmer_NT_nat_VT_DS <- emmeans(paper_analyses$lmer_NT_nat,pairwise~ VideoType*DATASET)
paper_analyses$lmer_NT_nat_VT_DS
# test the specific effects
# consistet with anovas, morphs are more narural for ADFES and less natural for JEFFE

# VideoType*EMotion
paper_analyses$lmer_NT_nat_VT_EM <- emmeans(paper_analyses$lmer_NT_nat,pairwise~ VideoType*Emotion, adjust = "none")
paper_analyses$lmer_NT_nat_VT_EM
# again emotion effects seem to be driven by happiness



# model found
# AnswerRating_Naturality ~ VideoType + DATASET + Emotion + (1 | 
#     ParticipantPrivateID) + (1 | Video) + VideoType:Emotion + 
#     VideoType:DATASET + DATASET:Emotion


plot(paper_analyses$lmer_NT_nat)
paper_analyses$lmer_NT_nat_DS_EM <- emmeans(paper_analyses$lmer_NT_nat,pairwise~ DATASET*Emotion, adjust = "none")
paper_analyses$lmer_NT_nat_DS_EM

EMqqnorm(resid(paper_analyses$lmer_NT_nat))
qqline(resid(paper_analyses$lmer_NT_nat)) fine

r.squaredGLMM(paper_analyses$lmer_NT_nat)
r.squaredGLMM(paper_analyses$lmer_NT_nat1)

```

Plotting Naturality

```{r}
# JADFES

paper_plots$ADFES_Naturality<- 
  subset(db_ASC_NT, db_ASC_NT $Group == "NT")%>% 
         # &  db_ASC_NT$DATASET == 'ADFES')%>%
  filter(outlier_naturality == FALSE)%>%
  group_by(VideoType,Emotion, Emotion2, DATASET)%>%
  mutate(mean_in = mean(AnswerRating_Naturality, na.rm = TRUE))%>%
  group_by(ParticipantPrivateID, VideoType,Emotion,Emotion2,DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(VideoType, AnswerRating_Naturality, colour = VideoType))+
  geom_point(pch = 21, position = position_jitterdodge(), alpha = .5)+
  geom_smooth(aes(group = ParticipantPrivateID), method = 'lm', se = F, 
              color = "gray", alpha = .5,size = .5)+
  
  geom_boxplot(aes(y =mean_in), size = .7, width=0.7, fill="white", position=position_dodge(1))+
  
  theme_classic()+
  xlab("Emotion")+
  ylab("Naturality")+
  ggtitle("High prototypicality")+
  facet_wrap(DATASET~Emotion2, nrow = 1)






```



paper_plots$ADFES_Naturality<- paper_plots$ADFES_Naturality +
  p$graphstyle+
  scale_y_continuous(breaks = c(0, 50,100), limits = c(0,100))+
  scale_color_brewer(palette = "Dark2")
paper_plots$ADFES_Naturality




# JEFFE
```{r}
paper_plots$JEFFE_Naturality<- subset(db_ASC_NT, db_ASC_NT $Group == "NT" & db_ASC_NT$DATASET == 'JEFFE')%>%
  filter(outlier_naturality == FALSE)%>%
  group_by(VideoType,Emotion, Emotion2, DATASET)%>%
  mutate(mean_in = mean(AnswerRating_Naturality, na.rm = TRUE))%>%
  group_by(ParticipantPrivateID, VideoType,Emotion,Emotion2,DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion2, AnswerRating_Naturality, colour = VideoType))+
  geom_point(pch = 21, position = position_jitterdodge(), alpha = .6)+
  geom_boxplot(aes(y =mean_in), size = .7, width=0.7, fill="white", position=position_dodge(1))+
  theme_classic()+
  xlab("Emotion")+
  ylab("Naturality")+
  ggtitle("JeFEE")


paper_plots$Naturality_Global<- subset(db_ASC_NT, db_ASC_NT $Group == "NT")%>%
  filter(outlier_naturality == FALSE)%>%
  group_by(VideoType,Emotion, Emotion2)%>%
  mutate(mean_in = mean(AnswerRating_Naturality, na.rm = TRUE))%>%
  group_by(ParticipantPrivateID, VideoType,Emotion,Emotion2,DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion2, AnswerRating_Naturality, colour = VideoType))+
  geom_point(pch = 21, position = position_jitterdodge(), alpha = .6)+
  geom_boxplot(aes(y =mean_in), size = .7, width=0.7, fill="white", position=position_dodge(1))+
  theme_classic()+
  xlab("Emotion")+
  ylab("Naturality")
  # ggtitle("Global")


paper_plots$Naturality_Global<- paper_plots$Naturality_Global+ p$graphstyle+
  scale_y_continuous(breaks = c(0, 50,100), limits = c(0,100))+
  scale_color_brewer(palette = "Dark2")

# global Valence

paper_plots$Valence_Global<- subset(db_ASC_NT, db_ASC_NT $Group == "NT")%>%
  filter(outlier_valence == FALSE)%>%
  group_by(VideoType,Emotion, Emotion2)%>%
  mutate(mean_val = mean(AnswerRating_Valence, na.rm = TRUE))%>%
  group_by(ParticipantPrivateID, VideoType,Emotion,Emotion2,DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion2, AnswerRating_Valence, colour = VideoType))+
  geom_point(pch = 21, position = position_jitterdodge(), alpha = .6)+
  geom_boxplot(aes(y =mean_val), size = .7, width=0.7, fill="white", position=position_dodge(1))+
  theme_classic()+
  xlab("Emotion")+
  ylab("Valence")+
  ggtitle("Global")

paper_plots$Valence_Global<-  paper_plots$Valence_Global+ p$graphstyle+
  scale_y_continuous(breaks = c(0, 50,100), limits = c(0,100))+
  scale_color_brewer(palette = "Dark2")

# intensity Global

paper_plots$Intensity_Global<- subset(db_ASC_NT, db_ASC_NT $Group == "NT")%>%
  filter(outlier_intensity == FALSE)%>%
  group_by(VideoType,Emotion, Emotion2)%>%
  mutate(mean_val = mean(AnswerRating_Intensity, na.rm = TRUE))%>%
  group_by(ParticipantPrivateID, VideoType,Emotion,Emotion2,DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion2, AnswerRating_Intensity, colour = VideoType))+
  geom_point(pch = 21, position = position_jitterdodge(), alpha = .6)+
  geom_boxplot(aes(y =mean_val), size = .7, width=0.7, fill="white", position=position_dodge(1))+
  theme_classic()+
  xlab("Emotion")+
  ylab("Intensity")
  # ggtitle("Global")

paper_plots$Intensity_Global<-  paper_plots$Intensity_Global+ p$graphstyle+
  scale_y_continuous(breaks = c(0, 50,100), limits = c(0,100))+
  scale_color_brewer(palette = "Dark2")


paper_plots$Naturality_Global

paper_plots$JEFFE_Naturality<- paper_plots$JEFFE_Naturality +
  p$graphstyle+
  scale_y_continuous(breaks = c(0, 50,100), limits = c(0,100))+
  scale_color_brewer(palette = "Dark2")

paper_plots$ADFES_Naturality
paper_plots$JEFFE_Naturality


 paper_plots$Naturality_patchwork<- paper_plots$ADFES_Naturality+ paper_plots$JEFFE_Naturality+
   theme(axis.title.y = element_blank(), axis.title.x = element_blank())+
   plot_layout(nrow = 1, ncol = 2, guides = 'collect')& theme(legend.position = 'top')
  paper_plots$Naturality_patchwork
 paper_plots$intensity_patchwork 
ggsave("Naturality_panel.png", paper_plots$Naturality_patchwork, device = 'png', width = 10, height =5 , dpi = 900) 

ggsave("Naturality_panel.tiff", paper_plots$Naturality_patchwork, device = 'tiff', width = 10, height =
         5,
       dpi = 900) 





paper_plots$Naturality_patchwork

paper_plots$panel_allratings<-
  paper_plots$ADFES_valence +  
  theme(axis.title.x = element_blank(), 
             axis.text.x = element_blank())+
  paper_plots$JEFFE_valence+ 
  theme(axis.title.y = element_blank(), 
        axis.title.x = element_blank(),
        axis.text.x = element_blank()) /
      (paper_plots$ADFES_intensity+  theme(axis.title.x = element_blank(), 
                                           axis.text.x = element_blank(),
                                    plot.title = element_blank())) /
      (paper_plots$JeFEE_intensity+ theme(axis.title.y = element_blank(), 
                                          axis.title.x = element_blank(),
                                          axis.text.x = element_blank(),  
                                          plot.title = element_blank())) /

      (paper_plots$ADFES_Naturality+  
         theme( plot.title = element_blank())+
         paper_plots$JEFFE_Naturality+ theme(axis.title.y = element_blank(),
                                             axis.title.x = element_blank(),
                                             plot.title = element_blank()))+
  plot_layout(nrow = 3, ncol = 3, guides = 'collect')
    plot_layout(guides = 'collect') & theme(legend.position = 'top')
  

paper_plots$panel_allratings<- paper_plots$panel_allratings+
  plot_annotation(tag_levels = 'A')&  theme(plot.tag = element_text(size = 13))
  paper_plots$panel_allratings
paper_plots$Naturality_patchwork
  paper_plots$intensity_patchwork
  
  
  ggsave("panel_allratings.png", paper_plots$panel_allratings, device = 'png', width = 10, height =7 , dpi = 1200) 

  ggsave("panel_allratings.png", paper_plots$panel_allratings, device = 'png', width = 15, height =10 , dpi = 900) 



```

LMER - Matched - Naturality
```{r}

paper_analyses$lmer_NT_nat_matched<- lmer(AnswerRating_Naturality ~ 
                                    VideoType + DATASET + Emotion+
                                    VideoType*Emotion+
                                    VideoType*DATASET+
                                    # DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = db_NT_matched)

summary(paper_analyses$lmer_NT_nat_matched)
drop1(paper_analyses$lmer_NT_nat_matched)
anova(paper_analyses$lmer_NT_nat_matched)
step(paper_analyses$lmer_NT_nat_matched) 

# consistent with anova, all main effects and Full model

paper_analyses$lmer_NT_nat_VT_DS_matched <- emmeans(paper_analyses$lmer_NT_nat_matched,pairwise~ VideoType*DATASET)
paper_analyses$lmer_NT_nat_VT_DS_matched
# test the specific effects
# morphs are ant narural ont differ for ADFES and  morphs are less less natural for JEFFE

# VideoType*EMotion
paper_analyses$lmer_NT_nat_VT_EM_matched <- emmeans(paper_analyses$lmer_NT_nat_matched,pairwise~ VideoType*Emotion)
paper_analyses$lmer_NT_nat_VT_EM_matched
# again emotion effects seem to be driven by happiness

# model found
# AnswerRating_Naturality ~ VideoType + DATASET + Emotion + (1 | 
#     ParticipantPrivateID) + (1 | Video) + VideoType:Emotion + 
#     VideoType:DATASET + DATASET:Emotion


plot(paper_analyses$lmer_NT_nat_matched)
qqnorm(resid(paper_analyses$lmer_NT_nat_matched))
qqline(resid(paper_analyses$lmer_NT_nat_matched)) # fine



# Study 2
study2$lmer_ASCNT_nat_matched<- lmer(AnswerRating_Naturality ~ 
                                    VideoType + DATASET + Emotion+Group+
                                    # VideoType*Emotion+
                                    # VideoType*DATASET+
                                    # # DATASET*Emotion+
                                    VideoType*Emotion*DATASET*Group+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                    data = db_ASCNT_matched)

anova(study2$lmer_ASCNT_nat_matched)

tab_model(study2$lmer_ASCNT_nat_matched)

# consistent

```


Accuracy

```{r}
```


```{r}
min(db_NT_anova$Recognacc)
max(db_NT_anova$Recognacc)
unique(db_NT_anova$Recognacc)
db_NT_anova$Recognacc
db_NT_anova$Recognacc_log<- log1p(db_NT_anova$Recognacc+.01)
min(db_NT_anova$Recognacc_log)
max(db_NT_anova$Recognacc_log)
db_NT_anova%>%
  ggplot(aes(x = Recognacc_log))+
  geom_histogram()

paper_analyses$aov_NT_acc<- aov_ez(data = db_NT_anova, 
       id = "ParticipantPrivateID",
       dv = "Recognacc_log",
       within = c("VideoType", "DATASET", "Emotion"),
       between = NULL,
       covariate = NULL)
paper_analyses$aov_NT_acc
# all main effects - an interactions are significant - small effects

paper_analyses$aov_NT_acc$DATASET_ttest<-emmeans::emmeans(paper_analyses$aov_NT_acc, pairwise~ DATASET)
paper_analyses$aov_NT_acc$DATASET_ttest # ADFES> JEFFE


paper_analyses$aov_NT_acc$VideoType_ttest<-emmeans::emmeans(paper_analyses$aov_NT_acc, pairwise~ VideoType)
paper_analyses$aov_NT_acc$VideoType_ttest # Original >Morph

paper_analyses$aov_NT_acc$EMotion_ttest<-emmeans::emmeans(paper_analyses$aov_NT_acc, pairwise~ Emotion, adjust = "bonf")
paper_analyses$aov_NT_acc$EMotion_ttest # NS Anger - Disgust , Anger Sadness, Disgust Sadness, Sadness surpise, everything else is significant

# two-way int
paper_analyses$aov_NT_acc$VideoType_DS <-emmeans::emmeans(paper_analyses$aov_NT_acc, pairwise~ VideoType*DATASET, adjust = "bonf")
paper_analyses$aov_NT_acc$VideoType_DS
# morphing is more natural than original for ADFES and less JEFFE morph is less natural
# no differences in accuracy in morph and original for ADFES

# emotion videoType interaction
paper_analyses$aov_NT_acc$VideoType_EMotion <-emmeans::emmeans(paper_analyses$aov_NT_acc, pairwise~ VideoType*Emotion, adjust = "none")
paper_analyses$aov_NT_acc$VideoType_EMotion # Anger sign, Disust sign, Fear, no diff in Happiness????? interesting, it's perceived as different but people are accurate, whereas the otehrs are not perceived as different per se but it impacts accuracy


paper_analyses$aov_NT_acc$VideoType_EMotion <-emmeans::emmeans(paper_analyses$aov_NT_acc, pairwise~ VideoType*Emotion)
paper_analyses$aov_NT_acc$VideoType_EMotion # Anger sign, Disust sign, Fear, no diff in Happiness????? interesting, it's


# study 2
db_ASCNT_anova$Recognacc_log<- log1p(db_ASCNT_anova$Recognacc+.1)

study2$aov_ASCNT_acc<- aov_ez(data = db_ASCNT_anova, 
       id = "ParticipantPrivateID",
       dv = "Recognacc_log",
       within = c("VideoType", "DATASET", "Emotion"),
       between = "Group",
       covariate = NULL)


study2$aov_ASCNT_acc
# no intrecations with group, but mE of group
# Videotpe intercation are significant

emmeans(study2$aov_ASCNT_acc, pairwise~Group, adjust = "none")
emmeans(study2$aov_ASCNT_acc, pairwise~VideoType, adjust = "none")

emmeans(study2$aov_ASCNT_acc, pairwise~VideoType*DATASET, adjust = "none")
emmeans(study2$aov_ASCNT_acc, pairwise~VideoType*Emotion, adjust = "none")

# there is no difference in accuracy bu differenes in the oher categories is significant
# emmeans(study2$aov_ASCNT_acc, pairwise~Group, adjust = "none")



# matched

db_ASCNT_anova_matched$Recognacc_log<- log1p(db_ASCNT_anova_matched$Recognacc+.1)

study2$aov_ASCNT_acc_matched<- aov_ez(data = db_ASCNT_anova_matched, 
       id = "ParticipantPrivateID",
       dv = "Recognacc_log",
       within = c("VideoType", "DATASET", "Emotion"),
       between = "Group",
       covariate = NULL)

# grouo videotye emotion becomes significant

study2$aov_ASCNT_acc_matched #everything else is conistsent
```


Full glmer on ACCURACY


```{r}
db_ASC_NT$VideoType<- as.factor(db_ASC_NT$VideoType)
unique(db_ASC_NT$Recognacc)
paper_analyses$glmer_NT_acc<- glmer(Recognacc ~ 
                                    VideoType + DATASET + Emotion+
                                    VideoType*Emotion+
                                    VideoType*DATASET+
                                    # DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  # REML = FALSE,
                                  family = 'binomial',
                                    data = subset(db_ASC_NT, db_ASC_NT$Group == "NT"),
                                  )
library(ggeffects)
# Note the use of the "all"-tag here, see help for details
ggpredict(paper_analyses$glmer_NT_acc, "VideoType") %>% plot()

emmeans::emmeans(paper_analyses$glmer_NT_acc, ~ VideoType, type = "response")

emmeans::emmeans(paper_analyses$glmer_NT_acc, ~DATASET* VideoType, type = "response")

```
















```{r}

db_ASC_NT %>%
  subset(Group == "NT")%>%
  group_by(ParticipantPrivateID, VideoType, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(VideoType, Recognacc, color = VideoType))+
  geom_boxplot()+
  geom_jitter(width = .1, alpha = .2)+
  stat_summary(fun.y = mean, geom = 'pointrange', color = "red")+
  facet_grid(~DATASET)
  
  
db_ASC_NT %>%
  subset(Group == "NT")%>%
  group_by(ParticipantPrivateID, VideoType)%>%
  mutate(Recognacc_mean = mean(Recognacc),  mean,na.rm = TRUE)

```

paper_analyses$glmer_NT_acc_noem<- glmer(Recognacc ~ 
                                    VideoType + DATASET+
                                    # VideoType* Emotion+
                                    VideoType*DATASET+
                                    # DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  # REML = FALSE,
                                  family = 'binomial',
                                    data = subset(db_ASC_NT, db_ASC_NT$Group == "NT"),
                                  )


paper_analyses$glmer_NT_acc1<- glmer(Recognacc ~ 
                                    VideoType + DATASET + Emotion+
                                    VideoType*Emotion+
                                    VideoType*DATASET+
                                    # DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  # REML = FALSE,
                                  family = 'binomial',
                                    data = subset(db_NT_lmer, db_NT_lmer$ReactionTime_Recognition_outlier == "YES"),
                                  )



summary(paper_analyses$glmer_NT_acc1)
anova(paper_analyses$glmer_NT_acc1)
anova(paper_analyses$glmer_NT_acc)
anova(paper_analyses$glmer_NT_acc,paper_analyses$glmer_NT_acc_noem)

acc_emm<- emmeans(paper_analyses$glmer_NT_acc1, pairwise~VideoType, adjust = "none")
?eff_size

 emmeans(paper_analyses$glmer_NT_acc1, pairwise~DATASET, adjust = "none")
emmeans(paper_analyses$glmer_NT_acc1, pairwise~VideoType*DATASET, adjust = "none")

emmeans(paper_analyses$glmer_NT_acc1, pairwise~VideoType*DATASET, adjust = "none")

emmeans(paper_analyses$glmer_NT_acc1, pairwise~VideoType*Emotion, adjust = "none")

emmeans(paper_analyses$glmer_NT_acc1, pairwise~Emotion, adjust = "holm")

p.adjust(0.0040, n = 2)

# eff_size(pairs(acc_emm),sigma(paper_analyses$glmer_NT_acc@dev),  edf = 105 )

max(db_ASC_NT$ReactionTime_Recognition)
min(db_ASC_NT$ReactionTime_Recognition)
median(db_ASC_NT$ReactionTime_Recognition)

View(db_ASC_NT )

db_NT_lmer%>%
  group_by(VideoType)%>%
  summarise(mean = mean(Recognacc, na.rm = TRUE), sd = sd(Recognacc, na.rm = TRUE))

```



# JADFES

paper_plots$ADFES_acc<- subset(db_ASC_NT, db_ASC_NT $Group == "NT" & db_ASC_NT$DATASET == 'ADFES')%>%
  # filter(outlier_valence == FALSE)%>%
  group_by(VideoType,Emotion, Emotion2, DATASET)%>%
  mutate(mean_in = mean(Recognacc, na.rm = TRUE))%>%
  group_by(ParticipantPrivateID, VideoType,Emotion,Emotion2,DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion2, log1p(Recognacc+.1), colour = VideoType))+
  geom_point(pch = 21, position = position_jitterdodge(), alpha = .6)+
  geom_boxplot(aes(y = log1p(mean_in +.1)), size = .7, width=0.7, fill="white",
                   position=position_dodge(1))+
  theme_classic()+
  xlab("Emotion")+
  ylab("Valence")
  # ggtitle("ADFES")

paper_plots$ADFES_acc
```{r}

# study 2
options(contrasts = c("contr.sum","contr.poly"))
study2$glmer_ascNT_acc<- glmer(Recognacc ~ 
                                    VideoType + DATASET + Emotion+Group+
                                    VideoType*Emotion+
                                    VideoType*DATASET+
                                    DATASET*Emotion+
                                 Group*VideoType+
                                 Group*DATASET+
                                    # VideoType*Emotion*DATASET*Group+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  # REML = FALSE,
                                  family = 'binomial',
                                    data = db_ASC_NT,
                                  )

study2$glmer_ascNT_acc_null1<- glmer(Recognacc ~ 
                                    DATASET + Emotion+
                                      Group +
                                    # VideoType*Emotion+
                                    # VideoType*DATASET+
                                    DATASET*Emotion+
                                 # Group*VideoType+
                                 Group*DATASET+
                                    # VideoType*Emotion*DATASET*Group+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  # REML = FALSE,
                                  family = 'binomial',
                                    data = db_ASC_NT,
                                  )


study2$glmer_ascNT_acc_null2<- glmer(Recognacc ~ 
                                    VideoType+DATASET + Emotion+
                                      # Group +
                                    VideoType*Emotion+
                                    VideoType*DATASET+
                                    DATASET*Emotion+
                                 # Group*VideoType+
                                 # Group*DATASET+
                                    # VideoType*Emotion*DATASET*Group+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  # REML = FALSE,
                                  family = 'binomial',
                                    data = db_ASC_NT,
                                  )


study2$glmer_ascNT_acc_null4<- glmer(Recognacc ~ 
                                    VideoType+DATASET + Emotion+
                                      Group +
                                    DATASET:Emotion+
                                 # Group*VideoType+
                                 Group*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  # REML = FALSE,
                                  family = 'binomial',
                                    data = db_ASC_NT,
                                  )


study2$glmer_ascNT_acc_null5<- glmer(Recognacc ~ 
                                    VideoType+DATASET
                                    +
                                      Group +
                                    DATASET+
                                      # Emotion+
                                 # Group*VideoType+
                                 Group*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  # REML = FALSE,
                                  family = 'binomial',
                                    data = db_ASC_NT,
                                  )

study2$glmer_ascNT_acc_null3<- glmer(Recognacc ~ 
                                    DATASET + Emotion+
                                      # Group +
                                    # VideoType*Emotion+
                                    # VideoType*DATASET+
                                    DATASET*Emotion+
                                 # Group*VideoType+
                                 # Group*DATASET+
                                    # VideoType*Emotion*DATASET*Group+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  # REML = FALSE,
                                  family = 'binomial',
                                    data = db_ASC_NT,
                                  )


summary(study2$glmer_ascNT_acc)
anova(study2$glmer_ascNT_acc, type = 3)
drop1(study2$glmer_ascNT_acc, refit = FALSE)
anova(study2$glmer_ascNT_acc_null5, type = 3)
anova(study2$glmer_ascNT_acc_null3, study2$glmer_ascNT_acc_null2, study2$glmer_ascNT_acc_null3,study2$glmer_ascNT_acc_null4, study2$glmer_ascNT_acc)
anova(study2$glmer_ascNT_acc_null3, study2$glmer_ascNT_acc_null4) #videotype
anova(study2$glmer_ascNT_acc_null3, study2$glmer_ascNT_acc_null1) #Group
anova(study2$glmer_ascNT_acc_null3, study2$glmer_ascNT_acc) #videotype
anova(study2$glmer_ascNT_acc_null4, study2$glmer_ascNT_acc_null5) # test ME of emotion
anova(study2$glmer_ascNT_acc_null4, study2$glmer_ascNT_acc)

r.squaredGLMM(study2$glmer_ascNT_acc_null4)

summary(study2$glmer_ascNT_acc)
anova(study2$lmer_ASCNT_nat)
anova(study2$glmer_ascNT_acc_null4)
# pbkrtest::ge(study2$glmer_ascNT_acc)

drop1(study2$glmer_ascNT_acc)

r.squaredGLMM(study2$glmer_ascNT_acc)

emmeans(study2$glmer_ascNT_acc_null4, pairwise ~Group,adjust = "none")
emmeans(study2$glmer_ascNT_acc_null4, pairwise ~DATASET,adjust = "none")
emmeans(study2$glmer_ascNT_acc_null4, pairwise ~Group|DATASET,adjust = "none")

emmeans(study2$glmer_ascNT_acc, pairwise ~Group*VideoType,adjust = "none")

emmeans(study2$glmer_ascNT_acc, pairwise ~Emotion,adjust = "Bonferroni")

emmeans(study2$glmer_ascNT_acc_null4, pairwise ~ DATASET |Emotion,adjust = "none")

emmeans(study2$glmer_ascNT_acc_null4, pairwise ~VideoType,adjust = "none")

emmeans(study2$glmer_ascNT_acc, pairwise ~VideoType*DATASET,adjust = "none")

emmeans(study2$glmer_ascNT_acc, pairwise ~VideoType*Emotion,adjust = "none")
# close effects all most pairs no effects on happiness

# emmeans(study2$glmer_ascNT_acc, pairwise ~Group*DATASET,adjust = "none") group difference only holss in high intensity dataset




```



paper_plots$ADFES_valence<- paper_plots$ADFES_valence +
  p$graphstyle+
  scale_y_continuous(breaks = c(0, 50,100), limits = c(0,100))+
  scale_color_brewer(palette = "Dark2")
paper_plots$ADFES_valence

# JEFFE

paper_plots$JEFFE_valence<- subset(db_ASC_NT, db_ASC_NT $Group == "NT" & db_ASC_NT$DATASET == 'JEFFE')%>%
  filter(outlier_valence == FALSE)%>%
  group_by(VideoType,Emotion, Emotion2, DATASET)%>%
  mutate(mean_in = mean(AnswerRating_Valence, na.rm = TRUE))%>%
  group_by(ParticipantPrivateID, VideoType,Emotion,Emotion2,DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion2, AnswerRating_Valence, colour = VideoType))+
  geom_point(pch = 21, position = position_jitterdodge(), alpha = .6)+
  geom_boxplot(aes(y =mean_in), size = .7, width=0.7, fill="white", position=position_dodge(1))+
  theme_classic()+
  xlab("Emotion")+
  ylab("Valence")+
  ggtitle("JeFEE")



paper_plots$JEFFE_valence<- paper_plots$JEFFE_valence +
  p$graphstyle+
  scale_y_continuous(breaks = c(0, 50,100), limits = c(0,100))+
  scale_color_brewer(palette = "Dark2")

paper_plots$ADFES_valence
paper_plots$JEFFE_valence


 paper_plots$valence_patchwork<- paper_plots$ADFES_valence+ paper_plots$JEFFE_valence+
   theme(axis.title.y = element_blank(), axis.title.x = element_blank())+
   plot_layout(nrow = 1, ncol = 2, guides = 'collect')& theme(legend.position = 'top')
  paper_plots$valence_patchwork
 paper_plots$intensity_patchwork 
ggsave("valence_panel.png", paper_plots$valence_patchwork, device = 'png', width = 10, height =5 , dpi = 900) 

ggsave("valence_panel.tiff", paper_plots$valence_patchwork, device = 'tiff', width = 10, height =
         5,
       dpi = 900) 




```{r}

# min(db_ASC_NT$chec, na.rm = TRUE)
db_NT_lmer<- subset(db_ASC_NT, db_ASC_NT$Group == "NT")

Q <- quantile(db_NT_lmer$ReactionTime_Recognition, probs=c(.25, .75), na.rm = FALSE)

iqr <- IQR(db_NT_lmer$ReactionTime_Recognition)

# cutoff
up <-  Q[2]+1.5*iqr # Upper Range  
low<- Q[1]-1.5*iqr # Lower Range�

db_NT_lmer$ReactionTime_Recognition_outlier<- ifelse(db_NT_lmer$ReactionTime_Recognition > (Q[1] - 1.5*iqr) & db_NT_lmer$ReactionTime_Recognition < (Q[2]+1.5*iqr), "YES","NO")
unique(db_NT_lmer$ReactionTime_Recognition_outlier)

nrow(db_NT_lmer)
nrow(eliminates)
eliminates<- subset(db_NT_lmer, db_NT_lmer$ReactionTime_Recognition_outlier == "YES")
db_NT_lmer%>%
  ggplot(aes(VideoType,ReactionTime_Intensity))+
  geom_boxplot()+
  facet_grid(ReactionTime_Recognition_outlier~DATASET)





# test
paper_analyses$glmer_NT_acc_RT <- lmer(log1p(ReactionTime_Recognition+.5) ~ 
                                    VideoType + DATASET + Emotion+
                                    # VideoType*Emotion+
                                    # VideoType*DATASET+
                                    DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                  # family = binomial(link = "log"),
                                    data = subset(db_NT_lmer, db_NT_lmer$ReactionTime_Recognition_outlier == "YES"),
                                  )

paper_analyses$glmer_NT_acc_RT1 <- lmer(log1p(ReactionTime_Recognition+.5) ~ 
                                    DATASET + Emotion+
                                    # VideoType*Emotion+
                                    # VideoType*DATASET+
                                    DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  REML = FALSE,
                                  # family = binomial(link = "log"),
                                    data = subset(db_NT_lmer, db_NT_lmer$ReactionTime_Recognition_outlier == "YES"),
                                  )

summary(paper_analyses$glmer_NT_acc_RT)
r.squaredGLMM(paper_analyses$glmer_NT_acc_RT, paper_analyses$glmer_NT_acc_RT1) # just 2 percent
r.squaredGLMM(paper_analyses$glmer_NT_acc_RT1)


anova(paper_analyses$glmer_NT_acc_RT) # suggests droping three way intercation,a nd videotype and emotion
step(paper_analyses$glmer_NT_acc_R) # model found one percent is explained by videotype actually, more than the otehr terms combined

plot(paper_analyses$glmer_NT_acc_RT)
qqnorm(resid(paper_analyses$glmer_NT_acc_RT))
qqline(resid(paper_analyses$glmer_NT_acc_RT)) # logarithim transofrmation improved the model residuals

# model found - 
```

```{r}
db_ASC_NT$RT_recogn_outlier<- if_else(db_ASC_NT$ReactionTime_Recognition > 3)


summary(paper_analyses$glmer_NT_acc_RT)

plot(paper_analyses$glmer_NT_acc_RT)

paper_analyses$glmer_NT_acc1<- glmer(Recognacc ~ 
                                    DATASET + Emotion+
                                    # VideoType*Emotion+
                                    # VideoType*DATASET+
                                    # DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  # REML = FALSE,
                                  family = 'binomial',
                                    data = subset(db_ASC_NT, db_ASC_NT$Group == "NT"),
                                  )


summary(paper_analyses$glmer_NT_acc)

relgrad <- with(paper_analyses$glmer_NT_acc@optinfo$derivs,solve(Hessian,gradient))
max(abs(relgrad))
drop1(paper_analyses$glmer_NT_acc)
anova(paper_analyses$glmer_NT_acc)
step(paper_analyses$glmer_NT_acc)

# consistent with anova for the mast part except no ME of videotype, all main effects significant appart from Video no intercation with video type either
paper_analyses$glmer_NT_acc_VT_DS <- emmeans(paper_analyses$glmer_NT_acc,pairwise~ VideoType*DATASET, adjust = "none")
paper_analyses$glmer_NT_acc_VT_DS # accuracy different in JEFFE

# test the specific effects
# consistet with anovas, morphs are more narural for ADFES and less natural for JEFFE

# VideoType*EMotion
paper_analyses$glmer_NT_acc_VT_EM <- emmeans(paper_analyses$glmer_NT_acc,pairwise~ VideoType*Emotion, adjust = "none")
paper_analyses$glmer_NT_acc_VT_EM
# No pairwise reaches significance


plot(paper_analyses$glmer_NT_acc)
qqnorm(resid(paper_analyses$glmer_NT_acc))
qqline(resid(paper_analyses$glmer_NT_acc))


r.squaredGLMM(paper_analyses$glmer_NT_acc)
r.squaredGLMM(paper_analyses$glmer_NT_acc1)
anova(paper_analyses$glmer_NT_acc, paper_analyses$glmer_NT_acc1)
paper_analyses$glmer_NT_acc_analyze<- analyze(paper_analyses$glmer_NT_acc)
paper_analyses$glmer_NT_acc




summary(study2$glmer_ASCNT_acc1)
anova(study2$glmer_ASCNT_acc1)
step(study2$glmer_ASCNT_acc1)
r.squaredGLMM(study2$glmer_ASCNT_acc1)


```


Mtched GLMER accuracy

```{r}


paper_analyses$glmer_NT_acc_matched<- glmer(Recognacc ~ 
                                    VideoType + DATASET + Emotion+
                                    VideoType*Emotion+
                                    VideoType*DATASET+
                                    # DATASET*Emotion+
                                    # VideoType*Emotion*DATASET+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  # REML = FALSE,
                                  family = 'binomial',
                                    data = db_NT_matched,
                                  )

summary(paper_analyses$glmer_NT_acc_matched)

emmeans(study2$glmer_ASCNT_acc_matched, pairwise~VideoType*Emotion, adjust = "none")
```

```
```{r}
relgrad <- with(paper_analyses$glmer_NT_acc_matched@optinfo$derivs,solve(Hessian,gradient))
max(abs(relgrad))
drop1(paper_analyses$glmer_NT_acc_matched)
anova(paper_analyses$glmer_NT_acc_matched)
step(paper_analyses$glmer_NT_acc_matched) 

# no videotype effects

paper_analyses$glmer_NT_acc_matched_VT_DS <- emmeans(paper_analyses$glmer_NT_acc_matched,pairwise~ VideoType*DATASET)
paper_analyses$glmer_NT_acc_matched_VT_DS # accuracy diff s trending for JEFFE

# test the specific effects
# consistet with anovas, morphs are more narural for ADFES and less natural for JEFFE

# VideoType*EMotion
paper_analyses$glmer_NT_acc_VT_EM_mactehd <- emmeans(paper_analyses$glmer_NT_acc_matched,pairwise~ VideoType*Emotion, adjust = "none")
paper_analyses$glmer_NT_acc_VT_EM_mactehd
# No pairwise reaches significance

# VideoType*EMotion
paper_analyses$glmer_NT_acc_VT_DS_mactehd <- emmeans(paper_analyses$glmer_NT_acc_matched,pairwise~ VideoType*DATASET, adjust = "none")
paper_analyses$glmer_NT_acc_VT_DS_mactehd # not significant


plot(paper_analyses$glmer_NT_acc)
qqnorm(resid(paper_analyses$glmer_NT_acc))
qqline(resid(paper_analyses$glmer_NT_acc))



# study
# study2

db_ASC_NT_matched<- subset(db_ASC_NT_matched, db_ASC_NT_matched$Emotion!= "Surprise")
study2$glmer_ASCNT_acc_matched<- glmer(Recognacc ~ 
                                    VideoType+DATASET + Emotion+Group+
                                   
                                    VideoType*DATASET+
                                  VideoType*Group+
                                VideoType*Emotion+
                                    DATASET*Emotion+

                                  DATASET*Group+
                                    (1 | ParticipantPrivateID) + (1 | Video),
                                  # REML = FALSE,
                                  family = 'binomial',
                                    data = db_ASC_NT_matched)

summary(study2$glmer_ASCNT_acc_matched)


anova(study2$glmer_ASCNT_acc_matched)

tab_model(study2$glmer_ASCNT_acc_matched)
```

Matched analisys
run atched anovas


```{r}
library(caret)
db_ASC_NT_matched
db_ASC_NT_matched_nosurp

# Create the necessaryr rference and prediction
db_ASC_NT_matched_nosurp$Reference<- db_ASC_NT_matched_nosurp$Emotion
db_ASC_NT_matched_nosurp$Prediction <- db_ASC_NT_matched_nosurp$AnswerRating_Recognition

a1<- union(db_ASC_NT_matched_nosurp$Prediction, db_ASC_NT_matched_nosurp$Reference)

# Start with ADFES and ASC
db_ASC_ADF_Confusion_Orig_matched<- subset(db_ASC_NT_matched_nosurp, db_ASC_NT_matched_nosurp$intensity_morph == 'ADFES_high_intensityOriginal' & db_ASC_NT_matched_nosurp$Group == 'ASC')

db_ASC_ADF_Confusion_Orig_matched

# confusion

db_ASC_ADF_Confusion_Orig_matrix_matched <- (caret::confusionMatrix(table(factor(db_ASC_ADF_Confusion_Orig_matched$Reference, a1), factor(db_ASC_ADF_Confusion_Orig_matched$Prediction, a1))))

View(db_ASC_ADF_Confusion_Orig_matrix_matched$table)
prop.table(db_ASC_ADF_Confusion_Orig_matrix_matched$table)


?caret::confusionMatrix

# table
sum(db_ASC_ADF_Confusion_Orig_table_matched$Freq)/4


db_ASC_ADF_Confusion_Orig_table_matched<- as.data.frame(db_ASC_ADF_Confusion_Orig_matrix_matched$table)
db_ASC_ADF_Confusion_Orig_table_matched$Prop <- db_ASC_ADF_Confusion_Orig_table_matched$Freq/77.75#divide the total 
View(db_ASC_ADF_Confusion_Orig_table_matched)
by 6?
# 576/6
sum(db_ASC_ADF_Confusion_Orig_table_matched$Freq)/6

max(db_ASC_ADF_Confusion_Orig_table_matched$Prop)
# b1
ggplot(db_ASC_ADF_Confusion_Orig_table_matched, aes(Var1, Var2, fill = Freq))+
  geom_tile()+
  scale_color_viridis_c(palette = 'Inferno')+
  theme_minimal()+  
  scale_fill_gradient2()
  scale_fill_gradient2(low = "blue", high = "red",limit = c(0,1), space = "Lab", 
                       name="Pearson\nCorrelation")


```



Morph

```{r}
# Start with ADFES and ASC
db_ASC_ADF_Confusion_Morph_matched<- subset(db_ASC_NT_matched_nosurp, db_ASC_NT_matched_nosurp$intensity_morph == 'ADFES_high_intensityMorph' & db_ASC_NT_matched_nosurp$Group == 'ASC')

db_ASC_ADF_Confusion_Morph_matched

# confusion

db_ASC_ADF_Confusion_Morph_matrix_matched <- (caret::confusionMatrix(table(factor(db_ASC_ADF_Confusion_Morph_matched$Reference, a1), factor(db_ASC_ADF_Confusion_Morph_matched$Prediction, a1))))

View(db_ASC_ADF_Confusion_Morph_matrix_matched$table)
prop.table(db_ASC_ADF_Confusion_Morph_matrix_matched$table)


?caret::confusionMatrix

# table
sum(db_ASC_ADF_Confusion_Morph_table_matched$Freq)/7


db_ASC_ADF_Confusion_Morph_table_matched<- as.data.frame(db_ASC_ADF_Confusion_Morph_matrix_matched$table)
db_ASC_ADF_Confusion_Morph_table_matched$Prop <- db_ASC_ADF_Confusion_Morph_table_matched$Freq/52.83333#divide the total 
View(db_ASC_ADF_Confusion_Morph_table_matched)
# by 6?
# 576/6
sum(db_ASC_ADF_Confusion_Morph_table_matched$Freq)/6

max(db_ASC_ADF_Confusion_Morph_table_matched$Freq)
# b1
db_ASC_ADF_Confusion_Morph_table_matched$Var1<- relevel(db_ASC_ADF_Confusion_Morph_table_matched$Var1, ref ="Neutral" )
db_ASC_ADF_Confusion_Morph_table_matched$Var2<- relevel(db_ASC_ADF_Confusion_Morph_table_matched$Var2, ref ="Neutral" )

db_ASC_ADF_Confusion_Morph_table_matched%>%
  mutate(Freq_norm = (Freq-min(Freq))/(max(Freq)-min(Freq)))%>%
  filter(Var1!= "Neutral")%>%
ggplot(aes(Var1, Var2, fill = Freq_norm))+

  geom_tile()+
  scale_color_viridis_c(palette = 'Inferno')+
  theme_minimal()+  
  scale_fill_gradient2()
  scale_fill_gradient2(low = "blue", high = "red",limit = c(0,1), space = "Lab", 
                       name="Pearson\nCorrelation")






```

JEFFE

```{r}
# Start with ADFES and ASC
db_ASC_JEFFE_Confusion_Orig_matched<- subset(db_ASC_NT_matched_nosurp, db_ASC_NT_matched_nosurp$intensity_morph == 'JEFFE_low_intensityOriginal' & db_ASC_NT_matched_nosurp$Group == 'ASC')

db_ASC_JEFFE_Confusion_Orig_matched

# confusion

db_ASC_JEFFE_Confusion_Orig_matrix_matched <- (caret::confusionMatrix(table(factor(db_ASC_JEFFE_Confusion_Orig_matched$Reference, a1), factor(db_ASC_JEFFE_Confusion_Orig_matched$Prediction, a1))))

View(db_ASC_JEFFE_Confusion_Orig_matrix_matched$table)
prop.table(db_ASC_JEFFE_Confusion_Orig_matrix_matched$table)

?caret::confusionMatrix

# table
# sum(db_ASC_JEFFE_Confusion_Orig_table_matched$Freq)/4


db_ASC_JEFFE_Confusion_Orig_table_matched<- as.data.frame(db_ASC_JEFFE_Confusion_Orig_matrix_matched$table)
db_ASC_JEFFE_Confusion_Orig_table_matched$Prop <- db_ASC_JEFFE_Confusion_Orig_table_matched$Freq/77.75#divide the 

total 
View(db_ASC_JEFFE_Confusion_Orig_table_matched)
# by 6?
# 576/6
sum(db_ASC_JEFFE_Confusion_Orig_table_matched$Freq)/6

max(db_ASC_JEFFE_Confusion_Orig_table_matched$Prop)
# b1

db_ASC_JEFFE_Confusion_Orig_table_matched$Var2<- relevel(db_ASC_JEFFE_Confusion_Orig_table_matched$Var2, ref = "Neutral")

db_ASC_JEFFE_Confusion_Orig_table_matched%>%
  mutate(Freq_norm = (Freq-min(Freq))/(max(Freq)-min(Freq)))%>%
  filter(Var1!= "Neutral")%>%
ggplot(aes(Var1, Var2, fill = Freq_norm))+
  geom_tile()+
  scale_color_viridis_c(palette = 'Inferno')+
  theme_minimal()+  
  # scale_fill_gradient2()
  scale_fill_gradient2(low = "blue", high = "red",limit = c(0,1), space = "Lab", 
                       name="Pearson\nCorrelation")


```


```{r}
db_ASC_JEFFE_Confusion_Morph_matched<- subset(db_ASC_NT_matched_nosurp, db_ASC_NT_matched_nosurp$intensity_morph == 'JEFFE_low_intensityMorph' & db_ASC_NT_matched_nosurp$Group == 'ASC')

db_ASC_JEFFE_Confusion_Morph_matched

# confusion

db_ASC_JEFFE_Confusion_Morph_matrix_matched <- (caret::confusionMatrix(table(factor(db_ASC_JEFFE_Confusion_Morph_matched$Reference, a1), factor(db_ASC_JEFFE_Confusion_Morph_matched$Prediction, a1))))

View(db_ASC_JEFFE_Confusion_Morph_matrix_matched$table)
prop.table(db_ASC_JEFFE_Confusion_Morph_matrix_matched$table)

?caret::confusionMatrix

# table
# sum(db_ASC_JEFFE_Confusion_Morph_table_matched$Freq)/4


db_ASC_JEFFE_Confusion_Morph_table_matched<- as.data.frame(db_ASC_JEFFE_Confusion_Morph_matrix_matched$table)
db_ASC_JEFFE_Confusion_Morph_table_matched$Prop <- db_ASC_JEFFE_Confusion_Morph_table_matched$Freq/77.75#divide the 

total 
View(db_ASC_JEFFE_Confusion_Morph_table_matched)
# by 6?
# 576/6
sum(db_ASC_JEFFE_Confusion_Morph_table_matched$Freq)/6

max(db_ASC_JEFFE_Confusion_Morph_table_matched$Prop)
# b1

db_ASC_JEFFE_Confusion_Morph_table_matched$Var2<- relevel(db_ASC_JEFFE_Confusion_Morph_table_matched$Var2, ref = "Neutral")

db_ASC_JEFFE_Confusion_Morph_table_matched%>%
  mutate(Freq_norm = (Freq-min(Freq))/(max(Freq)-min(Freq)))%>%
  filter(Var1!= "Neutral")%>%
ggplot(aes(Var1, Var2, fill = Freq_norm))+
  geom_tile()+
  scale_color_viridis_c(palette = 'Inferno')+
  theme_minimal()+  
  # scale_fill_gradient2()
  scale_fill_gradient2(low = "blue", high = "red",limit = c(0,1), space = "Lab", 
                       name="Pearson\nCorrelation")


```


NT


```{r}
db_NT_ADF_Confusion_Orig_matched<- subset(db_ASC_NT_matched_nosurp, db_ASC_NT_matched_nosurp$intensity_morph == 'ADFES_high_intensityOriginal' & db_ASC_NT_matched_nosurp$Group == 'NT')

db_NT_ADF_Confusion_Orig_matched

# confusion

db_NT_ADF_Confusion_Orig_matrix_matched <- (caret::confusionMatrix(table(factor(db_NT_ADF_Confusion_Orig_matched$Reference, a1), factor(db_NT_ADF_Confusion_Orig_matched$Prediction, a1))))

View(db_NT_ADF_Confusion_Orig_matrix_matched$table)
prop.table(db_NT_ADF_Confusion_Orig_matrix_matched$table)


?caret::confusionMatrix

# table
sum(db_NT_ADF_Confusion_Orig_table_matched$Freq)/4


db_NT_ADF_Confusion_Orig_table_matched<- as.data.frame(db_NT_ADF_Confusion_Orig_matrix_matched$table)
db_NT_ADF_Confusion_Orig_table_matched$Prop <- db_NT_ADF_Confusion_Orig_table_matched$Freq/242.4#divide the total 
View(db_NT_ADF_Confusion_Orig_table_matched)
# by 6?
# 576/6
sum(db_NT_ADF_Confusion_Orig_table_matched$Freq)/5

max(db_NT_ADF_Confusion_Orig_table_matched$Prop)

# b1
db_NT_ADF_Confusion_Orig_table_matched$Var2<- relevel(db_NT_ADF_Confusion_Orig_table_matched$Var2, ref = "Neutral")

db_NT_ADF_Confusion_Orig_table_matched%>%
  mutate(Freq_norm = (Freq-min(Freq))/(max(Freq)-min(Freq)))%>%
  filter(Var1 != "Neutral")%>%
ggplot(aes(Var1, Var2, fill = Freq))+
  geom_tile()+
  scale_color_viridis_c(palette = 'Inferno')+
  theme_minimal()+  
  scale_fill_gradient2()
  scale_fill_gradient2(low = "blue", high = "red",limit = c(0,1), space = "Lab", 
                       name="Pearson\nCorrelation")





```



Morph

```{r}
# Start with ADFES and ASC
db_NT_ADF_Confusion_Morph_matched<- subset(db_ASC_NT_matched_nosurp, db_ASC_NT_matched_nosurp$intensity_morph == 'ADFES_high_intensityMorph' & db_ASC_NT_matched_nosurp$Group == 'NT')

db_NT_ADF_Confusion_Morph_matched

# confusion

db_NT_ADF_Confusion_Morph_matrix_matched <- (caret::confusionMatrix(table(factor(db_NT_ADF_Confusion_Morph_matched$Reference, a1), factor(db_NT_ADF_Confusion_Morph_matched$Prediction, a1))))

View(db_NT_ADF_Confusion_Morph_matrix_matched$table)
prop.table(db_NT_ADF_Confusion_Morph_matrix_matched$table)


?caret::confusionMatrix

# table
sum(db_NT_ADF_Confusion_Morph_table_matched$Freq)/7


db_NT_ADF_Confusion_Morph_table_matched<- as.data.frame(db_NT_ADF_Confusion_Morph_matrix_matched$table)
db_NT_ADF_Confusion_Morph_table_matched$Prop <- db_NT_ADF_Confusion_Morph_table_matched$Freq/52.83333#divide the total 
View(db_NT_ADF_Confusion_Morph_table_matched)
# by 6?
# 576/6
sum(db_NT_ADF_Confusion_Morph_table_matched$Freq)/6

max(db_NT_ADF_Confusion_Morph_table_matched$Freq)
# b1
db_NT_ADF_Confusion_Morph_table_matched$Var1<- relevel(db_NT_ADF_Confusion_Morph_table_matched$Var1, ref ="Neutral" )
db_NT_ADF_Confusion_Morph_table_matched$Var2<- relevel(db_NT_ADF_Confusion_Morph_table_matched$Var2, ref ="Neutral" )

db_NT_ADF_Confusion_Morph_table_matched%>%
  mutate(Freq_norm = (Freq-min(Freq))/(max(Freq)-min(Freq)))%>%
  filter(Var1!= "Neutral")%>%
ggplot(aes(Var1, Var2, fill = Freq_norm))+

  geom_tile()+
  scale_color_viridis_c(palette = 'Inferno')+
  theme_minimal()+  
  scale_fill_gradient2()
  scale_fill_gradient2(low = "blue", high = "red",limit = c(0,1), space = "Lab", 
                       name="Pearson\nCorrelation")






```

JEFFE

```{r}
# Start with ADFES and ASC
db_ASC_JEFFE_Confusion_Orig_matched<- subset(db_ASC_NT_matched_nosurp, db_ASC_NT_matched_nosurp$intensity_morph == 'JEFFE_low_intensityOriginal' & db_ASC_NT_matched_nosurp$Group == 'NT')

db_ASC_JEFFE_Confusion_Orig_matched

# confusion

db_ASC_JEFFE_Confusion_Orig_matrix_matched <- (caret::confusionMatrix(table(factor(db_ASC_JEFFE_Confusion_Orig_matched$Reference, a1), factor(db_ASC_JEFFE_Confusion_Orig_matched$Prediction, a1))))

View(db_ASC_JEFFE_Confusion_Orig_matrix_matched$table)
prop.table(db_ASC_JEFFE_Confusion_Orig_matrix_matched$table)

?caret::confusionMatrix

# table
# sum(db_ASC_JEFFE_Confusion_Orig_table_matched$Freq)/4


db_ASC_JEFFE_Confusion_Orig_table_matched<- as.data.frame(db_ASC_JEFFE_Confusion_Orig_matrix_matched$table)
db_ASC_JEFFE_Confusion_Orig_table_matched$Prop <- db_ASC_JEFFE_Confusion_Orig_table_matched$Freq/77.75#divide the 

total 
View(db_ASC_JEFFE_Confusion_Orig_table_matched)
# by 6?
# 576/6
sum(db_ASC_JEFFE_Confusion_Orig_table_matched$Freq)/6

max(db_ASC_JEFFE_Confusion_Orig_table_matched$Prop)
# b1

db_ASC_JEFFE_Confusion_Orig_table_matched$Var2<- relevel(db_ASC_JEFFE_Confusion_Orig_table_matched$Var2, ref = "Neutral")

db_ASC_JEFFE_Confusion_Orig_table_matched%>%
  mutate(Freq_norm = (Freq-min(Freq))/(max(Freq)-min(Freq)))%>%
  filter(Var1!= "Neutral")%>%
ggplot(aes(Var1, Var2, fill = Freq_norm))+
  geom_tile()+
  scale_color_viridis_c(palette = 'Inferno')+
  theme_minimal()+  
  # scale_fill_gradient2()
  scale_fill_gradient2(low = "blue", high = "red",limit = c(0,1), space = "Lab", 
                       name="Pearson\nCorrelation")


```


```{r}
db_ASC_JEFFE_Confusion_Morph_matched<- subset(db_ASC_NT_matched_nosurp, db_ASC_NT_matched_nosurp$intensity_morph == 'JEFFE_low_intensityMorph' & db_ASC_NT_matched_nosurp$Group == 'NT')

db_ASC_JEFFE_Confusion_Morph_matched

# confusion

db_ASC_JEFFE_Confusion_Morph_matrix_matched <- (caret::confusionMatrix(table(factor(db_ASC_JEFFE_Confusion_Morph_matched$Reference, a1), factor(db_ASC_JEFFE_Confusion_Morph_matched$Prediction, a1))))

View(db_ASC_JEFFE_Confusion_Morph_matrix_matched$table)
prop.table(db_ASC_JEFFE_Confusion_Morph_matrix_matched$table)

?caret::confusionMatrix

# table
# sum(db_ASC_JEFFE_Confusion_Morph_table_matched$Freq)/4


db_ASC_JEFFE_Confusion_Morph_table_matched<- as.data.frame(db_ASC_JEFFE_Confusion_Morph_matrix_matched$table)
db_ASC_JEFFE_Confusion_Morph_table_matched$Prop <- db_ASC_JEFFE_Confusion_Morph_table_matched$Freq/77.75#divide the 

total 
View(db_ASC_JEFFE_Confusion_Morph_table_matched)
# by 6?
# 576/6
sum(db_ASC_JEFFE_Confusion_Morph_table_matched$Freq)/6

max(db_ASC_JEFFE_Confusion_Morph_table_matched$Prop)
# b1

db_ASC_JEFFE_Confusion_Morph_table_matched$Var2<- relevel(db_ASC_JEFFE_Confusion_Morph_table_matched$Var2, ref = "Neutral")

db_ASC_JEFFE_Confusion_Morph_table_matched%>%
  mutate(Freq_norm = (Freq-min(Freq))/(max(Freq)-min(Freq)))%>%
  filter(Var1!= "Neutral")%>%
ggplot(aes(Var1, Var2, fill = Freq_norm))+
  geom_tile()+
  scale_color_viridis_c(palette = 'Inferno')+
  theme_minimal()+  
  # scale_fill_gradient2()
  scale_fill_gradient2(low = "blue", high = "red",limit = c(0,1), space = "Lab", 
                       name="Pearson\nCorrelation")


```



Correlating perfromance across datatasets and video type, ignore emotion
Cant do CFA because of numbers



```{r}
View(db_NT_lmer)
library(dplyr)

db_NT_lmer_correlation<- dplyr::select(db_NT_lmer, c(ParticipantPrivateID, Video, VideoType, DATASET, Emotion,
                                              AnswerRating_Intensity, AnswerRating_Valence, 
                                              AnswerRating_Naturality, Recognacc,
                                              # Answe
                                              ReactionTime_Recognition,ReactionTime_Intensity,
                                              ReactionTime_Valence, ReactionTime_Naturality,
                                              ReactionTime_Recognition_outlier,
                                              ReactionTime_Intensity_outlier,
                                              ReactionTime_Naturality_outlier,
                                              ReactionTime_Valence_outlier, uniquestimid, Actor_ID,
                                              matched,AQ_score_total, TAS_score_total))

View(db_NT_lmer_correlation)
# study 2 correlations
db_ASC_lmer_correlation<- db_ASC_NT%>%
  filter(Group == "ASC")%>%
  select(c(ParticipantPrivateID, Video, VideoType, DATASET, Emotion,
                                              AnswerRating_Intensity, AnswerRating_Valence, 
                                              AnswerRating_Naturality, Recognacc,
                                              # Answe
                                              ReactionTime_Recognition,ReactionTime_Intensity,
                                              ReactionTime_Valence, ReactionTime_Naturality,
                                              # ReactionTime_Recognition_outlier,
                                              # ReactionTime_Intensity_outlier,
                                              # ReactionTime_Naturality_outlier,
                                              # ReactionTime_Valence_outlier, 
                       uniquestimid, Actor_ID,
                                              matched,AQ_score_total, TAS_score_total))

View(db_ASC_lmer_correlation)


db_NT_lmer_correlation_morph<- subset(db_NT_lmer_correlation, db_NT_lmer_correlation$VideoType == "Morph")
db_NT_lmer_correlation_orig<- subset(db_NT_lmer_correlation, db_NT_lmer_correlation$VideoType != "Morph")

# study 2
db_ASC_lmer_correlation_morph<- subset(db_ASC_lmer_correlation, db_ASC_lmer_correlation$VideoType == "Morph")
db_ASC_lmer_correlation_orig<- subset(db_ASC_lmer_correlation, db_ASC_lmer_correlation$VideoType != "Morph")

# This one only keeps the matched
db_NT_lmer_correlation_merged<- left_join(db_NT_lmer_correlation_orig, db_NT_lmer_correlation_morph, by = c("ParticipantPrivateID", "DATASET", "Emotion", "uniquestimid", "Actor_ID", "matched"))


db_ASC_lmer_correlation_merged<- left_join(db_ASC_lmer_correlation_orig, db_ASC_lmer_correlation_morph, by = c("ParticipantPrivateID", "DATASET", "Emotion", "uniquestimid", "Actor_ID", "matched"))

View(db_ASC_lmer_correlation_merged)

# 
# # This one only keeps the matched
# db_NT_lmer_correlation_merged2<- left_join(db_NT_lmer_correlation_orig, db_NT_lmer_correlation_morph, by = c("ParticipantPrivateID", "DATASET", "Emotion", "uniquestimid", "Actor_ID"))
install.packages("ltm")
library(ltm)

unique(db_NT_lmer$DATASET)
unique(db_NT_lmer$VideoType)

unique(db_NT_lmer$Video)

db_NT_lmer_correlation_merged$matched
View(db_NT_lmer_correlation_merged)

# compute the correlations
db_NT_lmer_correlation_merged3<-  db_NT_lmer_correlation_merged%>%
  filter(matched == "YES")%>%
  group_by(ParticipantPrivateID, DATASET)%>%
  mutate(intensity_morph_orig_cor = cor(AnswerRating_Intensity.x, AnswerRating_Intensity.y, "complete.obs"))%>%
  mutate(valence_morph_orig_cor = cor(AnswerRating_Valence.x, AnswerRating_Valence.y, use = "complete.obs"))%>%
  mutate(naturality_morph_orig_cor = cor(AnswerRating_Naturality.x, AnswerRating_Naturality.y,use= "complete.obs"))%>%
  mutate(acc_morph_orig_cor = biserial.cor(Recognacc.x, Recognacc.y, use = "complete.obs"))%>%
  mutate(RT_intensity_morph_orig_cor = cor(ReactionTime_Intensity.x, ReactionTime_Intensity.y))%>%
  mutate(RT_valence_morph_orig_cor = cor(ReactionTime_Valence.x, ReactionTime_Valence.y))%>%
  mutate(RT_naturality_morph_orig_cor = cor(ReactionTime_Naturality.x, ReactionTime_Naturality.y))%>%
  mutate(RT_recogn = cor(ReactionTime_Recognition.x, ReactionTime_Recognition.y))


# study 2
library(ltm)
db_ASC_lmer_correlation_merged3<-  db_ASC_lmer_correlation_merged%>%
  filter(matched == "YES")%>%
  group_by(ParticipantPrivateID, DATASET)%>%
  mutate(intensity_morph_orig_cor = cor(AnswerRating_Intensity.x, AnswerRating_Intensity.y, "complete.obs"))%>%
  mutate(valence_morph_orig_cor = cor(AnswerRating_Valence.x, AnswerRating_Valence.y, use = "complete.obs"))%>%
  mutate(naturality_morph_orig_cor = cor(AnswerRating_Naturality.x, AnswerRating_Naturality.y,use= "complete.obs"))%>%
  mutate(acc_morph_orig_cor = biserial.cor(Recognacc.x, Recognacc.y, use = "complete.obs"))

View(db_NT_lmer_correlation_merged3)
db_NT_lmer_correlation_merged3$Group<- "NT"
db_ASC_lmer_correlation_merged3$Group <- "ASC"
# intensity

bind_rows(db_NT_lmer_correlation_merged3, db_ASC_lmer_correlation_merged3)%>%
  group_by(ParticipantPrivateID, DATASET, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(x = DATASET, y = intensity_morph_orig_cor, colour = Group))+
  
  # geom_jitter(width = .2, alpha = .2,)+
  # geom_boxplot()+
  # stat_summary(aes(group = ParticipantPrivateID), geom = 'line', alpha = .2)+
  # geom_boxplot(width = .2)+
  stat_summary(geom = 'pointrange', colour = 'red', size = 1)
  facet_grid()
  

  
  library(psych)
  
bind_rows(db_NT_lmer_correlation_merged3, db_ASC_lmer_correlation_merged3)%>%
  group_by(ParticipantPrivateID, DATASET, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(x = AQ_score_total.x, y = fisherz(intensity_morph_orig_cor)))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  facet_grid(~Group)


bind_rows(db_NT_lmer_correlation_merged3, db_ASC_lmer_correlation_merged3)%>%
  group_by(ParticipantPrivateID, DATASET, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(x = DATASET, y = fisherz(valence_morph_orig_cor), colour = Group))+
  geom_jitter(width = .2, alpha = .2)+
  # geom_boxplot()+
  stat_summary(aes(group = ParticipantPrivateID), geom = 'line', alpha = .2)+
  # geom_boxplot(width = .2)+
  stat_summary(geom = 'pointrange', colour = 'red', size = 1)
  facet_grid(~DATASET)
  
  
  library(psych)
db_NT_lmer_correlation_merged3%>%
  group_by(ParticipantPrivateID, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(x = TAS_score_total.x, y = fisherz(valence_morph_orig_cor)))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)


# naturality

bind_rows(db_NT_lmer_correlation_merged3, db_ASC_lmer_correlation_merged3)%>%
  group_by(ParticipantPrivateID, DATASET, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(x = DATASET, y = fisherz(naturality_morph_orig_cor), colour = Group))+
  # geom_jitter(width = .2, alpha = .2)+
  # geom_boxplot()+
  stat_summary(aes(group = ParticipantPrivateID), geom = 'line', alpha = .2)+
  stat_summary( geom = 'pointrange', position = position_dodge(1))+
  # geom_boxplot(width = .2)+
  # geom_violin()+
    geom_dotplot(binaxis='y', stackdir='center', dotsize=1, position = position_dodge(1))+
    stat_summary(geom = 'linerange', colour = 'red')

```

```{r}
  library(psych)


# accuraccy

bind_rows(db_NT_lmer_correlation_merged3, db_ASC_lmer_correlation_merged3)%>%
  group_by(ParticipantPrivateID, DATASET, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(x = DATASET, y = acc_morph_orig_cor, colour = Group))+
  # geom_jitter(width = .2, alpha = .2)+
  geom_boxplot()+
  # stat_summary(aes(group = ParticipantPrivateID), geom = 'line', alpha = .2)+
  # geom_boxplot(width = .2)+
  # geom_violin()+
    # geom_dotplot(binaxis='y', stackdir='center', dotsize=1)+
    stat_summary(aes(group =Group), geom = 'pointrange')

```
 
```{r} 
  library(psych)
db_NT_lmer_correlation_merged3%>%
  group_by(ParticipantPrivateID, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(x = TAS_score_total.x, y = fisherz(acc_morph_orig_cor)))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)


# reaction time
# accuraccy

db_NT_lmer_correlation_merged3 %>%
  group_by(ParticipantPrivateID, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(x = DATASET, y = RT_recogn))+
  # geom_jitter(width = .2, alpha = .2)+
  # geom_boxplot()+
  stat_summary(aes(group = ParticipantPrivateID), geom = 'line', alpha = .2)+
  # geom_boxplot(width = .2)+
  # geom_violin()+
    # geom_dotplot(binaxis='y', stackdir='center', dotsize=1)+
    stat_summary(geom = 'linerange', colour = 'red')
  
db_NT_lmer_correlation_merged3 %>%
  group_by(ParticipantPrivateID, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(x = DATASET, y = RT_intensity_morph_orig_cor))+
  # geom_jitter(width = .2, alpha = .2)+
  # geom_boxplot()+
  stat_summary(aes(group = ParticipantPrivateID), geom = 'line', alpha = .2)+
  # geom_boxplot(width = .2)+
  # geom_violin()+
    geom_dotplot(binaxis='y', stackdir='center', dotsize=1)+
    stat_summary(geom = 'linerange', colour = 'red')

db_NT_lmer_correlation_merged3 %>%
  group_by(ParticipantPrivateID, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(x = DATASET, y = RT_valence_morph_orig_cor))+
  # geom_jitter(width = .2, alpha = .2)+
  # geom_boxplot()+
  stat_summary(aes(group = ParticipantPrivateID), geom = 'line', alpha = .2)+
  # geom_boxplot(width = .2)+
  # geom_violin()+
    geom_dotplot(binaxis='y', stackdir='center', dotsize=1)+
    stat_summary(geom = 'linerange', colour = 'red')


db_NT_lmer_correlation_merged3 %>%
  group_by(ParticipantPrivateID, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(x = DATASET, y = RT_naturality_morph_orig_cor))+
  # geom_jitter(width = .2, alpha = .2)+
  # geom_boxplot()+
  stat_summary(aes(group = ParticipantPrivateID), geom = 'line', alpha = .2)+
  # geom_boxplot(width = .2)+
  # geom_violin()+
    geom_dotplot(binaxis='y', stackdir='center', dotsize=1)+
    stat_summary(geom = 'linerange', colour = 'red')

is.numeric(cor(db_NT_lmer_correlation_merged3$Recognacc.x, db_NT_lmer_correlation_merged3$Recognacc.y, use = 'complete.obs'))
db_NT_lmer_correlation_merged3_agg<- db_NT_lmer_correlation_merged3 %>%
  group_by(ParticipantPrivateID, DATASET)%>%
  # mutate(acc_morph_orig_cor = as.n)
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  mutate(intensity_morph_orig_cor_z = fisherz(intensity_morph_orig_cor))%>%
  mutate(valence_morph_orig_cor_z = fisherz(valence_morph_orig_cor))%>%
  mutate(naturality_morph_orig_cor_z = fisherz(naturality_morph_orig_cor))%>%
  mutate(acc_morph_orig_cor_z = fisherz(acc_morph_orig_cor))

View(db_NT_lmer_correlation_merged3_agg)

db_NT_lmer_correlation_merged3_agg1<- db_NT_lmer_correlation_merged3 %>%
  group_by(ParticipantPrivateID)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  mutate(intensity_morph_orig_cor_z = fisherz(intensity_morph_orig_cor))%>%
  mutate(valence_morph_orig_cor_z = fisherz(valence_morph_orig_cor))%>%
  mutate(naturality_morph_orig_cor_z = fisherz(naturality_morph_orig_cor))%>%
  mutate(acc_morph_orig_cor_z = fisherz(acc_morph_orig_cor))


# is performance on morph correlated with performance on orginal
# Intensity
t.test(db_NT_lmer_correlation_merged3_agg1$intensity_morph_orig_cor_z, mu = 0, paired = FALSE)

fisherz2r(0.3038802)
0.2948595^2

```


analisys correlations
```{r}
library(afex)

db_ASC_NT_lmer_correlation_merged<- bind_rows(db_NT_lmer_correlation_merged3, db_ASC_lmer_correlation_merged3)%>%
  group_by(ParticipantPrivateID, DATASET, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)



# create fishers
db_ASC_NT_lmer_correlation_merged_aggbypp<- 
db_ASC_NT_lmer_correlation_merged%>%
  group_by(ParticipantPrivateID, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  mutate(intensity_morph_orig_cor_z = fisherz(intensity_morph_orig_cor))%>%
  mutate(valence_morph_orig_cor_z = fisherz(valence_morph_orig_cor))%>%
  mutate(naturality_morph_orig_cor_z = fisherz(naturality_morph_orig_cor))%>%
  mutate(acc_morph_orig_cor_z = fisherz(acc_morph_orig_cor))

db_ASC_NT_lmer_correlation_merged_aggbypp_ds<- 
db_ASC_NT_lmer_correlation_merged%>%
  group_by(ParticipantPrivateID,Group,DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  mutate(intensity_morph_orig_cor_z = fisherz(intensity_morph_orig_cor))%>%
  mutate(valence_morph_orig_cor_z = fisherz(valence_morph_orig_cor))%>%
  mutate(naturality_morph_orig_cor_z = fisherz(naturality_morph_orig_cor))%>%
  mutate(acc_morph_orig_cor_z = fisherz(acc_morph_orig_cor))






aov_ez(id = "ParticipantPrivateID",
       data = db_NT_lmer_correlation_merged3_agg,
       dv = "intensity_morph_orig_cor_z",
       between = NULL,
       within = "DATASET")

# study 2



# for matched iq
nrow(db_ASC_NT_lmer_correlation_merged_aggbypp_ds)
nrow(db_asc_nt_pp_matching)

db_ASC_NT_lmer_correlation_merged_aggbypp_ds_iq_matched<- left_join(db_asc_nt_pp_matching, db_ASC_NT_lmer_correlation_merged_aggbypp_ds, by = "ParticipantPrivateID")
nrow(db_ASC_NT_lmer_correlation_merged_aggbypp_ds_iq_matched)


db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched<- left_join(db_asc_nt_pp_matching, db_ASC_NT_lmer_correlation_merged_aggbypp, by = "ParticipantPrivateID")

View(db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched)

# by pp and dataset
aov_ez(id = "ParticipantPrivateID",
       data = db_ASC_NT_lmer_correlation_merged_aggbypp_ds,
       dv = "intensity_morph_orig_cor_z",
       between = "Group",
       within = "DATASET",
       )


# iq gender and age matched
View(db_ASC_NT_lmer_correlation_merged_aggbypp_ds_iq_matched)
table(is.na(db_ASC_NT_lmer_correlation_merged_aggbypp_ds_iq_matched$intensity_morph_orig_cor_z))

aov_ez(id = "ParticipantPrivateID",
       data = subset(db_ASC_NT_lmer_correlation_merged_aggbypp_ds_iq_matched, !is.na(intensity_morph_orig_cor_z)),
       dv = "intensity_morph_orig_cor_z",
       between = "Group.x",
       within = "DATASET")


aov_ez(id = "ParticipantPrivateID",
       data = db_ASC_NT_lmer_correlation_merged_aggbypp,
       dv = "intensity_morph_orig_cor_z",
       between = "Group",
       within = NULL,
       ) 

# ig, age and gender matched
aov_ez(id = "ParticipantPrivateID",
       data = db_ASC_NT_lmer_correlation_merged_aggbypp_ds_iq_matched,
       dv = "intensity_morph_orig_cor_z",
       between = "Group.x",
       within = NULL,
       ) 




group_by(Group)%>%
  summarise(n = n())
# t tests on the correlations
t.test( db_ASC_NT_lmer_correlation_merged_aggbypp$intensity_morph_orig_cor_z, mu = 0, paired = FALSE)
# matched iq age sex, iq - conisntent with original results
t.test( db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched$intensity_morph_orig_cor_z, mu = 0, paired = FALSE)

# just on ASC vs NT separtellt
t.test(subset(db_ASC_NT_lmer_correlation_merged_aggbypp_, db_ASC_NT_lmer_correlation_merged_aggbypp$Group == 'ASC')$intensity_morph_orig_cor_z, mu = 0, paired = FALSE)

t.test(subset(db_ASC_NT_lmer_correlation_merged_aggbypp, db_ASC_NT_lmer_correlation_merged_aggbypp$Group == 'NT')$intensity_morph_orig_cor_z, mu = 0, paired = FALSE)
# no differences between groups
# NT matched
t.test(subset(db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched, db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched$Group.x == 'NT')$intensity_morph_orig_cor_z, mu = 0, paired = FALSE)
fisherz2r(0.307055 )


fisherz2r(0.3013086) NT
```

```{r}
db_NT_lmer_correlation_merged3_agg1$DATASET<- "All"

left_join(db_NT_lmer_correlation_merged3_agg, db_NT_lmer_correlation_merged3_agg1, 
          by = 'ParticipantPrivateID')
paper_plots$cor_morph_orig_int<- bind_rows(db_NT_lmer_correlation_merged3_agg, db_NT_lmer_correlation_merged3_agg1)%>%
    mutate(DATASET = as.factor(DATASET))%>%
    mutate(DATASET = relevel(DATASET, ref = 'All'))%>%
    group_by(DATASET)%>%
    mutate(mean_int_cor = mean(intensity_morph_orig_cor))%>%
  ggplot(aes(DATASET,intensity_morph_orig_cor, colour = DATASET))+
  geom_line(aes(group = ParticipantPrivateID), colour = 'gray75', size = .1)+
  # geom_violin(trim = FALSE, width = .5)+
    geom_point(pch = 21, size = 3, alpha = .7)+
    geom_boxplot(aes(y = mean_int_cor), width = .2, size = 1, colour = 'darkred')+
    stat_summary(geom = 'point', size = 5, colour = "darkred")+
    theme_classic()+
    ylab("Intensity Corr. \n Morph and Original")
  
  p$graphstyle1 <-  theme(#base plot theme
  # axis
  axis.line.y = element_line(),
  axis.line.x = element_line(),
  axis.text.x = element_text(size = 15+(sf+.5), family = "sans", colour = "black", hjust = .8), #angle = 45,
  axis.text.y = element_text(size = 15+(sf+.5), family = "sans", colour = "black"),
  #axis.ticks = element_blank(),
  #axis.text.y = element_text(size= 18, family = "Arial Narrow", colour="black"),
  axis.title.y=element_text(size = 16*(sf+.3), margin=margin(0,5,0,0)),
  axis.title.x=element_text(size = 16*(sf+.7), margin=margin(0,5,0,0)),
  
  # strips
  strip.background = element_blank(),
  strip.text.x = element_text(size = 12*(sf+.5),  colour = "black"),
  strip.text.y = element_text(size = 12*(sf+.5),  colour = "black"),
  
  # panel
  # panel.background = element_rect(colour = NA),
  # plot.background = element_rect(colour = NA),
  # panel.border = element_rect(colour = NA),
  # panel.border = element_blank(),
  # panel.grid.major = element_blank(),
  # panel.grid.minor = element_blank(),
  # panel.background = element_blank(),
  
  # legend
  # legend.title = element_text(size = 10*(sf+.3)),
  legend.position = "top",
  legend.direction = "horizontal",
  #legend.key.size = unit(.5, "cm"),
  #legend.text = element_text(size = 10*sf),
  legend.title=element_blank(),
  #legend.text = element_blank(),
  legend.key = element_rect(colour = "transparent", fill="transparent"),
  # text
  text=element_text(size = 16*(sf+.4), family = "sans"))
  
  
paper_plots$cor_morph_orig_int<- paper_plots$cor_morph_orig_int+ 
  p$graphstyle1+
  scale_y_continuous(breaks = c(-1, -.5, 0, .5, 1), limits = c(-1,1))+
  scale_color_brewer(palette = "Dark2")
paper_plots$cor_morph_orig_int
```

# there is no diffrence by dataset, altough there is a trend for JEFFE to show a stronger correlation
```{r}
# Valence
t.test(db_NT_lmer_correlation_merged3_agg1$valence_morph_orig_cor_z, mu = 0, paired = FALSE)
# significant



fisherz2r(0.979086 )

library(afex)
View(db_NT_lmer_correlation_merged3_agg)

anova_cor<- aov_ez(id = "ParticipantPrivateID",
       data = subset(db_NT_lmer_correlation_merged3_agg, db_NT_lmer_correlation_merged3_agg$valence_morph_orig_cor_z != 'Inf'),
       dv = "valence_morph_orig_cor_z",
       between = NULL,
       within = "DATASET")

emmeans(anova_cor, ~DATASET)


# study 2

emmeans(aov_ez(id = "ParticipantPrivateID",
       data = subset(db_ASC_NT_lmer_correlation_merged_aggbypp_ds, db_ASC_NT_lmer_correlation_merged_aggbypp_ds$valence_morph_orig_cor_z != 'Inf'),
       dv = "valence_morph_orig_cor_z",
       between = "Group",
       within = "DATASET"), pairwise~DATASET)


# iq matched valence by group and dataset

emmeans(aov_ez(id = "ParticipantPrivateID",
       data = subset(db_ASC_NT_lmer_correlation_merged_aggbypp_ds_iq_matched, db_ASC_NT_lmer_correlation_merged_aggbypp_ds_iq_matched$valence_morph_orig_cor_z != 'Inf'),
       dv = "valence_morph_orig_cor_z",
       between = "Group.x",
       within = "DATASET"), pairwise~DATASET) #consistent


# just grop collapsing dataset
aov_ez(id = "ParticipantPrivateID",
       data = subset(db_ASC_NT_lmer_correlation_merged_aggbypp, db_ASC_NT_lmer_correlation_merged_aggbypp$valence_morph_orig_cor_z != 'Inf'),
       dv = "valence_morph_orig_cor_z",
       between = "Group",
       within = NULL)


# matched iq group collapsing dataset
aov_ez(id = "ParticipantPrivateID",
       data = subset(db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched, db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched$valence_morph_orig_cor_z != 'Inf'),
       dv = "valence_morph_orig_cor_z",
       between = "Group.x",
       within = NULL) #consistent

t.test(db_ASC_NT_lmer_correlation_merged_aggbypp$valence_morph_orig_cor_z, mu = 0, paired = FALSE)
# matched iq
t.test(db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched$valence_morph_orig_cor_z, mu = 0, paired = FALSE) #consistent

fisherz2r(1.011674 )^2

t.test(subset(db_ASC_NT_lmer_correlation_merged_aggbypp, db_ASC_NT_lmer_correlation_merged_aggbypp$Group == "ASC") $valence_morph_orig_cor_z, mu = 0, paired = FALSE)
```

```{r}
emmeansdb_NT_lmer_correlation_merged3_agg%>%
  ggplot(aes(DATASET,valence_morph_orig_cor_z))+
  stat_summary(geom = 'errorbar') # there is a differnce between datasets, ADFES valence ratings are more correlated across morph and orginal than JEFFE

# valence
paper_plots$cor_morph_orig_val<- bind_rows(db_NT_lmer_correlation_merged3_agg, db_NT_lmer_correlation_merged3_agg1)%>%
    mutate(DATASET = as.factor(DATASET))%>%
    mutate(DATASET = relevel(DATASET, ref = 'All'))%>%
    group_by(DATASET)%>%
    mutate(mean_val_cor = mean(valence_morph_orig_cor))%>%
  ggplot(aes(DATASET,valence_morph_orig_cor, colour = DATASET))+
  geom_line(aes(group = ParticipantPrivateID), colour = 'gray75', size = .1)+
  # geom_violin(trim = FALSE, width = .5)+
    geom_point(pch = 21, size = 3, alpha = .7)+
    geom_boxplot(aes(y = mean_val_cor), width = .2, size = 1, colour = 'darkred')+
    stat_summary(geom = 'point', size = 5, colour = "darkred")+
    theme_classic()+
    ylab("Valence Corr. \n Morph and Original")
  
  
paper_plots$cor_morph_orig_val<- paper_plots$cor_morph_orig_val+ 
  p$graphstyle1+
  scale_y_continuous(breaks = c(-1, -.5, 0, .5, 1), limits = c(-1,1))+
  scale_color_brewer(palette = "Dark2")
paper_plots$cor_morph_orig_val


study2_plots$Valence_cor<- bind_rows(db_ASC_NT_lmer_correlation_merged_aggbypp_ds, db_ASC_NT_lmer_correlation_merged_aggbypp)%>%
    mutate(DATASET = as.factor(DATASET))%>%
    mutate(DATASET = relevel(DATASET, ref = 'Global'))%>%
    group_by(DATASET, Group)%>%
    mutate(mean_val_cor = mean(valence_morph_orig_cor))%>%
  ggplot(aes(DATASET,valence_morph_orig_cor, colour = DATASET))+
  geom_line(aes(group = ParticipantPrivateID), colour = 'gray75', size = .1)+
  # geom_violin(trim = FALSE, width = .5)+
    geom_point(pch = 21, size = 3, alpha = .7)+
    geom_boxplot(aes(y = mean_val_cor), width = .2, size = 1, colour = 'darkred')+
    stat_summary(geom = 'point', size = 5, colour = "darkred")+
    theme_classic()+
    ylab("Valence Corr. \n Morph and Original")+
  facet_grid(~Group)

study2_plots$Valence_cor<- 
study2_plots$Valence_cor+ 
  p$graphstyle1+
  scale_y_continuous(breaks = c(-1, 0, 1), limits = c(-1,1))+
  scale_color_brewer(palette = "Dark2")

study2_plots$Valence_cor

```

# naturality
```{r}
t.test(db_NT_lmer_correlation_merged3_agg1$naturality_morph_orig_cor_z, mu = 0, paired = FALSE)
# significant
fisherz2r(0.2183931 )





library(afex)
View(db_NT_lmer_correlation_merged3_agg)

emmeans(aov_ez(id = "ParticipantPrivateID",
       data = db_NT_lmer_correlation_merged3_agg,
       # data = subset(db_NT_lmer_correlation_merged3_agg, db_NT_lmer_correlation_merged3_agg$valence_morph_orig_cor_z != 'Inf'),
       dv = "naturality_morph_orig_cor_z",
       between = NULL,
       within = "DATASET"), ~ DATASET)


# study 2

emmeans(aov_ez(id = "ParticipantPrivateID",
       data = db_ASC_NT_lmer_correlation_merged_aggbypp_ds,
       # data = subset(db_NT_lmer_correlation_merged3_agg, db_NT_lmer_correlation_merged3_agg$valence_morph_orig_cor_z != 'Inf'),
       dv = "naturality_morph_orig_cor_z",
       between = "Group",
       within = "DATASET"), pairwise~DATASET)

# IQ matched
emmeans(aov_ez(id = "ParticipantPrivateID",
       data = subset(db_ASC_NT_lmer_correlation_merged_aggbypp_ds_iq_matched, !is.na(naturality_morph_orig_cor_z)),
       # data = subset(db_NT_lmer_correlation_merged3_agg, db_NT_lmer_correlation_merged3_agg$valence_morph_orig_cor_z != 'Inf'),
       dv = "naturality_morph_orig_cor_z",
       between = "Group.x",
       within = "DATASET"), pairwise~DATASET)



aov_ez(id = "ParticipantPrivateID",
       data = db_ASC_NT_lmer_correlation_merged_aggbypp,
       # data = subset(db_NT_lmer_correlation_merged3_agg, db_NT_lmer_correlation_merged3_agg$valence_morph_orig_cor_z != 'Inf'),
       dv = "naturality_morph_orig_cor_z",
       between = "Group",
       within = NULL)


# matched IQ
aov_ez(id = "ParticipantPrivateID",
       data = subset(db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched, !is.na(naturality_morph_orig_cor_z)),
       # data = subset(db_NT_lmer_correlation_merged3_agg, db_NT_lmer_correlation_merged3_agg$valence_morph_orig_cor_z != 'Inf'),
       dv = "naturality_morph_orig_cor_z",
       between = "Group.x",
       within = NULL)

t.test(db_ASC_NT_lmer_correlation_merged_aggbypp$naturality_morph_orig_cor_z, mu = 0, paired = FALSE)
fisherz2r(0.2141998 )

t.test(db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched$naturality_morph_orig_cor_z, mu = 0, paired = FALSE)
fisherz2r(0.2141998 )


t.test(subset(db_ASC_NT_lmer_correlation_merged_aggbypp, db_ASC_NT_lmer_correlation_merged_aggbypp$Group == "NT") $naturality_morph_orig_cor_z, mu = 0, paired = FALSE)
```

```
```{r}
db_NT_lmer_correlation_merged3_agg%>%
  ggplot(aes(DATASET,naturality_morph_orig_cor_z))+
  stat_summary(geom = 'errorbar') # there is a differnce between datasets, ADFES naturality ratings ratings are more correlated across morph and orginal than JEFFE

# Naturality_patchwork
# valence

paper_plots$cor_morph_orig_nat<- bind_rows(db_NT_lmer_correlation_merged3_agg, db_NT_lmer_correlation_merged3_agg1)%>%
    mutate(DATASET = as.factor(DATASET))%>%
    mutate(DATASET = relevel(DATASET, ref = 'All'))%>%
    group_by(DATASET)%>%
    mutate(mean_nat_cor = mean(naturality_morph_orig_cor))%>%
  ggplot(aes(DATASET,naturality_morph_orig_cor, colour = DATASET))+
  geom_line(aes(group = ParticipantPrivateID), colour = 'gray75', size = .1)+
  # geom_violin(trim = FALSE, width = .5)+
    geom_point(pch = 21, size = 3, alpha = .7)+
    geom_boxplot(aes(y = mean_nat_cor), width = .2, size = 1, colour = 'darkred')+
    stat_summary(geom = 'point', size = 5, colour = "darkred")+
    theme_classic()+
    ylab("Naturality Corr. \n Morph and Original")
  
  
paper_plots$cor_morph_orig_nat<- paper_plots$cor_morph_orig_nat+ 
  p$graphstyle1+
  scale_y_continuous(breaks = c(-1, -.5, 0, .5, 1), limits = c(-1,1))+
  scale_color_brewer(palette = "Dark2")
paper_plots$cor_morph_orig_nat

```

# accuracy

```{r}
View(db_NT_lmer_correlation_merged3_agg1)
t.test(db_NT_lmer_correlation_merged3_agg1$acc_morph_orig_cor_z, mu = 0, paired = FALSE)
# significant but negative, the more accurate on one, the poorer o the other??

```
library(afex)
View(db_NT_lmer_correlation_merged3_agg)
```{r}
emmeans(aov_ez(id = "ParticipantPrivateID",
       # data = db_NT_lmer_correlation_merged3_agg,
       data = subset(db_NT_lmer_correlation_merged3_agg,
                     db_NT_lmer_correlation_merged3_agg$acc_morph_orig_cor_z != "NaN" &
                    db_NT_lmer_correlation_merged3_agg$acc_morph_orig_cor_z != "-Inf"),
       dv = "acc_morph_orig_cor_z",
       between = NULL,
       within = "DATASET"), ~DATASET)

db_NT_lmer_correlation_merged3_agg%>%
  ggplot(aes(DATASET, acc_morph_orig_cor_z))+
  stat_summary(geom = 'errorbar') # there is a differnce between datasets, ADFES naturality ratings ratings are more correlated across morph and orginal than JEFFE

# study 2
study2$aov_cor_acc<- aov_ez(id = "ParticipantPrivateID",
       # data = db_NT_lmer_correlation_merged3_agg,
       data = subset(db_ASC_NT_lmer_correlation_merged_aggbypp_ds,
                     db_ASC_NT_lmer_correlation_merged_aggbypp_ds$acc_morph_orig_cor_z != "NaN" &
                    db_ASC_NT_lmer_correlation_merged_aggbypp_ds$acc_morph_orig_cor_z != "-Inf" &
                      is.na(db_ASC_NT_lmer_correlation_merged_aggbypp_ds$acc_morph_orig_cor_z) ==FALSE),
       dv = "acc_morph_orig_cor_z",
       between = "Group",
       within = "DATASET")


# matched iq

aov_ez(id = "ParticipantPrivateID",
       # data = db_NT_lmer_correlation_merged3_agg,
       data = subset(db_ASC_NT_lmer_correlation_merged_aggbypp_ds_iq_matched,
                     db_ASC_NT_lmer_correlation_merged_aggbypp_ds_iq_matched$acc_morph_orig_cor_z != "NaN" &
                    db_ASC_NT_lmer_correlation_merged_aggbypp_ds_iq_matched$acc_morph_orig_cor_z != "-Inf"),
       dv = "acc_morph_orig_cor_z",
       between = "Group.x",
       within = "DATASET")

study2$aov_cor_acc

t.test(subset(db_ASC_NT_lmer_correlation_merged_aggbypp,
                     db_ASC_NT_lmer_correlation_merged_aggbypp$acc_morph_orig_cor_z != "NaN" &
                    db_ASC_NT_lmer_correlation_merged_aggbypp$acc_morph_orig_cor_z != "-Inf")$acc_morph_orig_cor_z, mu = 0, paired = FALSE)


# matched IQ
t.test(subset(db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched,
                     db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched$acc_morph_orig_cor_z != "NaN" &
                    db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched$acc_morph_orig_cor_z != "-Inf")$acc_morph_orig_cor_z, mu = 0, paired = FALSE)




t.test(subset(db_ASC_NT_lmer_correlation_merged_aggbypp,
                     db_ASC_NT_lmer_correlation_merged_aggbypp$acc_morph_orig_cor_z != "NaN" &
                    db_ASC_NT_lmer_correlation_merged_aggbypp$acc_morph_orig_cor_z != "-Inf" &db_ASC_NT_lmer_correlation_merged_aggbypp$Group == "ASC")$acc_morph_orig_cor_z, mu = 0, paired = FALSE)


# matched

t.test(subset(db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched,
                     db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched$acc_morph_orig_cor_z != "NaN" &
                    db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched$acc_morph_orig_cor_z != "-Inf" &db_ASC_NT_lmer_correlation_merged_aggbypp_iq_matched$Group == "ASC")$acc_morph_orig_cor_z, mu = 0, paired = FALSE)


fisherz2r(-0.3878028)
(-0.3694645)^2
emmeans(study2$aov_cor_acc, pairwise~Group|DATASET, adjust = "bonf")

db_ASC_NT_lmer_correlation_merged_aggbypp$DATASET <- "Global"

bind_rows(db_ASC_NT_lmer_correlation_merged_aggbypp_ds, db_ASC_NT_lmer_correlation_merged_aggbypp)%>%
    mutate(DATASET = as.factor(DATASET))%>%
    mutate(DATASET = relevel(DATASET, ref = 'Global'))%>%
    group_by(DATASET,Group)%>%
    mutate(mean_acc_cor = mean(acc_morph_orig_cor))%>%

# db_ASC_NT_lmer_correlation_merged_aggbypp_ds%>%
    # mutate(DATASET = as.factor(DATASET))%>%
    # mutate(DATASET = relevel(DATASET, ref = 'All'))%>%
    group_by(DATASET, Group)%>%
    mutate(mean_acc_cor = mean(acc_morph_orig_cor))%>%
  ggplot(aes(DATASET,acc_morph_orig_cor, colour = DATASET))+
  geom_line(aes(group = ParticipantPrivateID), colour = 'gray75', size = .1)+
  # geom_violin(trim = FALSE, width = .5)+
    geom_point(pch = 21, size = 3, alpha = .7, position = position_dodge(1))+
    geom_boxplot(aes(y = mean_acc_cor), width = .3, size = 1, colour = 'darkred', position = position_dodge(1))+
    stat_summary(geom = 'point', size = 5, colour = "darkred", position = position_dodge(1))+
    theme_classic()+
    ylab("Accuracy Corr. \n Morph and Original")+
  facet_grid(~Group)

```


CoS

plot ASC vs NT on accuracy

```{r}
unique(db_ASC_NT_2021$matched)

table(is.na(db_ASC_NT_2021$matched)


table(db_ASC_NT_mergeidmacth$matched_iq_age_gend)

db_ASC_NT_mergeidmacth %>%
  subset(!is.na(VideoType))%>%
  subset(DATASET == "ADFES")%>%
  group_by(ParticipantPrivateID, Group.x,VideoType,DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Group.x, Recognacc, color = Group.x))+
  # geom_jitter(width = .2, alpha = .2)+
  # geom_boxplot(alpha = .1)+
  stat_summary(geom = 'pointrange')+
  facet_grid(DATASET~VideoType)+
  ylim(.3,1)+
  theme_classic()+
  ggpubr::stat_compare_means()



matched_acc_by_gr<- glmer(Recognacc ~ Group.x * (VideoType + DATASET) + (1+DATASET| ParticipantPrivateID)
      +(1|Video), family = "binomial",
      data = db_ASC_NT_mergeidmacth)

interactions::cat_plot(matched_acc_by_gr, pred = Group.x, modx = DATASET, mod2= VideoType)

summary(matched_acc_by_gr)


db_ASC_NT_2021 %>%
  subset(is.na(matched))%>%
  group_by(ParticipantPrivateID, Group,matched)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

table(is.na(db_ASC_NT_mergeidmacth$TAS_score_total))


db_ASC_NT_mergeidmacth%>%
  subset(Group.x == "NT")
matched_acc_by_gr<- glmer(Recognacc ~ Group.x * (VideoType + DATASET) + (1+DATASET| ParticipantPrivateID)
      +(1|Video), family = "binomial",
      data = db_ASC_NT_mergeidmacth$TAS_score_total)
```



```{r}
# acc
paper_plots$cor_morph_orig_acc <-bind_rows(db_NT_lmer_correlation_merged3_agg, db_NT_lmer_correlation_merged3_agg1)%>%
    mutate(DATASET = as.factor(DATASET))%>%
    mutate(DATASET = relevel(DATASET, ref = 'All'))%>%
    group_by(DATASET)%>%
    mutate(mean_acc_cor = mean(acc_morph_orig_cor))%>%
  ggplot(aes(DATASET,acc_morph_orig_cor, colour = DATASET))+
  geom_line(aes(group = ParticipantPrivateID), colour = 'gray75', size = .1)+
  # geom_violin(trim = FALSE, width = .5)+
    geom_point(pch = 21, size = 3, alpha = .7)+
    geom_boxplot(aes(y = mean_acc_cor), width = .3, size = 1, colour = 'darkred')+
    stat_summary(geom = 'point', size = 5, colour = "darkred")+
    theme_classic()+
    ylab("Accuracy Corr. \n Morph and Original")
  
  
paper_plots$cor_morph_orig_acc<- paper_plots$cor_morph_orig_acc+ 
  p$graphstyle1+
  scale_y_continuous(breaks = c(-1, -.5, 0, .5, 1), limits = c(-1,1))+
  scale_color_brewer(palette = "Dark2")
paper_plots$cor_morph_orig_acc


paper_plots$cor_morph_orig_val
paper_plots$cor_morph_orig_acc

paper_plots$correlations_morph_orig<-
paper_plots$cor_morph_orig_val+  theme(legend.position = "none", axis.title.x = element_blank(),
                                     axis.text.x = element_blank())+
paper_plots$cor_morph_orig_int+  theme(legend.position = "none", axis.title.x = element_blank(),
                                     axis.text.x = element_blank(), axis.text.y = element_blank())+
paper_plots$cor_morph_orig_nat+  theme(legend.position = "none", axis.title.x = element_blank(), axis.text.y = element_blank())+
paper_plots$cor_morph_orig_acc+  theme(legend.position = "none", axis.title.x = element_blank())+
plot_layout(nrow = 2, ncol = 2)
            
paper_plots$correlations_morph_orig          
            guides = 'collect')& theme(legend.position = 'top')
  
ggsave("correlations_morph_orig.png", paper_plots$correlations_morph_orig, device = 'png', width = 10, height =7 , dpi = 900) 
```


okay what about the ther way around, check if performance in one dataset is correlated with perfromance in another dataset - this doesn't make sense because we don't have thing to merge by, no common ID


Now confusion patterns
- compute confusion patterns on an individual level
- compute a correlationtion between the conufison patterns diagnonals for morph
- to global t tests, ignoring DATASET, and t tests by dataset


How to compute the confusion matrix
- create emotion
- create rsponse column
- create all confusion pairs
- count the number of times the pair emotion response = Emotion = predicted
- take that and devide it by the total number of times that emotion was presented

```{r}
View(db_NT_lmer_correlation)
db_NT_lmer_correlation$Emotion
db_NT_lmer_correlation$n_em

# rm(db_NT_lmer_confusion)

pp<- unique(db_NT_lmer$ParticipantPrivateID)
# pp[1]
i = 1
vt = unique(db_NT_lmer_confusion$VideoType)

# vt = 1


a<- union(db_NT_lmer_confusion$AnswerRating_Recognition, db_NT_lmer_confusion$Emotion)

confusion_all<- as.data.frame(matrix( , nrow = 0, ncol = 6))

colnames(confusion_all)<- colnames(temp2_table)

confusion_all<- temp2_table
rm(i)
View(db_NT_lmer_confusion)
for (i in 1:length(pp)) {
  temp = subset(db_NT_lmer_confusion, db_NT_lmer_confusion$ParticipantPrivateID == pp[i] &
                  db_NT_lmer_confusion$VideoType == "Morph")
  # View(temp)
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                        a)))
  temp2_table<- as.data.frame(temp2$table)
  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table$Prop <- temp2_table$Freq/ 9
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Morph"

 
  # View(temp)
  # View(temp2)
  confusion_all<-bind_rows(confusion_all, temp2_table)
  
}

View(confusion_all)

# Confusion Original

confusion_orig<- as.data.frame(matrix( , nrow = 0, ncol = 6))

colnames(confusion_orig)<- colnames(temp2_table)

# confusion_<- temp2_table
rm(i)

for (i in 1:length(pp)) {
  temp = subset(db_NT_lmer_confusion, db_NT_lmer_confusion$ParticipantPrivateID == pp[i] &
                  db_NT_lmer_confusion$VideoType == "Original")
  # View(temp)
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                        a)))
  temp2_table<- as.data.frame(temp2$table)
  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table$Prop <- temp2_table$Freq/ 9
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Original"

 
  # View(temp)
  # View(temp2)
  confusion_orig<-bind_rows(confusion_orig, temp2_table)
  
}

View(confusion_orig)
unique(confusion_orig$Participant)

confusion_full<- bind_rows(confusion_orig, confusion_all)
pp
confusion_full %>%
  filter(Emotion!= 'Neutral')%>% #Participant == "1237443")
  ggplot(aes(Emotion, Prediction))+
  geom_raster(aes(fill = Prop))+
  theme_classic()+
  # scale_fill_gradient2(low = "blue", high = "red",  space = "Lab")+
  # scale_fill_viridis(palette = 'Inferno')
  facet_grid(~VideoType)+
   scale_fill_gradient2(low = "blue", high = "red", 
                       limit = c(0,1))
  # scale_fill_gradient()


confusion_full
  
confusion_full_leftj<- left_join(confusion_orig, confusion_all, by = c('Participant', 'Emotion', 'Prediction'))

confusion_full_leftj<- confusion_full_leftj%>%
    group_by(Participant)%>%
  mutate(cor_morph_orig_all = cor(Prop.x, Prop.y))


confusion_full_leftj<- confusion_full_leftj%>%
  mutate(cor_morph_orig_all_z = fisherz(cor_morph_orig_all))
View(confusion_full_leftj)

confusion_full_leftjagg<- confusion_full_leftj%>%
  group_by(Participant)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
# t test
t.test(confusion_full_leftjagg$cor_morph_orig_all_z, mu = 0, paired = FALSE)

# no diagona;
confusion_full_leftj_nodig<-  confusion_full_leftj%>%
  filter(Emotion != Prediction)%>%
  mutate(cor_morph_orig_nodiag = cor(Prop.x, Prop.y))%>%
  mutate(cor_morph_orig_nodiag_z = fisherz(cor_morph_orig_nodiag))

confusion_full_leftj_nodigagg<- confusion_full_leftj_nodig%>%
  group_by(Participant)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

View(confusion_full_leftj_nodigagg)

t.test(confusion_full_leftj_nodigagg$cor_morph_orig_nodiag_z, mu = 0, paired = FALSE)


%>%
   ggplot(aes(Participant, cor_morph_orig_nodiag))+
  geom_point()
View(confusion_full_leftj)

confusion_full_leftj%>%
 
  # coord_flip()
  
```



study 2 confusion








```{r}
db_ASCNT_lmer_confusion<- 
  
  subset(db_ASC_NT)%>%
  dplyr::select( c(ParticipantPrivateID,DATASET, VideoType, Video, 
                             Recognacc, AnswerRating_Recognition, Emotion, matched, Group))


confusion_orig<- as.data.frame(matrix( , nrow = 0, ncol = 8))

colnames(confusion_orig)<- colnames(temp2_table)


a<- union(db_ASC_lmer_confusion$AnswerRating_Recognition, db_ASC_lmer_confusion$Emotion)


for (i in 1:length(pp)) {
  temp = subset(db_ASC_lmer_confusion, db_ASC_lmer_confusion$ParticipantPrivateID == pp[i] &
                  db_ASC_lmer_confusion$VideoType == "Original")
  # View(temp)
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                        a)))
  temp2_table<- as.data.frame(temp2$table)
  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table$Prop <- temp2_table$Freq/ 9
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Original"

 
  # View(temp)
  # View(temp2)
  confusion_orig<-bind_rows(confusion_orig, temp2_table)
  
}

View(confusion_orig)
unique(confusion_orig$Participant)

confusion_full<- bind_rows(confusion_orig, confusion_all)
pp
confusion_full %>%
  filter(Emotion!= 'Neutral')%>% #Participant == "1237443")
  ggplot(aes(Emotion, Prediction))+
  geom_raster(aes(fill = Prop))+
  theme_classic()+
  # scale_fill_gradient2(low = "blue", high = "red",  space = "Lab")+
  # scale_fill_viridis(palette = 'Inferno')
  facet_grid(~VideoType)+
   scale_fill_gradient2(low = "blue", high = "red", 
                       limit = c(0,1))
  # scale_fill_gradient()


confusion_full
  
confusion_full_leftj<- left_join(confusion_orig, confusion_all, by = c('Participant', 'Emotion', 'Prediction'))

confusion_full_leftj<- confusion_full_leftj%>%
    group_by(Participant)%>%
  mutate(cor_morph_orig_all = cor(Prop.x, Prop.y))


confusion_full_leftj<- confusion_full_leftj%>%
  mutate(cor_morph_orig_all_z = fisherz(cor_morph_orig_all))
View(confusion_full_leftj)

confusion_full_leftjagg<- confusion_full_leftj%>%
  group_by(Participant)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# t test
t.test(confusion_full_leftjagg$cor_morph_orig_all_z, mu = 0, paired = FALSE)

# no diagona;
confusion_full_leftj_nodig<-  confusion_full_leftj%>%
  filter(Emotion != Prediction)%>%
  mutate(cor_morph_orig_nodiag = cor(Prop.x, Prop.y))%>%
  mutate(cor_morph_orig_nodiag_z = fisherz(cor_morph_orig_nodiag))

confusion_full_leftj_nodigagg<- confusion_full_leftj_nodig%>%
  group_by(Participant)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

View(confusion_full_leftj_nodigagg)

t.test(confusion_full_leftj_nodigagg$cor_morph_orig_nodiag_z, mu = 0, paired = FALSE)


%>%
   ggplot(aes(Participant, cor_morph_orig_nodiag))+
  geom_point()
View(confusion_full_leftj)

confusion_full_leftj%>%
 
  # coord_flip()
  
```




```{r}
# comparing DATASETS
  # ADFES Original
  
confusion_orig_ADFES<- as.data.frame(matrix( , nrow = 0, ncol = 7))

colnames(confusion_orig_ADFES)<- colnames(temp2_table)

subset(db_NT_lmer_confusion, db_NT_lmer_confusion$ParticipantPrivateID == 1237841 &  db_NT_lmer_confusion$DATASET == 'ADFES' & db_NT_lmer_confusion$VideoType == "Morph" & db_NT_lmer_confusion$matched == "YES")

  for (i in 1:length(pp)) {
    
  temp = subset(db_NT_lmer_confusion, db_NT_lmer_confusion$ParticipantPrivateID == 1237841 &
                  db_NT_lmer_confusion$VideoType == "Original" & db_NT_lmer_confusion$DATASET == "JEFFE")
  # View(temp)
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                        a)))
  temp2_table<- as.data.frame(temp2$table)
  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table$Prop <- temp2_table$Freq/ 5
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Original"
 temp2_table$DATASET<- "ADFES"
 
  # View(temp)
  # View(temp2)
  confusion_orig_ADFES<-bind_rows(confusion_orig_ADFES, temp2_table)
  
  }

# ADFES morph
confusion_morph_ADFES<- as.data.frame(matrix( , nrow = 0, ncol = 7))

colnames(confusion_morph_ADFES)<- colnames(temp2_table)

  for (i in 1:length(pp)) {
    
  temp = subset(db_NT_lmer_confusion, db_NT_lmer_confusion$ParticipantPrivateID == pp[i] &
                  db_NT_lmer_confusion$VideoType == "Morph" & db_NT_lmer_confusion$DATASET == "ADFES")
  # View(temp)
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                        a)))
  temp2_table<- as.data.frame(temp2$table)
  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table$Prop <- temp2_table$Freq/ 5
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Morph"
 temp2_table$DATASET<- "ADFES"
 
  # View(temp)
  # View(temp2)
  confusion_orig_ADFES<-bind_rows(confusion_orig_ADFES, temp2_table)
  
}

```


study 2 ADFES

```{r}
# comparing DATASETS
  # ADFES Original
  
  
  
confusion_orig_ADFES<- as.data.frame(matrix( , nrow = 0, ncol = 8))

colnames(confusion_orig_ADFES)<- colnames(temp2_table)
pp<- unique(db_ASCNT_lmer_confusion$ParticipantPrivateID)
# subset(db_NT_lmer_confusion, db_NT_lmer_confusion$ParticipantPrivateID == 1237841 &  db_NT_lmer_confusion$DATASET == 'ADFES' & db_NT_lmer_confusion$VideoType == "Morph" & db_NT_lmer_confusion$matched == "YES")
i = 1

unique(db_ASCNT_lmer_confusion$Group)
  
for (i in 1:length(pp)) {
    
  temp = subset(db_ASCNT_lmer_confusion, db_ASCNT_lmer_confusion$ParticipantPrivateID == pp[i] &
                  db_ASCNT_lmer_confusion$VideoType == "Original" & db_ASCNT_lmer_confusion$DATASET == "ADFES")
  # View(temp)
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                        a)))
  temp2_table<- as.data.frame(temp2$table)
    # View(temp2_table)
  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table$Prop <- temp2_table$Freq/ 5
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Original"
 temp2_table$DATASET<- "ADFES"
 temp2_table$Group<- unique(temp$Group)
 
  # View(temp)
  # View(temp2)
  confusion_orig_ADFES<-bind_rows(confusion_orig_ADFES, temp2_table)
  
  }

View(confusion_orig_ADFES)

unique(confusion_orig_ADFES$Group)
unique(confusion_orig_ADFES$Participant)
# confusion_orig_ADFES$Group<- "ASC"

# ADFES morph
confusion_morph_ADFES<- as.data.frame(matrix( , nrow = 0, ncol = 8))

colnames(confusion_morph_ADFES)<- colnames(temp2_table)
i = 2
  for (i in 1:length(pp)) {
    
  temp = subset(db_ASCNT_lmer_confusion, db_ASCNT_lmer_confusion$ParticipantPrivateID == pp[i] &
                  db_ASCNT_lmer_confusion$VideoType == "Morph" & db_ASCNT_lmer_confusion$DATASET == "ADFES")
  View(temp)
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                        a)))
  temp2_table<- as.data.frame(temp2$table)
  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table$Prop <- temp2_table$Freq/ 5
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType <- "Morph"
 temp2_table$DATASET<- "ADFES"
  temp2_table$Group<- unique(temp$Group)
 
  confusion_morph_ADFES<-bind_rows(confusion_morph_ADFES, temp2_table)
  
  }

View(confusion_morph_ADFES)
unique(confusion_morph_ADFES$Group)
```

```{r}
View(db_april)


confusion_orig_JEFFE<- as.data.frame(matrix( , nrow = 0, ncol = 8))

colnames(confusion_orig_JEFFE)<- colnames(temp2_table)

  for (i in 1:length(pp)) {
    
  temp = subset(db_ASCNT_lmer_confusion, db_ASCNT_lmer_confusion$ParticipantPrivateID == pp[i] &
                  db_ASCNT_lmer_confusion$VideoType == "Original" & db_ASCNT_lmer_confusion$DATASET == "JEFFE")
  # View(temp)
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                        a)))
  temp2_table<- as.data.frame(temp2$table)
  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table$Prop <- temp2_table$Freq/ 5
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Original"
 temp2_table$DATASET<- "JEFFE"
  temp2_table$Group<- unique(temp$Group)
 
  # View(temp)
  # View(temp2)
  confusion_orig_JEFFE<-bind_rows(confusion_orig_JEFFE, temp2_table)
  
  }
View(  confusion_orig_JEFFE)

# JEFFE morph
confusion_morph_JEFFE<- as.data.frame(matrix( , nrow = 0, ncol = 8))

colnames(confusion_morph_JEFFE)<- colnames(temp2_table)

  for (i in 1:length(pp)) {
    
  temp = subset(db_ASCNT_lmer_confusion, db_ASCNT_lmer_confusion$ParticipantPrivateID == pp[i] &
                  db_ASCNT_lmer_confusion$VideoType == "Morph" & db_ASCNT_lmer_confusion$DATASET == "JEFFE")
  # View(temp)
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                        a)))
  temp2_table<- as.data.frame(temp2$table)
  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table$Prop <- temp2_table$Freq/ 5
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Morph"
 temp2_table$DATASET<- "JEFFE"
   temp2_table$Group<- unique(temp$Group)
 
 
  # View(temp)
  # View(temp2)
  confusion_morph_JEFFE<-bind_rows(confusion_orig_JEFFE, temp2_table)
  
  }

View(  confusion_orig_JEFFE)
View(  confusion_morph_JEFFE)
View(confusion_morph_JEFFE)
test<- confusion_morph_JEFFE[1,]
View(confusion_byds_vt_full)


test<- subset(confusion_byds_vt_full, confusion_byds_vt_full$DATASET == "ADFES" & confusion_byds_vt_full$VideoType == "Morph")
View(confusion_byds_vt_full) #this is the dataset I used for the study one computations

confusion_byds_vt_full_ASCNT<- bind_rows(confusion_orig_JEFFE,  confusion_morph_JEFFE,  confusion_orig_ADFES,  confusion_morph_ADFES)


test<- subset(confusion_byds_vt_full_ASCNT, confusion_byds_vt_full_ASCNT$DATASET == "ADFES" &
                confusion_byds_vt_full_ASCNT$VideoType == "Morph")

paper_plots$CMatrix_byGroup<-
  confusion_byds_vt_full%>%
  subset(Emotion != "Neutral")%>%
  mutate(pair = paste0(Emotion, Prediction))%>%
  mutate(Emotion = as.factor(Emotion))%>%
  mutate(Emotion = relevel(Emotion, ref = "Anger"))%>%
  mutate(Prediction = as.factor(Prediction))%>%
  mutate(Prediction = relevel(Prediction, ref = "Anger"))%>%
  group_by(pair, Emotion,Prediction, VideoType, DATASET)%>%
  summarise_at(c('Freq', 'Prop'), mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion, Prediction))+
  geom_raster(aes(fill = Prop, stat = 'identity'))+
  facet_grid(DATASET~VideoType)

paper_plots$CMatrix_byGroup

study2_plots$

confusion_byds_vt_full_ASCNT%>%
  # filter(Group == "NT")%>%
  subset(Emotion != "Neutral")%>%
  mutate(pair = paste0(Emotion, Prediction))%>%
  mutate(Emotion = as.factor(Emotion))%>%
  mutate(Emotion = relevel(Emotion, ref = "Anger"))%>%
  mutate(Prediction = as.factor(Prediction))%>%
  mutate(Prediction = relevel(Prediction, ref = "Anger"))%>%
  group_by(pair,Group,Emotion,Prediction, VideoType, DATASET)%>%
  # group_by(pair,Group, Emotion,Prediction, VideoType, DATASET)%>%
  summarise_at(c('Freq', 'Prop'), mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion, Prediction))+
  geom_raster(aes(fill = Prop, stat = 'identity'))+
  facet_grid(DATASET~VideoType+Group)


View(db_ASC_NT)


```



# aggregate
confusion_byds_vt_full_agg<- confusion_byds_vt_full%>%
  subset(Emotion != "Neutral")%>%
  mutate(pair = paste0(Emotion, Prediction))%>%
  mutate(Emotion = as.factor(Emotion))%>%
  mutate(Emotion = relevel(Emotion, ref = "Anger"))%>%
  mutate(Prediction = as.factor(Prediction))%>%
  mutate(Prediction = relevel(Prediction, ref = "Anger"))%>%
  group_by(pair, Emotion,Prediction, VideoType, DATASET)%>%
  summarise_at(c('Freq', 'Prop'), mean, na.rm = TRUE)

# study2
confusion_byds_vt_full_ASCNT_agg<- confusion_byds_vt_full_ASCNT%>%
  subset(Emotion != "Neutral")%>%
  mutate(pair = paste0(Emotion, Prediction))%>%
  mutate(Emotion = as.factor(Emotion))%>%
  mutate(Emotion = relevel(Emotion, ref = "Anger"))%>%
  mutate(Prediction = as.factor(Prediction))%>%
  mutate(Prediction = relevel(Prediction, ref = "Anger"))%>%
  group_by(pair,Group, Emotion,Prediction, VideoType, DATASET)%>%
  summarise_at(c('Freq', 'Prop'), mean, na.rm = TRUE)





max(confusion_byds_vt_full_agg$Prop)
unique(confusion_byds_vt_full_ASCNT_agg$Group)
max(confusion_byds_vt_full_ASCNT_agg$Prop)

paper_plots$CMatrix_byGroup<- paper_plots$CMatrix_byGroup+
  theme_classic()+
  p$graphstyle+
  scale_fill_viridis_c(option = "plasma", breaks = c(0, .4, .8), limits = c(0,.8))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
paper_plots$CMatrix_byGroup
confusion_byds_vt_full2<-
confusion_byds_vt_full%>%
  subset(Emotion != "Neutral")%>%
  mutate(pair = paste0(Emotion, Prediction))%>%
  mutate(Emotion = as.factor(Emotion))%>%
  mutate(Emotion = relevel(Emotion, ref = "Anger"))%>%
  mutate(Prediction = as.factor(Prediction))%>%
  mutate(Prediction = relevel(Prediction, ref = "Anger"))%>%
  group_by(pair, Emotion,Prediction, VideoType)
max(confusion_byds_vt_full2$Prop )

paper_plots$CMatrix_byGroup_global<-confusion_byds_vt_full%>%
  subset(Emotion != "Neutral")%>%
  mutate(pair = paste0(Emotion, Prediction))%>%
  mutate(Emotion = as.factor(Emotion))%>%
  mutate(Emotion = relevel(Emotion, ref = "Anger"))%>%
  mutate(Prediction = as.factor(Prediction))%>%
  mutate(Prediction = relevel(Prediction, ref = "Anger"))%>%
  group_by(pair, Emotion,Prediction, VideoType)%>%
  summarise_at(c('Freq', 'Prop'), mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion, Prediction))+
  geom_raster(aes(fill = Prop, stat = 'identity'))+
  facet_grid(~VideoType)+
    theme_classic()+
  ylab("Global")+
  p$graphstyle+
  scale_fill_viridis_c(option = "plasma", breaks = c(0, .5, 1), limits = c(0,1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
# stud2 matrix confusion


study2_plots$ConfusionMatrix<-
  confusion_byds_vt_full_ASCNT %>%
  subset(Emotion != "Neutral")%>%
  mutate(pair = paste0(Emotion, Prediction))%>%
  mutate(Emotion = as.factor(Emotion))%>%
  mutate(Emotion = relevel(Emotion, ref = "Anger"))%>%
  mutate(Prediction = as.factor(Prediction))%>%
  mutate(Prediction = relevel(Prediction, ref = "Anger"))%>%
  group_by(pair,Group, Emotion,Prediction,DATASET, VideoType)%>%
  summarise_at(c('Freq', 'Prop'), mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion, Prediction))+
  geom_raster(aes(fill = Prop, stat = 'identity'))+
  facet_grid(Group~DATASET+VideoType)+
    theme_classic()+
  xlab("Emotion")+
  ylab("Predicted")+
  p$graphstyle+
  scale_fill_viridis_c(option = "plasma", breaks = c(0, .5, 1), limits = c(0,1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

study2_plots$ConfusionMatrix
````

```{r}

study2_plots$ConfusionMatrixGlobal<-
  confusion_byds_vt_full_ASCNT %>%
  subset(Emotion != "Neutral")%>%
  mutate(pair = paste0(Emotion, Prediction))%>%
  mutate(Emotion = as.factor(Emotion))%>%
  mutate(Emotion = relevel(Emotion, ref = "Anger"))%>%
  mutate(Prediction = as.factor(Prediction))%>%
  mutate(Prediction = relevel(Prediction, ref = "Anger"))%>%
  group_by(pair,Group, Emotion,Prediction,VideoType)%>%
  summarise_at(c('Freq', 'Prop'), mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion, Prediction))+
  geom_raster(aes(fill = Prop, stat = 'identity'))+
  facet_grid(Group~VideoType)+
  theme_classic()+
  ylab("Global")+
  p$graphstyle+
  scale_fill_viridis_c(option = "plasma", breaks = c(0, .5, 1), limits = c(0,1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

study2_plots$ConfusionMatrixGlobal

```

```{r}
 
   View(confusion_byds_vt_full_ASCNT_cor)
  
confusion_byds_vt_full_ASCNT_cor %>%
  group_by(DATASET, Group)%>%
  mutate(cor = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  summarise_at(c("cor", 'cor_morph_orig', 'cor_morph_orig_z', 'cor_morph_orig_subj'), mean, na.rm = TRUE)

```



```{r}

paper_plots$Matrix_panel<-
(((paper_plots$CMatrix_byGroup +  
    theme(legend.position = "none", axis.title.x = element_blank(),
                                     axis.text.x = element_blank())+
     guides(fill = guide_colourbar(ticks = FALSE, barwidth = 10, barheight = .5))
     ) /
    (paper_plots$CMatrix_byGroup_global +
    theme(legend.position = "none", axis.text.y = element_blank(),
                                           # axis.title.y = element_blank(),
          strip.text = element_blank())+
  guides(fill = guide_colourbar(ticks = FALSE, barwidth = 10, barheight = .5))
  ))+ plot_layout()+plot_annotation() & theme(legend.title =
          element_text(size = 16), legend.position = 'top') |
   (paper_plots$Representation+ theme(legend.position = "none",
                                           axis.title.x = element_blank()))) +
  # plot_layout(nrow = 2, ncol = 2, heights = c(2, 1), widths = c(1,1))+
   # +
   plot_annotation(tag_levels = "A") & 
  theme(plot.tag = element_text(size = 13)) 


study2_plots$panel <-(study2_plots$ADFES_valence+
  theme(legend.title = element_blank())+
    
    study2_plots$Intensity+
    theme(axis.title.x = element_blank(), legend.position = "none")+
  
    study2_plots$Valence_cor+ theme(legend.position = "none")+
    
  study2_plots$representation_cor +theme(legend.position = "none",
                                           axis.title.x = element_blank()) +
  study2_plots$ConfusionMatrix +  
  theme(legend.position = "top", legend.direction = "horizontal" )+
    guides(fill = guide_colourbar(ticks = FALSE, barwidth = 10, barheight = .5))+
  
  study2_plots$ConfusionMatrixGlobal+
  theme(legend.position = "top", legend.direction = "horizontal", axis.text.y = element_blank(),
         axis.title.x = element_blank())+
      # strip.text = element_blank()
  guides(fill = guide_colourbar(ticks = FALSE, barwidth = 10, barheight = .5)))+
  
  plot_layout(nrow = 3, heights = c(2,2,3))+
    plot_annotation(tag_levels = "A")

 legend.position = 'top'
& theme(legend.title =
          element_text(size = 16))
 # & 
 #  theme(plot.tag = element_text(size = 13))



paper_plots$Matrix_panel

ggsave("Matrix_panel.png", paper_plots$Matrix_panel,device = 'png', width = 18, height = 12, dpi = 800)  
ggsave("Matrix_panel.tiff", paper_plots$Matrix_panel,device = 'tiff', width = 10, height = 12, dpi = 900)

ggsave("Matrix_panelstudy2.png", study2_plots$panel ,device = 'png', width = 18, height = 15, dpi = 900)
study2_plots$panel
# paper_plots$correlations_morph_orig          
            guides = 'collect' & theme(legend.position = 'top')

```
  
  
  

```{r}
  
paper_plots$cor_morph_orig_acc<- paper_plots$cor_morph_orig_acc+ 
  p$graphstyle1+
  scale_y_continuous(breaks = c(-1, -.5, 0, .5, 1), limits = c(-1,1))+
  scale_color_brewer(palette = "Dark2")
paper_plots$cor_morph_orig_acc


paper_plots$cor_morph_orig_val
paper_plots$cor_morph_orig_acc

paper_plots$correlations_morph_orig<-
paper_plots$cor_morph_orig_val+  theme(legend.position = "none", axis.title.x = element_blank(),
                                     axis.text.x = element_blank())+
paper_plots$cor_morph_orig_int+  theme(legend.position = "none", axis.title.x = element_blank(),
                                     axis.text.x = element_blank(), axis.text.y = element_blank())+
paper_plots$cor_morph_orig_nat+  theme(legend.position = "none", axis.title.x = element_blank(), axis.text.y = element_blank())+
paper_plots$cor_morph_orig_acc+  theme(legend.position = "none", axis.title.x = element_blank())+
plot_layout(nrow = 2, ncol = 2)
            
paper_plots$correlations_morph_orig          
            guides = 'collect')& theme(legend.position = 'top')
  
ggsave("correlations_morph_orig.png", paper_plots$correlations_morph_orig, device = 'png', width = 10, height =7 , dpi = 900) 
```


```{r}
confusion_byds_vt_full_morph<- subset(confusion_byds_vt_full, confusion_byds_vt_full$VideoType == "Morph")
confusion_byds_vt_full_original<- subset(confusion_byds_vt_full, confusion_byds_vt_full$VideoType != "Morph")

confusion_byds_vt_full_cor<- left_join(confusion_byds_vt_full_morph, confusion_byds_vt_full_original, by = c("Participant", "Emotion", "Prediction","DATASET"))

# study 2
confusion_byds_vt_full_ASCNT_morph<- subset(confusion_byds_vt_full_ASCNT, confusion_byds_vt_full_ASCNT$VideoType == "Morph")
confusion_byds_vt_full_ASCNT_original<- subset(confusion_byds_vt_full_ASCNT, confusion_byds_vt_full_ASCNT$VideoType != "Morph")

confusion_byds_vt_full_ASCNT_cor<- left_join(confusion_byds_vt_full_ASCNT_morph,confusion_byds_vt_full_ASCNT_original, by = c("Participant", "Emotion", "Prediction","DATASET", "Group"))

View(confusion_byds_vt_full_ASCNT_cor)
View(confusion_byds_vt_full_cor)

confusion_byds_vt_full_cor<- confusion_byds_vt_full_cor%>%
  group_by(Participant, DATASET)%>%
  mutate(cor_morph_orig = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_z = fisherz(cor_morph_orig))%>%
  group_by(Participant)%>%
  mutate(cor_morph_orig_subj = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_z_subj = fisherz(cor_morph_orig_subj))
 
 #study 2 
confusion_byds_vt_full_ASCNT_cor<- confusion_byds_vt_full_ASCNT_cor %>%
  group_by(Participant,Group, DATASET)%>%
  mutate(cor_morph_orig = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_z = fisherz(cor_morph_orig))%>%
  group_by(Participant,Group)%>%
  mutate(cor_morph_orig_subj = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_z_subj = fisherz(cor_morph_orig_subj))
  
cor_morph_orig_z
View(confusion_byds_vt_full_cor)
View(confusion_byds_vt_full_ASCNT_cor)

# correlatin between perfromance in one condition and the other across partocipants

# # bydadataet
# confusion_byds_vt_full_cor<- confusion_byds_vt_full_cor%>%
#   group_by(DATASET)%>%
#   mutate(cor_morph_orig_byDS_allsubj = cor(Prop.x,Prop.y))
# unique(confusion_byds_vt_full_cor$cor_morph_orig_byDS_allsubj)
# 
# # ADFES
# cor.test(subset(confusion_byds_vt_full_cor, confusion_byds_vt_full_cor$DATASET == "ADFES")$Prop.x,
# subset(confusion_byds_vt_full_cor, confusion_byds_vt_full_cor$DATASET == "ADFES")$Prop.y)
# 
# # JEFFE
# cor.test(subset(confusion_byds_vt_full_cor, confusion_byds_vt_full_cor$DATASET == "JEFFE")$Prop.x,
# subset(confusion_byds_vt_full_cor, confusion_byds_vt_full_cor$DATASET == "JEFFE")$Prop.y)

# # no diagnonals
# cor.test(subset(confusion_byds_vt_full_cor, confusion_byds_vt_full_cor$DATASET == "ADFES" & confusion_byds_vt_full_cor$Emotion!= confusion_byds_vt_full_cor$Prediction)$Prop.x,
# subset(confusion_byds_vt_full_cor, confusion_byds_vt_full_cor$DATASET == "ADFES" & confusion_byds_vt_full_cor$Emotion!= confusion_byds_vt_full_cor$Prediction)$Prop.y)




# # eliminate diagonals
# confusion_byds_vt_full_cor_nodiagnonal<- confusion_byds_vt_full_cor%>%
#   filter(Emotion!= Prediction)%>%
#   group_by(DATASET)%>%
#   mutate(cor_morph_orig_byDS_allsubj_nodiag = cor(Prop.x,Prop.y))
# 
# # 
# unique(confusion_byds_vt_full_cor_nodiagnonal$cor_morph_orig_byDS_allsubj_nodiag)


```

```
```{r}
confusion_byds_vt_full_coragg<- confusion_byds_vt_full_cor %>%
  group_by(Participant, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)


# study 2


confusion_byds_vt_full_ASCNT_coragg<- confusion_byds_vt_full_ASCNT_cor%>%
    group_by(Participant,Group, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

View(confusion_byds_vt_full_coragg)
confusion_byds_vt_full_coragg%>%
  filter(cor_morph_orig_z<5)%>%
  ggplot(aes(DATASET, cor_morph_orig_z, colour = DATASET))+
  # geom_jitter(width = .2)+
  geom_boxplot()
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=1)

Q <- quantile(confusion_byds_vt_full_coragg$cor_morph_orig_z, probs=c(.25, .75), na.rm = FALSE)

iqr <- IQR(confusion_byds_vt_full_coragg$cor_morph_orig_z)

# cutoff
up <-  Q[2]+1.5*iqr # Upper Range  
low<- Q[1]-1.5*iqr # Lower Range�

confusion_byds_vt_full_coragg$cor_morph_orig_outlier<- ifelse(confusion_byds_vt_full_coragg$cor_morph_orig_z > (Q[1] - 1.5*iqr) & confusion_byds_vt_full_coragg$cor_morph_orig_z < (Q[2]+1.5*iqr), "YES","NO")
unique(confusion_byds_vt_full_coragg$cor_morph_orig_outlier)

confusion_byds_vt_full_coragg%>%
  ggplot(aes(DATASET, cor_morph_orig_z, colour = DATASET))+
  # geom_jitter(width = .2)+
  geom_boxplot()
  facet_grid(~cor_morph_orig_outlier)


confusion_byds_vt_full_coragg_noout<- subset(confusion_byds_vt_full_coragg, confusion_byds_vt_full_coragg$cor_morph_orig_outlier == 'YES')

aov_ez(id  = 'Participant',
       data = confusion_byds_vt_full_coragg,
       dv = 'cor_morph_orig_z',
       within = 'DATASET',
       between = NULL)

emmeans(aov_ez(id  = 'Participant',
       data = confusion_byds_vt_full_coragg,
       dv = 'cor_morph_orig_z',
       within = 'DATASET',
       between = NULL), pairwise~ DATASET)

# study 2


# for matched IQ
db_asc_nt_pp_matching$ParticipantPrivateID
db_asc_nt_pp_matching$Participant<-db_asc_nt_pp_matching$ParticipantPrivateID

confusion_byds_vt_full_ASCNT_coragg$Participant

confusion_byds_vt_full_ASCNT_coragg_matchedIQ<- left_join(db_asc_nt_pp_matching, confusion_byds_vt_full_ASCNT_coragg, by = 'Participant')
nrow(confusion_byds_vt_full_ASCNT_coragg_matchedIQ)
nrow(confusion_byds_vt_full_ASCNT_coragg)

emmeans(aov_ez(id  = 'Participant',
       data = confusion_byds_vt_full_ASCNT_coragg,
       dv = 'cor_morph_orig_z',
       within = 'DATASET',
       between = "Group"), pairwise~Group|DATASET,adjust = 'bonf')


# matched
unique(confusion_byds_vt_full_ASCNT_coragg_matchedIQ$Group.x)
confusion_byds_vt_full_ASCNT_coragg_matchedIQ$Group.x<- as.factor(confusion_byds_vt_full_ASCNT_coragg_matchedIQ$Group.x)

emmeans(aov_ez(id  = 'Participant',
       data = confusion_byds_vt_full_ASCNT_coragg_matchedIQ,
       dv = 'cor_morph_orig_z',
       within = 'DATASET',
       between = "Group.x"), pairwise~Group.x|DATASET,adjust = 'bonf')

confusion_byds_vt_full_coragg_ttest<- confusion_byds_vt_full_cor %>%
  group_by(Participant)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

confusion_byds_vt_full_ASCNT_coragg_ttest<- confusion_byds_vt_full_ASCNT_coragg%>%
  group_by(Participant,Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)


confusion_byds_vt_full_ASCNT_coragg_ttest_matchediq<- left_join(db_asc_nt_pp_matching, confusion_byds_vt_full_ASCNT_coragg_ttest, by = "Participant")

t.test(confusion_byds_vt_full_coragg_ttest$cor_morph_orig_z_subj, mu = 0, paired = FALSE)



t.test(confusion_byds_vt_full_ASCNT_coragg_ttest$cor_morph_orig_z_subj, mu = 0, paired = FALSE)
fisherz2r(1.072098 ) 


# matched iq
t.test(confusion_byds_vt_full_ASCNT_coragg_ttest_matchediq$cor_morph_orig_z_subj, mu = 0, paired = FALSE)
fisherz2r(1.072098 )#consistent


t.test(subset(confusion_byds_vt_full_ASCNT_coragg_ttest, confusion_byds_vt_full_ASCNT_coragg_ttest$Group =='ASC')  $cor_morph_orig_z_subj, mu = 0, paired = FALSE)
options(scipen = 999)
0.7902503^2
t.test(confusion_byds_vt_full_ASCNT_coragg_ttest$cor_morph_orig_z_subj, mu = 0, paired = FALSE)

# 


View(confusion_byds_vt_full_coragg_ttest)
confusion_byds_vt_full_coragg_ttest$DATASET<- "Global"

View(confusion_byds_vt_full_coragg)

confusion_byds_vt_full_coragg_bind<- bind_rows(confusion_byds_vt_full_coragg_ttest, confusion_byds_vt_full_coragg)%>%
  mutate(DATASET = as.factor(DATASET))%>%
  mutate(DATASET = relevel(DATASET, ref = 'Global'))%>%
  group_by(DATASET)%>%
  mutate(mean_acc = mean(cor_morph_orig, na.rm = TRUE))%>%
  group_by(Participant, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

min(confusion_byds_vt_full_coragg_bind$cor_morph_orig)
max(confusion_byds_vt_full_coragg_bind$cor_morph_orig)
paper_plots$Representation <- 
bind_rows(confusion_byds_vt_full_coragg_ttest, confusion_byds_vt_full_coragg)%>%
  mutate(DATASET = as.factor(DATASET))%>%
  mutate(DATASET = relevel(DATASET, ref = 'Global'))%>%
  group_by(DATASET)%>%
  mutate(mean_acc = mean(cor_morph_orig, na.rm = TRUE))%>%
  group_by(Participant, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(DATASET, cor_morph_orig, colour = DATASET))+
   geom_line(aes(group = Participant), colour = 'gray75', size = .1)+
    geom_point(pch = 21, size = 4, alpha = .7)+
    geom_boxplot(aes(y = mean_acc), width = .2, size = 1, colour = 'darkred')+
    stat_summary(geom = 'point', size = 5, colour = "darkred")+
    theme_classic()+
    ylab("Corr. of Morph and Original \n Representation Matrices")+



  p$graphstyle1+
  scale_y_continuous(breaks = c(.2, .6, 1), limits = c(.2,1))+
  scale_color_brewer(palette = "Dark2")
  
paper_plots$Representation 


# confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg%>%
  group_by(Participant,Group, DATASET)%>%
  summarise_if(is.numeric,mean, na.rm = TRUE)%>%
  ggplot(aes(DATASET, cor_morph_orig, colour = Group))+
  geom_point(pch = 21, position = position_dodge(1))
  geom_boxplot()
  # facet_grid(~Group)
  
  study2_plots$representation_cor<-
  # confusion_byds_vt_full_ASCNT_coragg_ttest$DATASET<- "Global"
bind_rows(confusion_byds_vt_full_ASCNT_coragg, confusion_byds_vt_full_ASCNT_coragg_ttest)%>%
  mutate(DATASET = as.factor(DATASET))%>%
  mutate(DATASET = relevel(DATASET, ref = 'Global'))%>%
  group_by(DATASET,Group)%>%
  mutate(mean_acc = mean(cor_morph_orig, na.rm = TRUE))%>%
  group_by(Participant,Group, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(DATASET, cor_morph_orig, colour = DATASET))+
   geom_line(aes(group = Participant), colour = 'gray75', size = .1)+
    geom_point(pch = 21, size = 4, alpha = .7)+
    geom_boxplot(aes(y = mean_acc), width = .2, size = 1, colour = 'darkred')+
    stat_summary(geom = 'point', size = 5, colour = "darkred")+
    theme_classic()+
    ylab("Corr. of Morph and Original \n Repres Matrices")+
  facet_grid(~Group)
  
  study2_plots$representation_cor<-  study2_plots$representation_cor+
      p$graphstyle1 +
      scale_y_continuous(breaks = c(.2, .6, 1), limits = c(.2,1))

study2_plots$representation_cor
```
  


# there is still a positive effect, indicated that

#No diagonals

```{r}
confusion_byds_vt_full_cor_nodiagnonal<- confusion_byds_vt_full_cor %>%
  filter(Emotion!= Prediction)%>%
  group_by(Participant, DATASET)%>%
  mutate(cor_morph_orig = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_z = fisherz(cor_morph_orig))%>%
  group_by(Participant)%>%
  mutate(cor_morph_orig_subj = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_z_subj = fisherz(cor_morph_orig_subj))

# study 2
confusion_byds_vt_full_ASCNT_cor_nodiagonal<- 
confusion_byds_vt_full_ASCNT_cor %>%
  filter(Emotion!= Prediction)%>%
  group_by(Participant, DATASET)%>%
  mutate(cor_morph_orig = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_z = fisherz(cor_morph_orig))%>%
  group_by(Participant, Group)%>%
  mutate(cor_morph_orig_subj = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_z_subj = fisherz(cor_morph_orig_subj))


confusion_byds_vt_full_cor_nodiagnonal_agg<- confusion_byds_vt_full_cor_nodiagnonal%>%
  group_by(Participant, DATASET)%>%
  summarise_if(is.numeric,mean, na.rm = TRUE)


confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg<- confusion_byds_vt_full_ASCNT_cor_nodiagonal%>%
  group_by(Participant,Group, DATASET)%>%
  summarise_if(is.numeric,mean, na.rm = TRUE)



View(confusion_byds_vt_full_cor_nodiagnonal_agg)
View(confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg)


confusion_byds_vt_full_cor_nodiagnonal_agg%>%
  ggplot(aes(DATASET,cor_morph_orig_z ))+
  geom_boxplot()
emmeans(aov_ez(id = "Participant",
       data = subset(confusion_byds_vt_full_cor_nodiagnonal_agg,confusion_byds_vt_full_cor_nodiagnonal_agg$cor_morph_orig_z != "NaN" &confusion_byds_vt_full_cor_nodiagnonal_agg$cor_morph_orig_z != "Inf"),
       dv = "cor_morph_orig_z",
       within = "DATASET",
       between = NULL), pairwise ~ DATASET)

aov_ez(id = "Participant",
       data = subset(confusion_byds_vt_full_cor_nodiagnonal_agg,confusion_byds_vt_full_cor_nodiagnonal_agg$cor_morph_orig_z != "NaN" &confusion_byds_vt_full_cor_nodiagnonal_agg$cor_morph_orig_z != "Inf"),
       dv = "cor_morph_orig_z",
       within = "DATASET",
       between = NULL)

# when removing diagonals, there is no difference between datasets in the confudability between datasets

# study2
aov_ez(id = "Participant",
       data = subset(confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg,confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg$cor_morph_orig_z != "NaN" &confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg$cor_morph_orig_z != "Inf"),
       dv = "cor_morph_orig_z",
       within = "DATASET",
       between = 'Group')


confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg_pp<- confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg%>%
  group_by(Participant, Group)%>%
  summarise_if(is.numeric,mean, na.rm = TRUE)

t.test(subset(confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg_pp, confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg_pp$cor_morph_orig_z!= "Inf")$cor_morph_orig_z, mu = 0, paired = FALSE)
fisherz2r(0.5319732)

0.486888^2

t.test(subset(confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg_pp, confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg_pp$cor_morph_orig_z!= "Inf" &
         confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg_pp$Group  == 'ASC')$cor_morph_orig_z, mu = 0, paired = FALSE)
```

```{r}
confusion_byds_vt_full_cor_nodiagnonal_agg1<- confusion_byds_vt_full_cor_nodiagnonal%>%
  group_by(Participant)%>%
  summarise_if(is.numeric,mean, na.rm = TRUE)
t.test(confusion_byds_vt_full_cor_nodiagnonal_agg1$cor_morph_orig_z_subj, mu = 0, paired = FALSE)
# there is still a correlation though
# fisherz2r(0.5439308 )


confusion_byds_vt_full_cor_nodiagnonal%>%
  group_by(Participant, DATASET)%>%
  summarise_if(is.numeric,mean, na.rm = TRUE)%>%
  ggplot(aes(DATASET, cor_morph_orig_z, colour = DATASET))+
  # geom_jitter(width = .2)+
  geom_boxplot()

confusion_byds_vt_full_ASCNT_cor_nodiagonal_agg%>%
  group_by(Participant,Group, DATASET)%>%
  summarise_if(is.numeric,mean, na.rm = TRUE)%>%
  ggplot(aes(DATASET, cor_morph_orig, colour = Group))+
  geom_point(pch = 21, position = position_dodge(1))
  geom_boxplot()
  # facet_grid(~Group)

```


confusion_byds_vt_full_cor_nodiagnonal%>%
  group_by(Participant)%>%
  summarise_if(is.numeric,mean, na.rm = TRUE)%>%
  ggplot(aes(cor_morph_orig_z))+
  # geom_jitter(width = .2)+
  geom_boxplot()






# confusion by dataset

````{r}

confusion_byds_vt_full_JEFFE<- subset(confusion_byds_vt_full, confusion_byds_vt_full$DATASET == "JEFFE")
confusion_byds_vt_full_ADFES<- subset(confusion_byds_vt_full, confusion_byds_vt_full$DATASET != "JEFFE")

confusion_by_vtype_full_cor<- left_join(confusion_byds_vt_full_JEFFE, confusion_byds_vt_full_ADFES, by = c("Participant", "Emotion", "Prediction","VideoType"))

View(confusion_by_vtype_full_cor)



confusion_by_vtype_full_cor<- confusion_by_vtype_full_cor%>%
  group_by(Participant, VideoType)%>%
  mutate(cor_morph_orig_by_videotype = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_by_videotype_z = fisherz(cor_morph_orig_by_videotype))

confusion_by_vtype_full_coragg<- confusion_by_vtype_full_cor %>%
  group_by(Participant, VideoType)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
  # filter(cor_morph_orig_z<5)%>%




confusion_byds_vt_full_coragg%>%
  filter(cor_morph_orig_outlier == 'YES')%>%
  ggplot(aes(DATASET, cor_morph_orig_z, colour = DATASET))+
  # geom_jitter(width = .2)+
  geom_boxplot()

confusion_by_vtype_full_coragg%>%
  ggplot(aes(VideoType, cor_morph_orig_by_videotype, colour = VideoType))+
  geom_jitter(width = .2)+
  geom_boxplot()
  # geom_dotplot

nrow(confusion_byds_vt_full_coragg)

# 
# confusion_by_vtype_full_coragg%>%
#   
emmeans(aov_ez(id = 'Participant',
       data = confusion_by_vtype_full_coragg,
       dv = 'cor_morph_orig_by_videotype',
       within = "VideoType"), ~VideoType)
       
```




Do the correlation on matched only

```{r}
# JEFFE
db_NT_lmer_confusion_1<- subset(db_NT_lmer_confusion, db_NT_lmer_confusion$Emotion!= "Surprise")
db_NT_lmer_confusion_1<- subset(db_NT_lmer_confusion_1, db_NT_lmer_confusion_1$Emotion!= "Neutral")

confusion_orig_JEFFE_matched<- as.data.frame(matrix( , nrow = 0, ncol = 8))

colnames(confusion_orig_JEFFE_matched)<- colnames(temp2_table)

View(db_NT_lmer_confusion_1)

a<- unique(temp$Emotion)
a

  for (i in 1:length(pp)) {
    
  temp = subset(db_NT_lmer_confusion_1, db_NT_lmer_confusion_1$ParticipantPrivateID == pp[i] &
                  db_NT_lmer_confusion_1$VideoType == "Original" & db_NT_lmer_confusion_1$DATASET =="JEFFE" &
                  db_NT_lmer_confusion_1$matched == "YES")
  # View(temp)
  # View(temp)
  
  temp1<- temp%>%
    group_by(Emotion)%>%
    mutate(n = n())%>%
    summarise_at(c("n"), mean, na.rm = TRUE)
  
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                      a)))
  
  temp2_table<- as.data.frame(temp2$table)

  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table<- left_join(temp2_table, temp1)
  # View(temp2_table)
  temp2_table$Prop <- temp2_table$Freq/temp2_table$n
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Original"
 temp2_table$DATASET<- "JEFFE"
 
  # View(temp)
  # View(temp2)
  confusion_orig_JEFFE_matched<-bind_rows(confusion_orig_JEFFE_matched, temp2_table)
  
  }

View(confusion_orig_JEFFE_matched)


  confusion_morph_JEFFE_matched<- as.data.frame(matrix( , nrow = 0, ncol = 8))

colnames(  confusion_morph_JEFFE_matched)<- colnames(temp2_table)

# JEFFE morph
  for (i in 1:length(pp)) {
    
  temp = subset(db_NT_lmer_confusion_1, db_NT_lmer_confusion_1$ParticipantPrivateID == pp[i] &
                  db_NT_lmer_confusion_1$VideoType == "Morph" & db_NT_lmer_confusion_1$DATASET =="JEFFE" &
                  db_NT_lmer_confusion_1$matched == "YES")
  # View(temp)
  # View(temp)
  
  temp1<- temp%>%
    group_by(Emotion)%>%
    mutate(n = n())%>%
    summarise_at(c("n"), mean, na.rm = TRUE)
  
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                      a)))
  
  temp2_table<- as.data.frame(temp2$table)

  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table<- left_join(temp2_table, temp1)
  # View(temp2_table)
  temp2_table$Prop <- temp2_table$Freq/temp2_table$n
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Morph"
 temp2_table$DATASET<- "JEFFE"
 
  # View(temp)
  # View(temp2)
  confusion_morph_JEFFE_matched<-bind_rows(confusion_morph_JEFFE_matched, temp2_table)
  
  }

View(confusion_morph_JEFFE_matched)


# ADFES


confusion_orig_ADFES_matched<- as.data.frame(matrix( , nrow = 0, ncol = 8))

colnames(confusion_orig_ADFES_matched)<- colnames(temp2_table)


  for (i in 1:length(pp)) {
    
  temp = subset(db_NT_lmer_confusion_1, db_NT_lmer_confusion_1$ParticipantPrivateID == pp[i] &
                  db_NT_lmer_confusion_1$VideoType == "Original" & db_NT_lmer_confusion_1$DATASET =="ADFES" &
                  db_NT_lmer_confusion_1$matched == "YES")
  # View(temp)
  # View(temp)
  
  temp1<- temp%>%
    group_by(Emotion)%>%
    mutate(n = n())%>%
    summarise_at(c("n"), mean, na.rm = TRUE)
  
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                      a)))
  
  temp2_table<- as.data.frame(temp2$table)

  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table<- left_join(temp2_table, temp1)
  # View(temp2_table)
  temp2_table$Prop <- temp2_table$Freq/temp2_table$n
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Original"
 temp2_table$DATASET<- "ADFES"
 
  # View(temp)
  # View(temp2)
  confusion_orig_ADFES_matched<-bind_rows(confusion_orig_ADFES_matched, temp2_table)
  
  }

View(confusion_orig_ADFES_matched)
unique(db_NT_lmer_confusion_1$Emotion)


# ADFES morph

confusion_morph_ADFES_matched<- as.data.frame(matrix( , nrow = 0, ncol = 8))

colnames(confusion_morph_ADFES_matched)<- colnames(temp2_table)


  for (i in 1:length(pp)) {
    
  temp = subset(db_NT_lmer_confusion_1, db_NT_lmer_confusion_1$ParticipantPrivateID == pp[i] &
                  db_NT_lmer_confusion_1$VideoType == "Morph" & db_NT_lmer_confusion_1$DATASET =="ADFES" &
                  db_NT_lmer_confusion_1$matched == "YES")
  # View(temp)
  # View(temp)
  
  temp1<- temp%>%
    group_by(Emotion)%>%
    mutate(n = n())%>%
    summarise_at(c("n"), mean, na.rm = TRUE)
  
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                      a)))
  
  temp2_table<- as.data.frame(temp2$table)

  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table<- left_join(temp2_table, temp1)
  # View(temp2_table)
  temp2_table$Prop <- temp2_table$Freq/temp2_table$n
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Morph"
 temp2_table$DATASET<- "ADFES"
 
  # View(temp)
  # View(temp2)
  confusion_morph_ADFES_matched<-bind_rows(confusion_morph_ADFES_matched, temp2_table)
  
  }

View( confusion_morph_ADFES_matched)

View(confusion_orig_ADFES_matched)

# # let's eclude surpise right now
# confusion_morph_ADFES_matched<- subset(confusion_morph_ADFES_matched, confusion_morph_ADFES_matched$Emotion!= "Surprise")
# confusion_morph_ADFES_matched<- subset(confusion_morph_ADFES_matched, confusion_morph_ADFES_matched$Emotion!= "Neutral")

confusion_byds_Matched<- bind_rows(confusion_orig_JEFFE_matched,  confusion_morph_JEFFE_matched,  confusion_orig_ADFES_matched,  confusion_morph_ADFES_matched)
View(confusion_byds_Matched)

confusion_byds_vt_full%>%
  subset(Emotion != "Neutral")%>%
  subset(Emotion != "Surprise")%>%
  mutate(Prediction = relevel(Prediction, ref = "Anger"))%>%
  mutate(Emotion = relevel(Emotion, ref = "Anger"))%>%
  mutate(pair = paste0(Emotion, Prediction))%>%
  group_by(pair, Emotion,Prediction, VideoType, DATASET)%>%
  summarise_at(c('Freq', 'Prop'), mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion, Prediction))+
  geom_raster(aes(fill = Prop, stat = 'identity'))+
  facet_grid(DATASET~VideoType)+
  theme_light()+
    scale_fill_viridis_c(limits = c(0,1))

confusion_byds_Matched%>%
  # subset(Emotion != "Neutral")%>%
  # subset(Emotion != "Surprise")%>%
  mutate(Prediction = as.factor(Prediction))%>%
  mutate(Prediction = relevel(Prediction, ref = "Anger"))%>%
  mutate(Emotion = as.factor(Emotion))%>%
  mutate(Emotion = relevel(Emotion, ref = "Anger")) %>%
  mutate(pair = paste0(Emotion, Prediction))%>%
  group_by(Emotion,Prediction, VideoType, DATASET)%>%
  summarise_at(c('Freq', 'Prop'), mean, na.rm = TRUE)%>%
  ggplot(aes(Emotion, Prediction))+
  geom_raster(aes(fill = Prop, stat = 'identity'))+
  facet_grid(DATASET~VideoType)+
  theme_light()+
  scale_fill_viridis_c(limits = c(0,1))




```


```{r}
db_NT_lmer %>%
  # confusion_byds_Matched%>%
  group_by(VideoType, DATASET, matched)%>%
  summarise(n = n())

```
<!-- # confusion by dataset -->


```{r}

confusion_byds_Matched_morph<- subset(confusion_byds_Matched, confusion_byds_Matched$VideoType == "Morph")
confusion_byds_Matched_orig<- subset(confusion_byds_Matched, confusion_byds_Matched$VideoType != "Morph")
nrow(confusion_byds_Matched_morph)
nrow(confusion_byds_Matched_orig)

confusion_byds_Matched_morph$pair<- paste0(confusion_byds_Matched_morph$Emotion, paste0(confusion_byds_Matched_morph$Prediction))

confusion_byds_Matched_orig$pair<- paste0(confusion_byds_Matched_orig$Emotion, paste0(confusion_byds_Matched_orig$Prediction))
nrow(confusion_byds_Matched_orig)

unique(confusion_byds_Matched_orig$Participant)
unique(confusion_byds_Matched_morph$Participant)

# confusion_byds_Matched_morph<- confusion_byds_Matched_morph%>%
#   filter(Emotion!= "Neutral")%>%
#   filter(Emotion!= "Surprise")

unique(confusion_byds_Matched_morph$Emotion)
unique(confusion_byds_Matched_orig$Emotion)



confusion_byds_Matched_full_cor<- left_join(confusion_byds_Matched_morph, confusion_byds_Matched_orig, by = c("Participant", "DATASET", "pair"))
nrow(confusion_byds_Matched_full_cor)
View(confusion_byds_Matched_full_cor)

# confusion_byds_Matched_full_cor<- confusion_byds_Matched_full_cor%>%
#   mutate(Prop.y1 = if_else(is.na(Prop.y) == TRUE, 0, Prop.y))
# 
# confusion_byds_Matched_full_cor1<- confusion_byds_Matched_full_cor%>%
#   subset(Emotion != "Neutral")%>%
#   subset(Emotion != "Surprise") 
# View(confusion_byds_Matched_full_cor1)

confusion_byds_Matched_full_cor1<- confusion_byds_Matched_full_cor%>%
  group_by(Participant,DATASET)%>%
  # mutate(Prop.y1= ifelse(is.na(Prop.y) == TRUE, 0, Prop.y))%>%
  mutate(cor_morph_orig = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_z = fisherz(cor_morph_orig))%>%
  group_by(Participant)%>%
   mutate(cor_morph_orig_subj = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_subjz = fisherz(cor_morph_orig_subj))


# confusion_byds_Matched_full_cor1$noconf<- if_else(is.na(confusion_byds_Matched_full_cor1$Prop.y) == TRUE, "YES", "NO")
View(confusion_byds_Matched_full_cor1)
inf_test<- subset(confusion_byds_Matched_full_cor1, confusion_byds_Matched_full_cor1$cor_morph_orig_by_videotype_z == 'Inf'))



View(confusion_byds_Matched_full_cor1)

confusion_by_vtype_full_coragg_matched <- confusion_byds_Matched_full_cor1 %>%
  group_by(Participant, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
  # filter(cor_morph_orig_z<5)%>%


confusion_by_vtype_full_coragg_matched %>%
  # filter(cor_morph_orig_outlier == 'YES')%>%
  ggplot(aes(DATASET, cor_morph_orig_z, colour = DATASET))+
  # geom_jitter(width = .2)+
  geom_boxplot()


confusion_by_vtype_full_coragg_matched  %>%
  ggplot(aes(DATASET, cor_morph_orig_z, colour = DATASET))+
  geom_jitter(width = .2)+
  geom_boxplot()
  # geom_dotplot


# confusion_byds_vt_full_coragg_noout%>%
#   ggplot(aes(DATASET,cor_morph_orig_z, colour = DATASET))+
#   geom_jitter(width = .2)+
#   geom_boxplot()
#   # geom_dotplot

nrow(confusion_byds_vt_full_coragg)

# 
# confusion_by_vtype_full_coragg%>%
#  

View(confusion_by_vtype_full_coragg_matched)


aov_ez(id = 'Participant',
       data = subset(confusion_by_vtype_full_coragg_matched, confusion_by_vtype_full_coragg_matched$cor_morph_orig_z!= 'Inf') ,
       dv = 'cor_morph_orig_z',
       within = "DATASET")

# no diagona;

confusion_byds_Matched_full_cor1_nd<- confusion_byds_Matched_full_cor%>%
    filter(Emotion.x!= Prediction.x)%>%
  group_by(Participant,DATASET)%>%
  # mutate(Prop.y1= ifelse(is.na(Prop.y) == TRUE, 0, Prop.y))%>%
  mutate(cor_morph_orig = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_z = fisherz(cor_morph_orig))%>%
  group_by(Participant)%>%
   mutate(cor_morph_orig_subj = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_subjz = fisherz(cor_morph_orig_subj))

View(confusion_byds_Matched_full_cor1_nd)


confusion_byds_Matched_full_cor1_nd_agg <- confusion_byds_Matched_full_cor1_nd %>%
  filter(Emotion.x!= Prediction.x)%>%
  group_by(Participant, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
  # filter(cor_morph_orig_z<5)%>%

aov_ez(id = 'Participant',
       data = subset(confusion_byds_Matched_full_cor1_nd_agg, confusion_byds_Matched_full_cor1_nd_agg$cor_morph_orig_z!= 'Inf') ,
       dv = 'cor_morph_orig_z',
       within = "DATASET")



# t-test

confusion_by_vtype_full_coragg_matched_ttest <- confusion_byds_Matched_full_cor1 %>%
  group_by(Participant)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)



t.test(confusion_by_vtype_full_coragg_matched_ttest$cor_morph_orig_subjz, mu =0, paired = FALSE)

View(confusion_by_vtype_full_coragg_matched_ttest)

# nd
confusion_byds_Matched_full_cor1_nd1<- confusion_byds_Matched_full_cor%>%
    filter(Emotion.x!= Prediction.x)%>%
  group_by(Participant)%>%
  # mutate(Prop.y1= ifelse(is.na(Prop.y) == TRUE, 0, Prop.y))%>%
  mutate(cor_morph_orig = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_z = fisherz(cor_morph_orig))%>%
  group_by(Participant)%>%
   mutate(cor_morph_orig_subj = cor(Prop.x, Prop.y, use = 'complete.obs'))%>%
  mutate(cor_morph_orig_subjz = fisherz(cor_morph_orig_subj))

confusion_byds_Matched_full_cor1_nd1 <- confusion_byds_Matched_full_cor1_nd1 %>%
  filter(Emotion.x!= Prediction.x)%>%
  group_by(Participant)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
View(confusion_byds_Matched_full_cor1_nd1)
t.test(subset(confusion_byds_Matched_full_cor1_nd1,confusion_byds_Matched_full_cor1_nd1$cor_morph_orig_subjz != 'Inf' & confusion_byds_Matched_full_cor1_nd1$cor_morph_orig_subjz != "NaN")$cor_morph_orig_subjz, mu =0, paired = FALSE)

```



```{r}

confusion_orig_<- as.data.frame(matrix( , nrow = 0, ncol = 7))

colnames(confusion_orig_JEFFE)<- colnames(temp2_table)

  for (i in 1:length(pp)) {
    
  temp = subset(db_NT_lmer_confusion, db_NT_lmer_confusion$ParticipantPrivateID == pp[i] &
                  db_NT_lmer_confusion$VideoType == "Original" & db_NT_lmer_confusion$DATASET == "JEFFE")
  # View(temp)
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                        a)))
  temp2_table<- as.data.frame(temp2$table)
  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table$Prop <- temp2_table$Freq/ 5
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Original"
 temp2_table$DATASET<- "JEFFE"
 
  # View(temp)
  # View(temp2)
  confusion_orig_JEFFE<-bind_rows(confusion_orig_JEFFE, temp2_table)
  
  }

# JEFFE morph
confusion_morph_JEFFE<- as.data.frame(matrix( , nrow = 0, ncol = 7))

colnames(confusion_morph_JEFFE)<- colnames(temp2_table)

  for (i in 1:length(pp)) {
    
  temp = subset(db_NT_lmer_confusion, db_NT_lmer_confusion$ParticipantPrivateID == pp[i] &
                  db_NT_lmer_confusion$VideoType == "Morph" & db_NT_lmer_confusion$DATASET == "JEFFE")
  # View(temp)
  temp2<-  caret::confusionMatrix(table(factor(temp$Emotion, a), factor(temp $AnswerRating_Recognition,
                                                                        a)))
  temp2_table<- as.data.frame(temp2$table)
  colnames(temp2_table)[1] <-"Emotion"
  colnames(temp2_table)[2] <-"Prediction"
  # "Prediction"
  # View(temp2_table)
  # View(temp)
  temp2_table$Prop <- temp2_table$Freq/ 5
  temp2_table$Participant<- pp[i]
  temp2_table$VideoType<- "Morph"
 temp2_table$DATASET<- "JEFFE"
 
  # View(temp)
  # View(temp2)
  confusion_orig_JEFFE<-bind_rows(confusion_orig_JEFFE, temp2_table)
  
  }


confusion_byds_vt_full<- bind_rows(confusion_orig_JEFFE,  confusion_morph_JEFFE,  confusion_orig_ADFES,  confusion_morph_ADFES)
View(confusion_byds_vt_full)



```

nrow(confusion_byds_vt_full_coragg)

# 
# confusion_by_vtype_full_coragg%>%
#   
emmeans(aov_ez(id = 'Participant',
       data = confusion_by_vtype_full_coragg,
       dv = 'cor_morph_orig_by_videotype',
       within = "VideoType"), ~VideoType)






```{r}
# Original confusionMatrix()
# confusion

db_NT_Original_confusionMatrix <- caret::confusionMatrix(table(factor(db_NT_Original$Reference, a1), factor(db_NT_Original$Prediction, a1)))


db_NT_lmer_confusion <- db_NT_lmer %>%
    mutate(Freq = 1) %>% 
    group_by(ParticipantPrivateID, DATASET,Video, VideoType, Emotion) %>%
    complete(AnswerRating_Recognition,fill = list(Freq = 0))

db_NT_lmer_confusion<- dplyr::select(db_NT_lmer, c(ParticipantPrivateID,
                                                      DATASET, VideoType, Video, Recognacc, AnswerRating_Recognition, Emotion, matched))

View(db_NT_lmer_confusion)


View(db_NT_lmer)
```






correlation ADFES and JEFFE
```{r}


db_NT_lmer_correlation_ADFES<- subset(db_NT_lmer_correlation, db_NT_lmer_correlation$DATASET == "ADFES")
db_NT_lmer_correlation_JEFFE<- subset(db_NT_lmer_correlation, db_NT_lmer_correlation$DATASET != "JEFFE")
View(db_NT_lmer_correlation_JEFFE)
# This one only keeps the matched

db_NT_lmer_correlation_merged3_bymorph<- left_join(db_NT_lmer_correlation_orig, db_NT_lmer_correlation_morph, by = c("ParticipantPrivateID", "Emotion"))

View(db_NT_lmer_correlation_merged3_bymorph)
# 
# # This one only keeps the matched
# db_NT_lmer_correlation_merged2<- left_join(db_NT_lmer_correlation_orig, db_NT_lmer_correlation_morph, by = c("ParticipantPrivateID", "DATASET", "Emotion", "uniquestimid", "Actor_ID"))
install.packages("ltm")
library(ltm)

db_NT_lmer_correlation_merged$matched
View(db_NT_lmer_correlation_merged)
db_NT_lmer_correlation_merged3<-  db_NT_lmer_correlation_merged%>%
  filter(matched == "YES")%>%
  group_by(ParticipantPrivateID, DATASET)%>%
  mutate(intensity_morph_orig_cor = cor(AnswerRating_Intensity.x, AnswerRating_Intensity.y, "complete.obs"))%>%
  mutate(valence_morph_orig_cor = cor(AnswerRating_Valence.x, AnswerRating_Valence.y, use = "complete.obs"))%>%
  mutate(naturality_morph_orig_cor = cor(AnswerRating_Naturality.x, AnswerRating_Naturality.y,use= "complete.obs"))%>%
  mutate(acc_morph_orig_cor = biserial.cor(Recognacc.x, Recognacc.y, use = "complete.obs"))%>%
  mutate(RT_intensity_morph_orig_cor = cor(ReactionTime_Intensity.x, ReactionTime_Intensity.y))%>%
  mutate(RT_valence_morph_orig_cor = cor(ReactionTime_Valence.x, ReactionTime_Valence.y))%>%
  mutate(RT_naturality_morph_orig_cor = cor(ReactionTime_Naturality.x, ReactionTime_Naturality.y))%>%
  mutate(RT_recogn = cor(ReactionTime_Recognition.x, ReactionTime_Recognition.y))

View(db_NT_lmer_correlation_merged3)





```

```
Okay, now we want to see whether the degree of face changes introduced by morphin (Morph - Original face actions) predicts the diference in ratings and correlation

```{r}
View(db_of7_new)

unique(db_of7_new$video)
unique(db_of7_new$face_unique)
unique(db_ASC_NT$Actor_ID)
# lets create a common term to merge by

db_of7_new$stim_id<- paste0(db_of7_new$face_unique, paste0(db_of7_new$Dataset),paste0(db_of7_new$morph, paste0(db_of7_new$Emotion)))

unique(db_ASC_NT$Video)
db_ASC_NT$stim_id<- paste0(db_ASC_NT$Actor_ID, paste0(db_ASC_NT$DATASET, paste0(db_ASC_NT$VideoType, paste0(db_ASC_NT$Emotion))))
unique(db_of7_new$stim_id)
unique(db_ASC_NT$stim_id)

identical(as.character(unique(db_of7_new$stim_id)),as.character(unique(db_ASC_NT$stim_id )))

View(db_of7_new)

View(db_of7_new$peak_acc)
View(db_of7_new$peak_speed)

# seems lie d2, d4, d8, d7 don't show string correlations with one another or d1
# faces distances that we need based on Zane et al 2018 (converetd from motion tracker to openface)
# D1 (Face distance) = 27, 7, 8; 
# Eye Distnces: D2 = 21, 22; D3 = 37, 40; D4 = 44, 47; 
# Nose Distances: D5 = 27, 31, 35; D6 = Non  existent; 
# Mouth distances: D7 = 27,50, 52; D8 = 48, 54; D9 = 50, 52, 57


db_of7_new 
  
db_of7_new$Eye_action_AVG<- rowMeans(db_of7_new[, c("D2", "D3", "D4")], na.rm = TRUE)
db_of7_new$Mouth_action_AVG<- rowMeans(db_of7_new[, c("D7", "D8", "D9")], na.rm = TRUE)
db_of7_new$Nose_action_AVG<- rowMeans(db_of7_new[, c("D5")], na.rm = TRUE)
# db_of7_new$D5


db_of_aggregated<- db_of7_new %>%
  group_by(stim_id, morph, Dataset, Emotion,face_unique )%>%
  summarise_at(c('face_action_AVG' ,'Eye_action_AVG', 'Nose_action_AVG', 'Mouth_action_AVG', "speed", 'acceleration', 'peak_speed', 'peak_acc'), mean, na.rm = TRUE)%>%
  ungroup() %>%
  # group_by(morph)%>%
  mutate(face_action_AVG_c= scale(face_action_AVG, center = TRUE, scale = TRUE))%>%
  mutate(Eye_action_AVG_c = scale(Eye_action_AVG, center = TRUE, scale = TRUE))%>%
  mutate(Nose_action_AVG_c= scale(Nose_action_AVG, center = TRUE, scale = TRUE))%>%
  mutate(Mouth_action_AVG_c= scale(Mouth_action_AVG, center = TRUE, scale = TRUE))%>%
  mutate(speed_c = scale(speed, center = TRUE, scale = TRUE))%>%
  mutate(peak_speed_c = scale(peak_speed, center = TRUE, scale = TRUE))%>% 
   mutate(acc_c = scale(acceleration, center = TRUE, scale = TRUE))%>%
   mutate(peak_acc_c = scale(peak_acc, center = TRUE, scale = TRUE))

nrow(db_of_aggregated)
View(db_of_aggregated)
  ggplot(aes(Emotion, face_action_AVG_c, colour = morph))+
  geom_point(pch = 21, position = position_dodge(1))+
  geom_boxplot()+
  facet_grid(~Dataset)
  
 db_of_aggregated$VideoType<- db_of_aggregated$morph 

 db_of_aggregated_merged<- left_join(subset(db_of_aggregated, db_of_aggregated$VideoType == "Morph"),  subset(db_of_aggregated, db_of_aggregated$VideoType != "Morph"), by = c("Emotion", "face_unique", "Dataset"))
  
  View( db_of_aggregated_merged)
  
 db_of_aggregated_merged<-   db_of_aggregated_merged%>%
     # x is morph y  is original
     mutate(Norm_face_action_diff = face_action_AVG_c.x - face_action_AVG_c.y)%>%
     mutate(Norm_eye_action_diff = Eye_action_AVG_c.x - Eye_action_AVG_c.y)%>%
     mutate(Norm_mouth_action_diff = Mouth_action_AVG_c.x - Mouth_action_AVG_c.y)%>%
     mutate(Norm_nose_action_diff = Nose_action_AVG_c.x - Nose_action_AVG_c.y)%>%
    mutate(Norm_speed_diff = speed_c.x -speed_c.y)%>%
    mutate(Norm_peak_speed_diff = peak_speed_c.x -peak_speed_c.y)%>%
   mutate(Norm_acc_diff = acc_c.x -acc_c.y)%>%
    mutate(Norm_peak_acc_diff = peak_acc_c.x -peak_acc_c.y)
   
   
 
  db_of_aggregated_merged$DATASET<-  db_of_aggregated_merged$Dataset
  db_of_aggregated_merged_sel<- dplyr::select(db_of_aggregated_merged, c('stim_id.x', 'Emotion', 'DATASET',
                                                                  'Norm_face_action_diff', 'Norm_eye_action_diff',
                                                                  'Norm_mouth_action_diff', 'Norm_nose_action_diff',
                                                                  'face_unique', 'Norm_speed_diff', 
                                                                  'Norm_peak_speed_diff','Norm_acc_diff',
                                                                  'Norm_peak_acc_diff'))
  
  View(db_of_aggregated_merged_sel)

  
  
  View(db_of_aggregated_merged_sel)
  
  # noe merge with the lmer stuff
  
  
   db_ASC_NT$face_emotion_dataset<- paste0(db_ASC_NT$Actor_ID,paste0(db_ASC_NT$Emotion, paste0(db_ASC_NT$DATASET)))
   



unique(db_ASC_NT$Emotion)
unique(db_of_aggregated_merged_sel$Emotion)


# change jou to happiness
db_of_aggregated_merged_sel$Emotion<- if_else(db_of_aggregated_merged_sel$Emotion =="Joy", "Happiness", as.character(db_of_aggregated_merged_sel$Emotion))

  db_of_aggregated_merged_sel$face_emotion_dataset<- paste0(db_of_aggregated_merged_sel$face_unique,paste0(db_of_aggregated_merged_sel$Emotion,paste0(db_of_aggregated_merged_sel$DATASET)))
  
   
 d1<-  unique(db_of_aggregated_merged_sel$face_emotion_dataset)
 d<-   unique(db_ASC_NT$face_emotion_dataset)
 
 
outersect <- function(x, y) {
  sort(c(setdiff(x, y),
         setdiff(y, x)))
}
intersect(d, d1)
outersect(d, d1)
   
db_ASC_NT_of_df<- left_join(db_ASC_NT,db_of_aggregated_merged_sel, by =c('face_emotion_dataset', "Emotion", "DATASET"))
# View(db_ASC_NT_of_df)  

subset(db_of_aggregated_merged_sel, db_of_aggregated_merged_sel$face_emotion_dataset == 'F02HappinessADFES')
subset(db_ASC_NT, db_ASC_NT$face_emotion_dataset == 'F02HappinessADFES')

# sleect important columns here

db_ASC_NT_of_df1 <- dplyr::select(db_ASC_NT_of_df, c('ParticipantPrivateID', 'VideoType', 'DATASET', 'Emotion',
                                             'Recognacc', 'AnswerRating_Intensity', 'AnswerRating_Valence',
                                             'AnswerRating_Naturality','Norm_face_action_diff',
                                             # Eye_action_diff
                                             'Norm_eye_action_diff', 'Norm_mouth_action_diff',
                                             'Norm_nose_action_diff',
                                             'face_unique','face_emotion_dataset',
                                             'outlier_intensity', 'outlier_valence', 'outlier_naturality', "uniquestimid",
                                             'Norm_speed_diff', 
                                                                  'Norm_peak_speed_diff','Norm_acc_diff',
                                                                  'Norm_peak_acc_diff'))

View(db_ASC_NT_of_df1)

nrow(db_ASC_NT_of_df1)
nrow(db_ASC_NT_of_df2)

# 2926/6384 == 45% of unmatched, this is fine

# whatis<- subset(db_ASC_NT_of_df2, is.na(db_ASC_NT_of_df2$AnswerRating_Intensity.y) == TRUE)
unique(db_ASC_NT_of_df1$Emotion)

unique(db_ASC_NT_of_df1$Emotion)
unique(db_ASC_NT_of_df1$face_emotion_dataset)

db_ASC_NT_of_df2<- left_join(subset(db_ASC_NT_of_df1, db_ASC_NT_of_df1$VideoType == "Morph"), 
          subset(db_ASC_NT_of_df1, db_ASC_NT_of_df1$VideoType == "Original"), 
          by =c('ParticipantPrivateID', "uniquestimid"))


db_ASC_NT_of_df2 %>%
  
  ggplot(aes(Norm_face_action_diff.x))+
  geom_histogram()
unique(db_ASC_NT_of_df2$Norm_face_action_diff.x)
db_ASC_NT_of_df2 %>%
  mutate(Intensity_diff = AnswerRating_Intensity.x-AnswerRating_Intensity.y)%>%
  mutate(Valence_diff = AnswerRating_Valence.x-AnswerRating_Valence.y)%>%
  mutate(Naturality_diff = AnswerRating_Naturality.x-AnswerRating_Naturality.y)%>%
  # ParticipantPrivateID,
  group_by(Emotion, DATASET)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  mutate(EmotionRank = fct_reorder(Emotion, Norm_face_action_diff.x, .fun='length' )) %>%
  # mutate(ppRank = fct_reorder(ParticipantPrivateID, Naturality_diff, .fun='length' ))%>%
  subset(is.na(Intensity_diff) == FALSE)%>%
  # ggplot( aes(x=class, y=hwy, fill=class)) + 
  # ggplot(aes(DATASET, EmotionRank, fill = Naturality_diff)) +
  ggplot(aes(y = EmotionRank, fill = Naturality_diff)) +
  geom_raster()+
  # facet_grid(~DATASET)+
  theme_classic()+
 p$graphstyle+
  # scale_fill_viridis_b()
  # scale_colour_gradient2( low = 'red', mid = "white", high = "blue",midpoint = 0)
  scale_fill_viridis_c(option = "Plasma")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



db_ASC_NT_of_df2<- db_ASC_NT_of_df2 %>%
  mutate(Intensity_diff = AnswerRating_Intensity.x-AnswerRating_Intensity.y)%>%
  mutate(Valence_diff = AnswerRating_Valence.x-AnswerRating_Valence.y)%>%
  mutate(Naturality_diff = AnswerRating_Naturality.x-AnswerRating_Naturality.y)%>%
  mutate(Intensity_diff_z= scale(Intensity_diff, center = TRUE, scale = TRUE))%>%
  mutate(Valence_diff_z= scale(Valence_diff, center = TRUE, scale = TRUE))%>%
  mutate(Naturality_diff_z= scale(Naturality_diff, center = TRUE, scale = TRUE))
  
# does the difference in mrphong rpedict difference in ratings
View(db_ASC_NT_of_df2 )

# tryong to center int dif and others create problems for correlation

db_ASC_NT_of_df2$face_ac %>%
  group_by(DATASET)%>%
  mutate(Norm_face_action_diff.x = scale(face_ac))

db_ASC_NT_of_df2<- db_ASC_NT_of_df2 %>%
  group_by(ParticipantPrivateID, DATASET.x)%>%
  mutate(cor_int_diff_morph_diff= cor(Intensity_diff, Norm_face_action_diff.x, use = 'complete.obs'))%>%
  mutate(cor_int_diff_morph_diff_speed= cor(Intensity_diff, Norm_speed_diff.x, use = 'complete.obs'))%>%
  mutate(cor_int_diff_morph_diff_speed_abs= cor(abs(Intensity_diff), abs(Norm_speed_diff.x), use = 'complete.obs'))%>%
   mutate(cor_int_diff_morph_diff_peak_speed= cor(Intensity_diff, Norm_peak_speed_diff.x, use = 'complete.obs'))

db_ASC_NT_of_df2%>%


 ggplot(aes(fisherz(cor_int_diff_morph_diff_peak_speed), fill = 'red'))+
  geom_density(alpha = .5)+
  geom_density(aes(fill = DATASET.x), alpha = .2)+
  scale_color_brewer(palette = 'Dark2')
    # geom_vline(aes(xintercept =  Mean_Int))+
    # geom_vline(aes(xintercept = Mean_Int_byDATASET))
  


   mutate(cor_val_diff_morph_diff= cor(Valence_diff, Norm_face_action_diff.x, use = 'complete.obs'))%>%
   mutate(cor_nat_diff_morph_diff= cor(Naturality_diff, Norm_face_action_diff.x, use = 'complete.obs'))%>%
  mutate(cor_int_diff_morph_diff_abs= cor(abs(Intensity_diff), abs(Norm_face_action_diff.x), use = 'complete.obs'))%>%
   mutate(cor_val_diff_morph_diff_abs= cor(abs(Valence_diff), abs(Norm_face_action_diff.x), use = 'complete.obs'))%>%
   mutate(cor_nat_diff_morph_diff_abs= cor(abs(Naturality_diff), abs(Norm_face_action_diff.x), use = 'complete.obs'))%>%
   mutate(cor_nat_diff_morph_diff_abs= cor(abs(Naturality_diff), abs(Norm_face_action_diff.x), use = 'complete.obs'))%>%
  # eyes
      mutate(cor_int_diff_morph_diff_eyes= cor(Intensity_diff, Norm_eye_action_diff.x, use = 'complete.obs'))%>%
   mutate(cor_val_diff_morph_diff_eyes= cor(Valence_diff, Norm_eye_action_diff.x, use = 'complete.obs'))%>%
   mutate(cor_nat_diff_morph_diff_eyes= cor(Naturality_diff, Norm_eye_action_diff.x, use = 'complete.obs'))%>%
  mutate(cor_int_diff_morph_diff_abs_eyes= cor(abs(Intensity_diff), abs(Norm_eye_action_diff.x), use = 'complete.obs'))%>%
   mutate(cor_val_diff_morph_diff_abs_eyes= cor(abs(Valence_diff), abs(Norm_eye_action_diff.x), use = 'complete.obs'))%>%
   mutate(cor_nat_diff_morph_diff_abs_eyes= cor(abs(Naturality_diff), abs(Norm_eye_action_diff.x), use = 'complete.obs'))%>%
   mutate(cor_nat_diff_morph_diff_abs_eyes= cor(abs(Naturality_diff), abs(Norm_eye_action_diff.x), use = 'complete.obs'))%>%
  
  # Mouth
  # mouths
      mutate(cor_int_diff_morph_diff_mouth= cor(Intensity_diff, Norm_mouth_action_diff.x, use = 'complete.obs'))%>%
   mutate(cor_val_diff_morph_diff_mouth= cor(Valence_diff, Norm_mouth_action_diff.x, use = 'complete.obs'))%>%
   mutate(cor_nat_diff_morph_diff_mouth= cor(Naturality_diff, Norm_mouth_action_diff.x, use = 'complete.obs'))%>%
  mutate(cor_int_diff_morph_diff_abs_mouth= cor(abs(Intensity_diff), abs(Norm_mouth_action_diff.x), use = 'complete.obs'))%>%
   # mutate(cor_val_diff_morph_diff_abs_mouth= cor(abs(Valence_diff_z), abs(Norm_mouth_action_diff.x), use = 'complete.obs'))%>%
   # mutate(cor_nat_diff_morph_diff_abs_mouth= cor(abs(Naturality_diff_z), abs(Norm_mouth_action_diff.x), use = 'complete.obs'))%>%
   mutate(cor_nat_diff_morph_diff_abs_mouth= cor(abs(Naturality_diff), abs(Norm_mouth_action_diff.x), use = 'complete.obs'))

library(psych)

db_ASC_NT_of_df2<- left_join(db_ASC_NT_of_df2, group)
group
group<- group%>%
  group_by(ParticipantPrivateID, Group)%>%
  summarise(n = n())


db_ASC_NT_of_df2agg<- db_ASC_NT_of_df2 %>%
  group_by(ParticipantPrivateID, Group, DATASET.x)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  mutate(cor_int_diff_morph_diff_fz = fisherz(cor_int_diff_morph_diff))%>%
   mutate(cor_int_diff_morph_diff_speed_fz = fisherz(cor_int_diff_morph_diff_speed))%>%
    mutate(cor_int_diff_morph_diff_peak_speed_fz = fisherz(cor_int_diff_morph_diff_peak_speed))%>%
    mutate(cor_int_diff_morph_diff_speed_abs = fisherz(cor_int_diff_morph_diff_speed_abs))
  
  mutate(cor_val_diff_morph_diff_fz = fisherz(cor_val_diff_morph_diff))%>%
  mutate(cor_nat_diff_morph_diff_fz = fisherz(cor_nat_diff_morph_diff))%>%
  mutate(cor_int_diff_morph_diff_abs_fz = fisherz(cor_int_diff_morph_diff_abs))%>%
  mutate(cor_val_diff_morph_diff_abs_fz = fisherz(cor_val_diff_morph_diff_abs))%>%
  mutate(cor_nat_diff_morph_diff_abs_fz = fisherz(cor_nat_diff_morph_diff_abs))%>%
  # eyes
  mutate(cor_int_diff_morph_diff_fz_eyes = fisherz(cor_int_diff_morph_diff_eyes))%>%
  mutate(cor_val_diff_morph_diff_fz_eyes = fisherz(cor_val_diff_morph_diff_eyes))%>%
  mutate(cor_nat_diff_morph_diff_fz_eyes = fisherz(cor_nat_diff_morph_diff_eyes))%>%
  mutate(cor_int_diff_morph_diff_abs_fz_eyes = fisherz(cor_int_diff_morph_diff_abs_eyes))%>%
  mutate(cor_val_diff_morph_diff_abs_fz_eyes = fisherz(cor_val_diff_morph_diff_abs_eyes))%>%
  mutate(cor_nat_diff_morph_diff_abs_fz_eyes = fisherz(cor_nat_diff_morph_diff_abs_eyes))%>%
  
  # mouth
    mutate(cor_int_diff_morph_diff_fz_mouth = fisherz(cor_int_diff_morph_diff_mouth))%>%
  mutate(cor_val_diff_morph_diff_fz_mouth = fisherz(cor_val_diff_morph_diff_mouth))%>%
  mutate(cor_nat_diff_morph_diff_fz_mouth = fisherz(cor_nat_diff_morph_diff_mouth))%>%
  mutate(cor_int_diff_morph_diff_abs_fz_mouth = fisherz(cor_int_diff_morph_diff_abs_mouth))%>%
  mutate(cor_val_diff_morph_diff_abs_fz_mouth = fisherz(cor_val_diff_morph_diff_abs_mouth))%>%
  mutate(cor_nat_diff_morph_diff_abs_fz_mouth = fisherz(cor_nat_diff_morph_diff_abs_mouth))



group<- select(db_ASC_NT, c("ParticipantPrivateID", "Group"))




db_ASC_NT_of_df2agg_bypp<- db_ASC_NT_of_df2agg %>%
  group_by(ParticipantPrivateID, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
  # mutate(cor_int_diff_morph_diff_fz = fisherz(cor_int_diff_morph_diff))%>%
  # mutate(cor_val_diff_morph_diff_fz = fisherz(cor_val_diff_morph_diff))%>%
  # mutate(cor_nat_diff_morph_diff_fz = fisherz(cor_nat_diff_morph_diff))%>%
  # mutate(cor_int_diff_morph_diff_abs_fz = fisherz(cor_int_diff_morph_diff_abs))%>%
  # mutate(cor_val_diff_morph_diff_abs_fz = fisherz(cor_val_diff_morph_diff_abs))%>%
  # mutate(cor_nat_diff_morph_diff_abs_fz = fisherz(cor_nat_diff_morph_diff_abs))

db_NTonly_of_df2agg_bypp<- subset(db_ASC_NT_of_df2agg_bypp, db_ASC_NT_of_df2agg_bypp$Group == "NT")

db_NTonly_of_df2agg_byppds<- subset(db_ASC_NT_of_df2agg, db_ASC_NT_of_df2agg$Group == "NT")

t.test(db_NTonly_of_df2agg_bypp$cor_int_diff_morph_diff_speed_fz, mu = 0, paired = FALSE)
t.test(db_NTonly_of_df2agg_bypp$cor_int_diff_morph_diff_speed_abs, mu = 0, paired = FALSE)


db_NTonly_of_df2agg_byppds %>%
  ggplot(aes(cor_int_diff_morph_diff_speed_abs))+
  geom_histogram()+
  facet_grid(~DATASET.x)


```


# eyes
 
t.test(fisherz2r(db_NTonly_of_df2agg_bypp$cor_int_diff_morph_diff_eyes), mu = 0, paired = FALSE)
t.test(fisherz2r(db_NTonly_of_df2agg_bypp$cor_int_diff_morph_diff_abs_eyes), mu = 0, paired = FALSE)

# mouth
t.test(fisherz2r(db_NTonly_of_df2agg_bypp$cor_int_diff_morph_diff_mouth), mu = 0, paired = FALSE)
t.test(fisherz2r(db_NTonly_of_df2agg_bypp$cor_int_diff_morph_diff_abs_eyes), mu = 0, paired = FALSE)

t.test(db_NTonly_of_df2agg_bypp$cor_int_diff_morph_diff_abs_fz, mu = 0, paired = FALSE)
  
 
t.test(db_NTonly_of_df2agg_bypp$cor_val_diff_morph_diff_fz, mu = 0, paired = FALSE)
t.test(db_NTonly_of_df2agg_bypp$cor_val_diff_morph_diff_abs_fz, mu = 0, paired = FALSE)

# eyes
t.test(fisherz2r(db_NTonly_of_df2agg_bypp$cor_val_diff_morph_diff_eyes), mu = 0, paired = FALSE)

t.test(fisherz2r(db_NTonly_of_df2agg_bypp$cor_val_diff_morph_diff_abs_eyes), mu = 0, paired = FALSE)

# mouth
t.test(fisherz2r(db_NTonly_of_df2agg_bypp$cor_val_diff_morph_diff_mouth), mu = 0, paired = FALSE)

t.test(fisherz2r(db_NTonly_of_df2agg_bypp$cor_val_diff_morph_diff_abs_mouth), mu = 0, paired = FALSE)
 
t.test(db_NTonly_of_df2agg_bypp$cor_nat_diff_morph_diff_fz, mu = 0, paired = FALSE)
t.test(db_NTonly_of_df2agg_bypp$cor_nat_diff_morph_diff_abs_fz, mu = 0, paired = FALSE)

# eyes

t.test(fisherz2r(db_NTonly_of_df2agg_bypp$cor_nat_diff_morph_diff_eyes), mu = 0, paired = FALSE)

t.test(fisherz2r(db_NTonly_of_df2agg_bypp$cor_nat_diff_morph_diff_abs_eyes), mu = 0, paired = FALSE)

# mouth

t.test(fisherz2r(db_NTonly_of_df2agg_bypp$cor_nat_diff_morph_diff_mouth), mu = 0, paired = FALSE)

t.test(fisherz2r(db_NTonly_of_df2agg_bypp$cor_nat_diff_morph_diff_abs_mouth), mu = 0, paired = FALSE)


 
# compare between datasets
library(afex)
aov_ez(id = 'ParticipantPrivateID',
       data = db_NTonly_of_df2agg_byppds,
       dv = 'cor_int_diff_morph_diff_speed_abs_fz',
       within = 'DATASET.x')

aov_ez(id = 'ParticipantPrivateID',
       data = db_NTonly_of_df2agg_byppds,
       dv = 'cor_int_diff_morph_diff_abs_fz',
       within = 'DATASET.x')

aov_ez(id = 'ParticipantPrivateID',
       data = db_NTonly_of_df2agg_byppds,
       dv = 'cor_val_diff_morph_diff_fz',
       within = 'DATASET.x')

aov_ez(id = 'ParticipantPrivateID',
       data = db_NTonly_of_df2agg_byppds,
       dv = 'cor_val_diff_morph_diff_abs_fz',
       within = 'DATASET.x')

aov_ez(id = 'ParticipantPrivateID',
       data = db_NTonly_of_df2agg_byppds,
       dv = 'cor_nat_diff_morph_diff_fz',
       within = 'DATASET.x')

aov_ez(id = 'ParticipantPrivateID',
       data = db_NTonly_of_df2agg_byppds,
       dv = 'cor_nat_diff_morph_diff_abs_fz',
       within = 'DATASET.x')


db_NTonly_of_df2agg_byppds %>%
  ggplot(aes(DATASET.x,cor_val_diff_morph_diff))+
  # geom_boxplot()+
  geom_violin()+
  geom_line(aes(group = ParticipantPrivateID))+
   geom_dotplot(binaxis='y', stackdir='center', dotsize=1)
  geom_dotplot()
  geom_jitter(width = .2)

# very small effcets, nothing supr crazy
# what about t tests, if we run a single t test on particioants differnce scores, we will have one estimate per participants, we caan do the sme thing for stimyli, nd then correlate the betas?
  
  # i don't think this makes sense ecause the stimuli will always have the same value, the me beta



 
#    group_by(DATASET.x)%>%
#   mutate(Mean_Int_byDATASET = mean(cor_int_diff_morph_diff, na.rm =TRUE))%>%
# ungroup()%>%
#   mutate(Mean_Int= mean(cor_int_diff_morph_diff, na.rm =TRUE))%>%
#   group_by(ParticipantPrivateID, DATASET.x)%>%
#   summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(cor_nat_diff_morph_diff, fill = 'red'))+
  geom_density(alpha = .5)+
  geom_density(aes(fill = DATASET.x), alpha = .2)+
  scale_color_brewer(palette = 'Dark2')
    # geom_vline(aes(xintercept =  Mean_Int))+
    # geom_vline(aes(xintercept = Mean_Int_byDATASET))
  
  
db_ASC_NT_of_df2 %>%
  group_by(ParticipantPrivateID, DATASET.x)%>%
  mutate(t_test_pp_intdif = t.test(Intensity_diff, mu = 0, paired = FALSE)$estimate)%>%
   mutate(t_test_video_face_diff = t.test(Norm_face_action_diff.x, mu = 0, paired = FALSE)$estimate)%>%
    

```
%>%
  group_by(stim_id)%>%
  
